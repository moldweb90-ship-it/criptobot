<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Crypto Price Tracker</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    .container {
      width: 100%;
      margin: 0 auto;
      margin-top: 15px;
      padding: 20px;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      margin: 0;
      overflow-x: hidden;
    }

    /* Бургерное меню */
    .burger-button {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      width: 40px;
      height: 40px;
      background: none;
      border: none;
      cursor: pointer;
      padding: 5px;
      transition: all 0.3s ease;
    }

    .burger-line {
      width: 24px;
      height: 3px;
      background: #2d3748;
      margin: 2px 0;
      transition: all 0.3s ease;
      border-radius: 2px;
    }

    .burger-button:hover .burger-line {
      background: #4299e1;
    }

    .burger-button.active .burger-line:nth-child(1) {
      transform: rotate(45deg) translate(5px, 5px);
    }

    .burger-button.active .burger-line:nth-child(2) {
      opacity: 0;
    }

    .burger-button.active .burger-line:nth-child(3) {
      transform: rotate(-45deg) translate(7px, -6px);
    }

    .burger-menu-content {
      position: absolute;
      top: calc(100% + 10px);
      left: 0;
      background: rgba(255, 255, 255, 0.98);
      backdrop-filter: blur(20px);
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      min-width: 280px;
      max-width: 320px;
      opacity: 0;
      visibility: hidden;
      transform: translateY(-10px);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      overflow: hidden;
      z-index: 2000;
    }

    .burger-menu-content.active {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }

    .burger-menu-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      text-align: center;
    }

    .burger-menu-title {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 5px;
    }

    .burger-menu-subtitle {
      font-size: 12px;
      opacity: 0.9;
    }

    .burger-menu-items {
      padding: 10px 0;
    }

    .burger-menu-item {
      display: flex;
      align-items: center;
      padding: 15px 20px;
      color: #2d3748;
      text-decoration: none;
      transition: all 0.3s ease;
      border-left: 4px solid transparent;
    }

    .burger-menu-item:hover {
      background: #f7fafc;
      border-left-color: #4299e1;
      color: #4299e1;
    }

    .burger-menu-item.active {
      background: #e6fffa;
      border-left-color: #38a169;
      color: #38a169;
    }

    .burger-menu-icon {
      font-size: 20px;
      margin-right: 12px;
      width: 24px;
      text-align: center;
    }

    .burger-menu-text {
      font-weight: 600;
      font-size: 14px;
    }

    .burger-menu-desc {
      font-size: 11px;
      color: #718096;
      margin-top: 2px;
    }

    .burger-menu-divider {
      height: 1px;
      background: #e2e8f0;
      margin: 10px 20px;
    }

    .crypto-grid {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 15px;
      margin: 30px auto 0;
    }

    .crypto-card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      padding: 15px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      transition: transform 0.3s ease;
      min-height: 220px;
    }

    .crypto-card:hover {
      transform: translateY(-5px);
    }

    .header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 12px;
    }

    .icon {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: bold;
      color: white;
    }

    .icon.btc { background: linear-gradient(135deg, #f7931a 0%, #ffa726 100%); }
    .icon.eth { background: linear-gradient(135deg, #627eea 0%, #8c9eff 100%); }
    .icon.sol { background: linear-gradient(135deg, #9945ff 0%, #14f195 100%); }
    .icon.xrp { background: linear-gradient(135deg, #23292f 0%, #4a90e2 100%); }
    .icon.bnb { background: linear-gradient(135deg, #f3ba2f 0%, #f7d794 100%); }
    .icon.doge { background: linear-gradient(135deg, #c2a633 0%, #d4c17d 100%); }

    .title {
      font-size: 14px;
      font-weight: 700;
      color: #2d3748;
    }

    .subtitle {
      font-size: 10px;
      color: #718096;
      margin-top: 2px;
    }

    .price-display {
      text-align: center;
      margin: 15px 0;
    }

    .price {
      font-size: 20px;
      font-weight: 800;
      color: #2d3748;
      margin-bottom: 4px;
      transition: all 0.3s ease;
    }

    .price.flash-green {
      animation: flashGreen 0.5s;
    }

    .price.flash-red {
      animation: flashRed 0.5s;
    }

    @keyframes flashGreen {
      0%, 100% { color: #2d3748; }
      50% { color: #48bb78; transform: scale(1.05); }
    }

    @keyframes flashRed {
      0%, 100% { color: #2d3748; }
      50% { color: #f56565; transform: scale(1.05); }
    }

    .change {
      font-size: 16px;
      font-weight: 600;
      padding: 6px 12px;
      border-radius: 12px;
      display: inline-block;
    }

    .change.positive {
      background: #c6f6d5;
      color: #22543d;
    }

    .change.negative {
      background: #fed7d7;
      color: #742a2a;
    }

    .spread {
      font-size: 16px;
      font-weight: 600;
      margin-top: 10px;
      padding: 8px 16px;
      border-radius: 12px;
      background: #e2e8f0;
      color: #4a5568;
    }

    .stats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 6px;
      margin-top: 12px;
    }

    .stats .stat-item:nth-child(5),
    .stats .stat-item:nth-child(6) {
      grid-column: 1 / -1;
      font-size: 10px;
    }

    .stat-item {
      background: #f7fafc;
      padding: 10px;
      border-radius: 8px;
    }

    .stat-label {
      font-size: 10px;
      color: #718096;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 3px;
    }

    .stat-value {
      font-size: 14px;
      font-weight: 600;
      color: #2d3748;
    }

    .status {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      margin-top: 20px;
      font-size: 14px;
      color: #718096;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #48bb78;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .loading {
      text-align: center;
      color: #718096;
    }

    /* Стили для секции аналитики */
    .analytics-section {
      margin-top: 40px;
      padding: 0 20px;
    }

    .analytics-title {
      text-align: center;
      font-size: 24px;
      font-weight: 700;
      color: #2d3748;
      margin-bottom: 30px;
    }

    .analytics-grid {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 15px;
      margin: 0 auto;
    }

    .analytics-card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      transition: transform 0.3s ease;
    }

    .analytics-card:hover {
      transform: translateY(-3px);
    }

    .analytics-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid #e2e8f0;
    }

    .analytics-icon {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: bold;
      color: white;
    }

    .analytics-name {
      font-size: 14px;
      font-weight: 600;
      color: #2d3748;
    }

    .indicator {
      margin-bottom: 12px;
      padding: 8px;
      background: #f7fafc;
      border-radius: 8px;
    }

    .indicator-label {
      font-size: 11px;
      color: #718096;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 3px;
    }

    .indicator-value {
      font-size: 13px;
      font-weight: 600;
      color: #2d3748;
    }

    .indicator-value.positive {
      color: #48bb78;
    }

    .indicator-value.negative {
      color: #f56565;
    }

    .indicator-value.neutral {
      color: #718096;
    }

    .macd-values {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 5px;
      margin-top: 5px;
    }

    .macd-item {
      font-size: 10px;
      padding: 3px;
      background: #edf2f7;
      border-radius: 4px;
      text-align: center;
    }

    /* Секция аналитики */
    .analytics-section {
      margin-top: 40px;
      padding: 20px;
      background: #f8fafc;
      border-radius: 16px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
      width: 100%;
      clear: both;
    }

    .analytics-title {
      font-size: 24px;
      font-weight: 700;
      color: #2d3748;
      text-align: center;
      margin-bottom: 30px;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .analytics-grid {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 15px;
      margin-bottom: 20px;
    }

    /* Секция фильтров */
    .filters-section {
      margin-top: 40px;
      margin-bottom: 40px;
      padding: 20px;
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
      border-radius: 16px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
      width: 100%;
      clear: both;
    }

    .filters-title {
      font-size: 24px;
      font-weight: 700;
      color: #2d3748;
      text-align: center;
      margin-bottom: 30px;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .filters-grid {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 20px;
      max-width: 1800px;
      margin: 0 auto;
    }

    .filter-card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      border: 2px solid #e2e8f0;
      transition: all 0.3s ease;
      display: flex;
      gap: 15px;
    }

    .filter-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      border-color: #667eea;
    }

    .filter-icon {
      font-size: 32px;
      flex-shrink: 0;
    }

    .filter-info {
      flex: 1;
    }

    .filter-name {
      font-size: 16px;
      font-weight: 700;
      color: #2d3748;
      margin-bottom: 10px;
    }

    .filter-desc {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .filter-rule {
      font-size: 13px;
      color: #4a5568;
      line-height: 1.5;
    }

    /* Адаптивность для фильтров */
    @media (max-width: 1400px) {
      .filters-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 768px) {
      .filters-grid {
        grid-template-columns: 1fr;
      }
    }

    /* Принудительно 6 колонок для всех экранов */
    @media (max-width: 1200px) {
      .crypto-grid {
        grid-template-columns: repeat(6, 1fr);
        gap: 10px;
      }
      .analytics-grid {
        grid-template-columns: repeat(6, 1fr);
        gap: 10px;
      }
    }

    .analytics-card {
      background: white;
      border-radius: 10px;
      padding: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      border: 1px solid #e2e8f0;
      transition: all 0.3s ease;
    }

    .analytics-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
    }

    .analytics-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid #f1f5f9;
    }

    .analytics-icon {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: 700;
      color: white;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
    }

    .analytics-icon.btc { background: linear-gradient(135deg, #f7931a 0%, #ffa726 100%); }
    .analytics-icon.eth { background: linear-gradient(135deg, #627eea 0%, #8c9eff 100%); }
    .analytics-icon.sol { background: linear-gradient(135deg, #9945ff 0%, #14f195 100%); }
    .analytics-icon.xrp { background: linear-gradient(135deg, #23292f 0%, #4a90e2 100%); }
    .analytics-icon.bnb { background: linear-gradient(135deg, #f3ba2f 0%, #f7d794 100%); }
    .analytics-icon.doge { background: linear-gradient(135deg, #c2a633 0%, #d4c17d 100%); }

    .analytics-name {
      font-size: 14px;
      font-weight: 600;
      color: #2d3748;
    }

    .trend-indicators {
      margin-left: auto;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .trend-line {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .trend-label {
      font-size: 10px;
      font-weight: 700;
      color: #718096;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .trend-percentage {
      font-size: 12px;
      font-weight: 700;
      padding: 2px 6px;
      border-radius: 4px;
      background: #e2e8f0;
      color: #4a5568;
      transition: all 0.3s ease;
    }

    .trend-percentage.long-active {
      background: #48bb78;
      color: white;
    }

    .trend-percentage.short-active {
      background: #f56565;
      color: white;
    }

    .indicator-label-container {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      transition: all 0.3s ease;
      flex-shrink: 0;
    }

    .dot.green {
      background: #48bb78;
    }

    .dot.red {
      background: #f56565;
    }

    .dot.neutral {
      background: #e2e8f0;
    }

    .dot.yellow {
      background: #f6e05e;
    }

    .dot.blue {
      background: #4299e1;
    }

    .dot.orange {
      background: #ed8936;
    }

    .dot.red {
      background: #f56565;
    }

    .dot.maroon {
      background: #c53030;
    }

    .dot.volatile {
      background: #e53e3e;
      color: white;
      font-size: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      width: 16px;
      height: 16px;
      border: 2px solid #c53030;
    }

    .dot.caution {
      background: #f6e05e;
    }

    .dot.anomaly {
      background: #e53e3e;
      color: white;
      font-size: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      width: 16px;
      height: 16px;
      border: 2px solid #c53030;
    }

    .indicator-value-container {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .trend-indicator {
      font-size: 14px;
      font-weight: bold;
      width: 16px;
      height: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: all 0.3s ease;
    }

    .trend-indicator.positive {
      background: #48bb78;
      color: white;
    }

    .trend-indicator.positive::after {
      content: '✓';
    }

    .trend-indicator.negative {
      background: #f56565;
      color: white;
    }

    .trend-indicator.negative::after {
      content: '↓';
    }

    .trend-indicator.neutral {
      background: #e2e8f0;
      color: #718096;
    }

    .trend-indicator.neutral::after {
      content: '--';
      font-size: 10px;
    }

    .indicator {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      padding: 6px 10px;
      background: #f8fafc;
      border-radius: 6px;
      border-left: 3px solid #e2e8f0;
      transition: all 0.2s ease;
    }

    .indicator:hover {
      background: #f1f5f9;
      border-left-color: #4299e1;
    }

    .indicator.liquidity {
      min-width: 200px;
      flex-wrap: wrap;
    }
    
    .indicator.liquidity .indicator-value {
      font-size: 11px;
      min-width: 120px;
      text-align: right;
    }

    .indicator-label {
      font-size: 11px;
      font-weight: 500;
      color: #718096;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .indicator-value {
      font-size: 12px;
      font-weight: 600;
      padding: 3px 6px;
      border-radius: 4px;
      transition: all 0.2s ease;
    }

    .indicator-value.positive {
      color: #38a169;
      background: #f0fff4;
      border: 1px solid #c6f6d5;
    }

    .indicator-value.negative {
      color: #e53e3e;
      background: #fff5f5;
      border: 1px solid #fed7d7;
    }

    .indicator-value.neutral {
      color: #718096;
      background: #f7fafc;
      border: 1px solid #e2e8f0;
    }



    /* Секция сделок */
    .deals-section {
      margin-bottom: 40px;
      display: flex;
      gap: 20px;
      width: 100%;
    }

    /* Открытые сделки (слева) */
    .open-deals-container {
      flex: 1;
      width: 50%;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    .open-deals-title {
      font-size: 24px;
      font-weight: 700;
      color: #2d3748;
      margin-bottom: 25px;
      text-align: center;
    }

    .open-deals-content {
      min-height: 200px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      color: #a0aec0;
      font-size: 14px;
    }
    
    .open-deals-content:empty::before,
    .open-deals-content .empty-state {
      text-align: center;
      padding: 40px;
    }
    
    .open-deal-card {
      background: white;
      border-radius: 8px;
      padding: 12px 16px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      border: 1px solid #e2e8f0;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: space-between;
      min-height: 60px;
    }
    
    .open-deal-card:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    
    .deal-left {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      min-width: 120px;
    }
    
    .deal-center {
      display: flex;
      flex-direction: column;
      gap: 4px;
      min-width: 140px;
    }
    
    .deal-pnl {
      display: flex;
      flex-direction: column;
      align-items: center;
      min-width: 80px;
      padding: 8px 12px;
      border-radius: 6px;
      background: #f7fafc;
    }
    
    .deal-pnl.profit {
      background: #c6f6d5;
      color: #22543d;
    }
    
    .deal-pnl.loss {
      background: #fed7d7;
      color: #742a2a;
    }
    
    .deal-targets {
      display: flex;
      flex-direction: column;
      gap: 4px;
      min-width: 100px;
    }
    
    .deal-right {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      min-width: 80px;
    }
    
    .deal-symbol {
      font-weight: 700;
      font-size: 14px;
      color: #2d3748;
    }
    
    .deal-action {
      font-size: 12px;
      font-weight: 600;
      padding: 2px 6px;
      border-radius: 4px;
      margin-top: 2px;
    }
    
    .deal-action.long {
      background: #c6f6d5;
      color: #22543d;
    }
    
    .deal-action.short {
      background: #fed7d7;
      color: #742a2a;
    }
    
    .price-row {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
    }
    
    .price-label {
      color: #718096;
      font-weight: 500;
    }
    
    .price-value {
      color: #2d3748;
      font-weight: 700;
    }
    
    .pnl-main {
      font-size: 16px;
      font-weight: 800;
    }
    
    .pnl-percent {
      font-size: 11px;
      font-weight: 600;
    }
    
    .target-row {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 11px;
    }
    
    .target-label {
      font-size: 12px;
    }
    
    .target-value {
      font-weight: 700;
      color: #2d3748;
    }
    
    .target-row.tp .target-value {
      color: #38a169;
    }
    
    .target-row.sl .target-value {
      color: #e53e3e;
    }
    
    .deal-volume {
      font-weight: 600;
      color: #2d3748;
      font-size: 12px;
    }
    
    .deal-time {
      font-weight: 500;
      color: #718096;
      font-size: 11px;
    }
    
    .pnl-info {
      margin: 15px 0;
      padding: 15px;
      border-radius: 10px;
      background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
    }
    
    .pnl-info.profit {
      background: linear-gradient(135deg, #c6f6d5 0%, #9ae6b4 100%);
      border: 2px solid #48bb78;
    }
    
    .pnl-info.loss {
      background: linear-gradient(135deg, #fed7d7 0%, #fc8181 100%);
      border: 2px solid #f56565;
    }
    
    .pnl-main {
      font-size: 20px;
      font-weight: 800;
      text-align: center;
      margin-bottom: 10px;
    }
    
    .pnl-info.profit .pnl-main {
      color: #22543d;
    }
    
    .pnl-info.loss .pnl-main {
      color: #742a2a;
    }
    
    .pnl-breakdown {
      display: flex;
      justify-content: space-around;
      font-size: 12px;
      padding-top: 10px;
      border-top: 1px solid rgba(0, 0, 0, 0.1);
    }
    
    .pnl-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
    }
    
    .pnl-item span:first-child {
      color: #718096;
      font-weight: 500;
    }
    
    .pnl-item span:last-child {
      font-weight: 700;
      color: #2d3748;
    }
    
    .targets-info {
      margin: 15px 0;
    }
    
    .target-row {
      margin: 12px 0;
    }
    
    .target-row {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 13px;
    }
    
    .target-label {
      font-weight: 600;
      min-width: 40px;
    }
    
    .target-value {
      flex: 1;
      font-weight: 700;
      color: #2d3748;
    }
    
    .target-row.tp .target-label,
    .target-row.tp .target-value {
      color: #38a169;
    }
    
    .target-row.sl .target-label,
    .target-row.sl .target-value {
      color: #e53e3e;
    }
    
    .target-progress {
      width: 100%;
      height: 6px;
      background: #e2e8f0;
      border-radius: 3px;
      overflow: hidden;
      margin-top: 6px;
    }
    
    .target-progress-bar {
      height: 100%;
      transition: width 0.3s ease;
    }
    
    .target-progress-bar.tp {
      background: linear-gradient(90deg, #48bb78 0%, #38a169 100%);
    }
    
    .target-progress-bar.sl {
      background: linear-gradient(90deg, #fc8181 0%, #f56565 100%);
    }
    
    .deal-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid #e2e8f0;
      font-size: 12px;
      color: #718096;
    }
    
    .deal-volume {
      font-weight: 600;
      color: #2d3748;
    }
    
    .deal-time {
      font-weight: 500;
    }

    /* Подготовка сделки (справа) */
    .deal-prep-container {
      flex: 1;
      width: 50%;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    .deal-prep-title {
      font-size: 24px;
      font-weight: 700;
      color: #2d3748;
      margin-bottom: 25px;
      text-align: center;
    }

    .deal-prep-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
    }

    .deal-card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      border: 1px solid #e2e8f0;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .deal-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
    }

    .deal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 15px;
    }

    .deal-symbol {
      font-size: 18px;
      font-weight: 600;
      color: #2d3748;
    }

    .deal-match-count {
      font-size: 16px;
      font-weight: 600;
      padding: 4px 8px;
      background: rgba(0, 0, 0, 0.05);
      border-radius: 6px;
    }

    .deal-action-row {
      display: flex;
      justify-content: center;
      margin-bottom: 15px;
    }

    .deal-action {
      padding: 6px 12px;
      border-radius: 15px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .deal-action.buy {
      background: #48bb78;
      color: white;
    }

    .deal-action.sell {
      background: #f56565;
      color: white;
    }

    .deal-timer {
      border-radius: 8px;
      padding: 8px 12px;
      margin-bottom: 15px;
      text-align: center;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .deal-timer.fast-timer {
      background: #48bb78;
    }
    
    .deal-timer.standard-timer {
      background: #667eea;
    }

    .timer-value {
      font-size: 16px;
      font-weight: 700;
      color: white;
      font-family: 'Courier New', monospace;
    }

    .deal-confidence {
      margin-bottom: 15px;
      display: flex;
      gap: 10px;
    }

    .confidence-left {
      flex: 1;
    }

    .confidence-label {
      font-size: 12px;
      color: #718096;
      margin-bottom: 8px;
    }

    .confidence-bar {
      width: 100%;
      height: 12px;
      background: #e2e8f0;
      border-radius: 6px;
      overflow: hidden;
    }

    .confidence-percent {
      font-size: 18px;
      font-weight: 800;
      color: #2d3748;
      white-space: nowrap;
      display: flex;
      align-items: center;
      justify-content: center;
      min-width: 50px;
    }

    .confidence-fill {
      height: 100%;
      border-radius: 6px;
      transition: width 0.3s ease;
    }
    
    .confidence-fill.high {
      background: linear-gradient(90deg, #48bb78, #68d391);
    }
    
    .confidence-fill.medium {
      background: linear-gradient(90deg, #f6ad55, #ed8936);
    }
    
    .confidence-fill.low {
      background: linear-gradient(90deg, #f56565, #e53e3e);
    }

    .confidence-percent {
      font-size: 18px;
      font-weight: 800;
      color: #2d3748;
      white-space: nowrap;
    }

    .deal-metrics {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .metric {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid #f7fafc;
    }

    .metric:last-child {
      border-bottom: none;
    }

    .metric-label {
      font-size: 12px;
      color: #718096;
    }

    .metric-value {
      font-size: 12px;
      font-weight: 600;
      color: #2d3748;
    }

    .metric-value.positive {
      color: #48bb78;
    }

    .metric-value.negative {
      color: #f56565;
    }

    .metric-value.neutral {
      color: #a0aec0;
    }

    .market-title {
      text-align: center;
      color: white;
      font-size: 24px;
      margin-bottom: 20px;
      text-shadow: 0 2px 10px rgba(0,0,0,0.3);
      letter-spacing: 1px;
    }

    .analytics-title {
      text-align: center;
      color: #2d3748;
      font-size: 24px;
      margin-bottom: 20px;
      text-shadow: none;
      letter-spacing: 1px;
    }

    .market-section {
      margin-top: 30px;
      width: 100%;
    }

    .positions-content {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 12px;
      padding: 20px;
      min-height: 300px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #718096;
      font-size: 16px;
    }

    .signals-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 15px;
    }




    /* Верхнее меню */
    .top-menu {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: rgba(255, 255, 255, 0.98);
      backdrop-filter: blur(10px);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
      z-index: 1000;
      padding: 8px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 15px;
      height: 60px;
    }

    .menu-section {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .menu-item {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      background: #f8fafc;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      color: #2d3748;
      border: 1px solid #e2e8f0;
    }

    .menu-label {
      color: #718096;
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .menu-value {
      color: #2d3748;
      font-size: 13px;
      font-weight: 700;
    }

    .menu-value.positive {
      color: #48bb78;
    }

    .menu-value.negative {
      color: #f56565;
    }

    .menu-balance {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border: none;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }

    .menu-balance .menu-label {
      color: rgba(255, 255, 255, 0.9);
    }

    .menu-balance .balance-value {
      color: white;
      font-size: 16px;
      font-weight: 800;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .menu-in-deals {
      background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
      border: none;
      box-shadow: 0 4px 15px rgba(72, 187, 120, 0.4);
    }

    .menu-in-deals .menu-label {
      color: rgba(255, 255, 255, 0.9);
    }

    .menu-in-deals .deals-value {
      color: white;
      font-size: 16px;
      font-weight: 800;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .menu-pnl {
      background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
      border: none;
      box-shadow: 0 4px 15px rgba(66, 153, 225, 0.4);
      transition: all 0.3s ease;
    }

    .menu-pnl.positive {
      background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
      box-shadow: 0 4px 15px rgba(72, 187, 120, 0.4);
    }

    .menu-pnl.negative {
      background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);
      box-shadow: 0 4px 15px rgba(245, 101, 101, 0.4);
    }

    .menu-pnl .menu-label {
      color: rgba(255, 255, 255, 0.9);
    }

    .menu-pnl .pnl-value {
      color: white;
      font-size: 16px;
      font-weight: 800;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    body {
      padding-top: 70px;
    }

    /* Выпадающая статистика */
    .menu-stats-toggle {
      cursor: pointer;
      position: relative;
      transition: all 0.3s ease;
    }

    .menu-stats-toggle:hover {
      transform: translateY(-2px);
    }

    .stats-dropdown {
      position: absolute;
      top: calc(100% + 10px);
      right: 0;
      background: white;
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
      padding: 20px;
      min-width: 320px;
      opacity: 0;
      visibility: hidden;
      transform: translateY(-10px);
      transition: all 0.3s ease;
      z-index: 1001;
    }

    .stats-dropdown.show {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }

    .stats-dropdown-title {
      font-size: 16px;
      font-weight: 700;
      color: #2d3748;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 8px;
      border-bottom: 2px solid #e2e8f0;
      padding-bottom: 10px;
    }

    .stats-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0;
      border-bottom: 1px solid #f7fafc;
    }

    .stats-item:last-child {
      border-bottom: none;
    }

    .stats-item-label {
      font-size: 13px;
      color: #718096;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .stats-item-value {
      font-size: 14px;
      font-weight: 700;
      color: #2d3748;
    }

    .stats-item-value.positive {
      color: #48bb78;
    }

    .stats-item-value.negative {
      color: #f56565;
    }

    .stats-item-value.neutral {
      color: #4299e1;
    }

    .stats-toggle-icon {
      font-size: 12px;
      transition: transform 0.3s ease;
    }

    .stats-toggle-icon.open {
      transform: rotate(180deg);
    }

    /* Модальное окно истории сделок */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(4px);
      z-index: 2000;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .modal-overlay.show {
      opacity: 1;
      visibility: visible;
    }

    .modal-content {
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      width: 95%;
      max-width: 1400px;
      max-height: 85vh;
      overflow: hidden;
      transform: scale(0.9);
      transition: transform 0.3s ease;
    }

    .modal-overlay.show .modal-content {
      transform: scale(1);
    }

    .modal-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 25px 30px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      color: white;
    }

    .modal-title {
      font-size: 24px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .modal-close {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      color: white;
      transition: all 0.2s ease;
    }

    .modal-close:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: rotate(90deg);
    }

    .modal-body {
      padding: 30px;
      max-height: calc(85vh - 200px);
      overflow-y: auto;
      overflow-x: auto; /* Горизонтальная прокрутка */
    }

    .deals-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0 10px;
      min-width: 1200px; /* Минимальная ширина для всех колонок */
    }

    .deals-table th {
      text-align: left;
      font-size: 12px;
      font-weight: 600;
      color: #718096;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      padding: 10px 15px;
      background: #f7fafc;
      position: sticky;
      top: 0;
      z-index: 10;
      white-space: nowrap; /* Не переносить текст */
    }
    
    /* Оптимизация ширины колонок */
    .deals-table th:nth-child(1) { width: 80px; }  /* Монета */
    .deals-table th:nth-child(2) { width: 100px; } /* Направление */
    .deals-table th:nth-child(3) { width: 120px; } /* Вход */
    .deals-table th:nth-child(4) { width: 120px; } /* Выход */
    .deals-table th:nth-child(5) { width: 100px; } /* PnL */
    .deals-table th:nth-child(6) { width: 80px; }  /* % */
    .deals-table th:nth-child(7) { width: 140px; } /* Время закрытия */
    .deals-table th:nth-child(8) { width: 100px; } /* Длительность */

    .deals-table td {
      padding: 15px;
      background: white;
      border-top: 1px solid #e2e8f0;
      border-bottom: 1px solid #e2e8f0;
    }

    .deals-table tr {
      transition: all 0.2s ease;
    }

    .deals-table tbody tr:hover {
      transform: translateX(5px);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .deals-table td:first-child {
      border-left: 1px solid #e2e8f0;
      border-radius: 10px 0 0 10px;
    }

    .deals-table td:last-child {
      border-right: 1px solid #e2e8f0;
      border-radius: 0 10px 10px 0;
    }

    .deal-symbol {
      font-weight: 700;
      color: #2d3748;
      font-size: 14px;
    }

    .deal-direction {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
    }

    .deal-direction.long {
      background: #c6f6d5;
      color: #22543d;
    }

    .deal-direction.short {
      background: #fed7d7;
      color: #742a2a;
    }

    .deal-pnl {
      font-weight: 700;
      font-size: 14px;
    }

    .deal-pnl.positive {
      color: #48bb78;
    }

    .deal-pnl.negative {
      color: #f56565;
    }

    .modal-footer {
      padding: 20px 30px;
      background: #f7fafc;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-top: 1px solid #e2e8f0;
    }

    .pagination {
      display: flex;
      gap: 5px;
      align-items: center;
    }

    .pagination-btn {
      background: white;
      border: 1px solid #e2e8f0;
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      color: #4a5568;
      transition: all 0.2s ease;
    }

    .pagination-btn:hover:not(:disabled) {
      background: #667eea;
      color: white;
      border-color: #667eea;
    }

    .pagination-btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    .pagination-btn.active {
      background: #667eea;
      color: white;
      border-color: #667eea;
    }

    .pagination-info {
      font-size: 13px;
      color: #718096;
      font-weight: 600;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #a0aec0;
    }

    .empty-state-icon {
      font-size: 64px;
      margin-bottom: 20px;
      opacity: 0.5;
    }

    .empty-state-text {
      font-size: 18px;
      font-weight: 600;
      color: #718096;
    }

    /* Улучшенная статистика */
    .menu-stats-toggle {
      background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
      border: none;
      box-shadow: 0 4px 15px rgba(66, 153, 225, 0.4);
    }

    .menu-stats-toggle .menu-label,
    .menu-stats-toggle .menu-value {
      color: rgba(255, 255, 255, 0.9);
    }

    .menu-stats-toggle .stats-toggle-icon {
      color: white;
    }

    .stats-dropdown {
      background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);
      border: 2px solid #e2e8f0;
    }

    .stats-item {
      transition: all 0.2s ease;
    }

    .stats-item:hover {
      background: #f7fafc;
      border-radius: 8px;
      padding-left: 10px;
    }

    /* Toggle переключатель AUTO/MANUAL */
    .toggle-container {
      display: flex;
      align-items: center;
      gap: 8px;
      background: white;
      padding: 6px 10px;
      border-radius: 6px;
      border: 1px solid #e2e8f0;
    }

    .toggle-label {
      font-size: 10px;
      font-weight: 600;
      color: #718096;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .toggle-switch {
      position: relative;
      width: 50px;
      height: 24px;
      background: #e2e8f0;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .toggle-switch.active {
      background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
    }

    .toggle-slider {
      position: absolute;
      top: 2px;
      left: 2px;
      width: 20px;
      height: 20px;
      background: white;
      border-radius: 50%;
      transition: all 0.3s ease;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .toggle-switch.active .toggle-slider {
      left: 28px;
    }

    .toggle-status {
      font-size: 11px;
      font-weight: 700;
      min-width: 60px;
    }

    .toggle-status.manual {
      color: #718096;
    }

    .toggle-status.auto {
      color: #48bb78;
    }

    /* Таймер до свечи */
    .timer-item {
      background: linear-gradient(135deg, #fc8181 0%, #f56565 100%);
      border: none;
      box-shadow: 0 4px 15px rgba(245, 101, 101, 0.4);
    }

    .timer-item .menu-label,
    .timer-item .menu-value {
      color: rgba(255, 255, 255, 0.9);
    }

    .timer-value {
      color: white;
      font-size: 16px;
      font-weight: 800;
      font-family: 'Courier New', monospace;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    /* Статистика за сегодня */
    .today-stats {
      background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%);
      border: none;
      box-shadow: 0 4px 15px rgba(237, 137, 54, 0.4);
    }

    .today-stats .menu-label {
      color: rgba(255, 255, 255, 0.9);
    }

    .today-stats .stats-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      margin-top: 8px;
    }

    .today-stats .stat-mini {
      text-align: center;
    }

    .today-stats .stat-mini-label {
      font-size: 9px;
      color: rgba(255, 255, 255, 0.8);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .today-stats .stat-mini-value {
      font-size: 12px;
      font-weight: 800;
      color: white;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
    }

    /* Переключатель темы */
    .theme-toggle {
      cursor: pointer;
      background: linear-gradient(135deg, #4a5568 0%, #2d3748 100%);
      border: none;
      width: 40px;
      height: 40px;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(45, 55, 72, 0.4);
    }

    .theme-toggle:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(45, 55, 72, 0.6);
    }

    /* Dark theme */
    body.dark-theme {
      background: linear-gradient(135deg, #1a202c 0%, #2d3748 100%);
    }

    body.dark-theme .crypto-card,
    body.dark-theme .analytics-card,
    body.dark-theme .deal-card,
    body.dark-theme .open-deals-container,
    body.dark-theme .deal-prep-container {
      background: rgba(45, 55, 72, 0.95);
      color: #e2e8f0;
    }

    body.dark-theme .title,
    body.dark-theme .analytics-name,
    body.dark-theme .deal-symbol,
    body.dark-theme .stat-value,
    body.dark-theme .indicator-value {
      color: #e2e8f0;
    }

    body.dark-theme .subtitle,
    body.dark-theme .stat-label,
    body.dark-theme .indicator-label {
      color: #a0aec0;
    }

    body.dark-theme .top-menu {
      background: rgba(45, 55, 72, 0.98);
    }

    body.dark-theme .menu-item {
      background: #2d3748;
      border-color: #4a5568;
    }

    body.dark-theme .toggle-container {
      background: #2d3748;
      border-color: #4a5568;
    }

    body.dark-theme .modal-content {
      background: #2d3748;
      color: #e2e8f0;
    }

    body.dark-theme .deals-table th {
      background: #1a202c;
      color: #a0aec0;
    }

    body.dark-theme .deals-table td {
      background: #2d3748;
      border-color: #4a5568;
      color: #e2e8f0;
    }

    /* Dark theme для фильтров */
    body.dark-theme .filters-section {
      background: linear-gradient(135deg, #2d3748 0%, #1a202c 100%);
    }

    body.dark-theme .filters-title {
      color: #e2e8f0;
    }

    body.dark-theme .filter-card {
      background: #2d3748;
      border-color: #4a5568;
    }

    body.dark-theme .filter-name {
      color: #e2e8f0;
    }

    body.dark-theme .filter-rule {
      color: #a0aec0;
    }

    /* Dark theme для бургерного меню */
    body.dark-theme .burger-line {
      background: #e2e8f0;
    }

    body.dark-theme .burger-button:hover .burger-line {
      background: #4299e1;
    }

    body.dark-theme .burger-menu-content {
      background: rgba(45, 55, 72, 0.98);
    }

    body.dark-theme .burger-menu-item {
      color: #e2e8f0;
    }

    body.dark-theme .burger-menu-item:hover {
      background: #4a5568;
      color: #4299e1;
    }

    body.dark-theme .burger-menu-item.active {
      background: #2d5a3d;
      color: #68d391;
    }

    body.dark-theme .burger-menu-desc {
      color: #a0aec0;
    }

    body.dark-theme .burger-menu-divider {
      background: #4a5568;
    }

  </style>
</head>
<body>
  <!-- Верхнее меню -->
  <div class="top-menu">
    <div class="menu-section">
      <!-- Бургерное меню -->
      <div class="menu-item" style="position: relative; cursor: pointer;" id="burgerMenuItem">
        <button class="burger-button" id="burgerButton" style="background: none; border: none; cursor: pointer; padding: 0; margin: 0;">
          <div class="burger-line"></div>
          <div class="burger-line"></div>
          <div class="burger-line"></div>
        </button>
        
        <div class="burger-menu-content" id="burgerMenuContent">
          <div class="burger-menu-header">
            <div class="burger-menu-title">🎯 Crypto Bot</div>
            <div class="burger-menu-subtitle">Торговые стратегии</div>
          </div>
          
          <div class="burger-menu-items">
            <a href="/" class="burger-menu-item active">
              <div class="burger-menu-icon">🏠</div>
              <div>
                <div class="burger-menu-text">Основная стратегия</div>
                <div class="burger-menu-desc">Консервативная TP/SL</div>
              </div>
            </a>
            
            <a href="/rsi" class="burger-menu-item">
              <div class="burger-menu-icon">📊</div>
              <div>
                <div class="burger-menu-text">RSI стратегия</div>
                <div class="burger-menu-desc">Экстремумы RSI</div>
              </div>
            </a>
            
            <div class="burger-menu-divider"></div>
            
            <a href="#" class="burger-menu-item">
              <div class="burger-menu-icon">⚙️</div>
              <div>
                <div class="burger-menu-text">Настройки</div>
                <div class="burger-menu-desc">Скоро...</div>
              </div>
            </a>
            
            <a href="#" class="burger-menu-item">
              <div class="burger-menu-icon">📈</div>
              <div>
                <div class="burger-menu-text">MACD стратегия</div>
                <div class="burger-menu-desc">В разработке</div>
              </div>
            </a>
          </div>
        </div>
      </div>
      
      <div class="menu-item menu-balance">
        <span style="font-size: 20px;">💰</span>
        <div style="display: flex; flex-direction: column; gap: 2px;">
          <span class="menu-label">Баланс</span>
          <span class="menu-value balance-value" id="menu-balance">$1,000.00</span>
        </div>
      </div>
      <div class="menu-item menu-in-deals">
        <span style="font-size: 20px;">📊</span>
        <div style="display: flex; flex-direction: column; gap: 2px;">
          <span class="menu-label">В сделках</span>
          <span class="menu-value deals-value" id="menu-in-deals">$0.00</span>
        </div>
      </div>
      <div class="menu-item menu-pnl">
        <span style="font-size: 20px;">📈</span>
        <div style="display: flex; flex-direction: column; gap: 2px;">
          <span class="menu-label">Общий PnL</span>
          <span class="menu-value pnl-value" id="menu-pnl">+$0.00 (0.00%)</span>
        </div>
      </div>
    </div>
    
    <div class="menu-section">
      <!-- Переключатель AUTO/MANUAL -->
      <div class="toggle-container">
        <span class="toggle-label">🤖 Режим:</span>
        <div class="toggle-switch" id="auto-toggle">
          <div class="toggle-slider"></div>
        </div>
        <span class="toggle-status manual" id="toggle-status">MANUAL</span>
      </div>
      
      <!-- Таймер до следующей свечи -->
      <div class="menu-item timer-item">
        <span style="font-size: 18px;">⏱️</span>
        <div style="display: flex; flex-direction: column; gap: 2px;">
          <span class="menu-label">До свечи</span>
          <span class="timer-value" id="candle-timer">--:--</span>
        </div>
      </div>
      
      <!-- Статистика за сегодня -->
      <div class="menu-item today-stats">
        <div style="display: flex; flex-direction: column; gap: 2px; width: 100%;">
          <span class="menu-label">📊 Сегодня</span>
          <div class="stats-grid">
            <div class="stat-mini">
              <div class="stat-mini-label">Сделок</div>
              <div class="stat-mini-value" id="today-deals">0</div>
            </div>
            <div class="stat-mini">
              <div class="stat-mini-label">WR</div>
              <div class="stat-mini-value" id="today-wr">0%</div>
            </div>
            <div class="stat-mini">
              <div class="stat-mini-label">PnL</div>
              <div class="stat-mini-value" id="today-pnl">$0</div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="menu-item menu-stats-toggle" id="stats-toggle">
        <span style="font-size: 18px;">📊</span>
        <div style="display: flex; flex-direction: column; gap: 2px;">
          <span class="menu-label">Статистика</span>
          <span class="menu-value" style="font-size: 12px;">
            <span class="stats-toggle-icon" id="stats-icon">▼</span>
          </span>
        </div>
        
        <!-- Выпадающее меню -->
        <div class="stats-dropdown" id="stats-dropdown">
          <div class="stats-dropdown-title">
            📊 Статистика торговли
          </div>
          
          <div class="stats-item">
            <div class="stats-item-label">📋 Всего сделок</div>
            <div class="stats-item-value neutral" id="stat-total-deals">0</div>
          </div>
          
          <div class="stats-item">
            <div class="stats-item-label">✅ Прибыльных</div>
            <div class="stats-item-value positive" id="stat-profitable">0 (0%)</div>
          </div>
          
          <div class="stats-item">
            <div class="stats-item-label">❌ Убыточных</div>
            <div class="stats-item-value negative" id="stat-losses">0 (0%)</div>
          </div>
          
          <div class="stats-item">
            <div class="stats-item-label">📈 Средний профит</div>
            <div class="stats-item-value positive" id="stat-avg-profit">+$0.00</div>
          </div>
          
          <div class="stats-item">
            <div class="stats-item-label">📉 Средний убыток</div>
            <div class="stats-item-value negative" id="stat-avg-loss">-$0.00</div>
          </div>
          
          <div class="stats-item">
            <div class="stats-item-label">⚖️ R/R Ratio</div>
            <div class="stats-item-value" id="stat-rr-ratio">0.00</div>
          </div>
          
          <div class="stats-item">
            <div class="stats-item-label">💡 Expectancy</div>
            <div class="stats-item-value" id="stat-expectancy">+$0.00</div>
          </div>
          
          <div class="stats-item">
            <div class="stats-item-label">💸 Комиссии</div>
            <div class="stats-item-value negative" id="stat-total-fees">-$0.00</div>
          </div>
          
          <div class="stats-item">
            <div class="stats-item-label">📊 Gross PnL</div>
            <div class="stats-item-value" id="stat-gross-pnl">+$0.00</div>
          </div>
          
          <div class="stats-item">
            <button onclick="closeAllPositions()" style="background: #e53e3e; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 12px; margin-right: 8px;">
              🛑 Закрыть все
            </button>
            <button onclick="clearAllData()" style="background: #9f7aea; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 12px;">
              🗑️ Очистить все
            </button>
          </div>
        </div>
      </div>
      
      <div class="menu-item" id="history-toggle" style="cursor: pointer; transition: all 0.3s ease;">
        <span style="font-size: 18px;">📜</span>
        <span style="font-size: 13px; font-weight: 600; color: #2d3748;">История сделок</span>
      </div>
      
      <div class="menu-item">
        <div class="status-dot"></div>
        <span id="menu-status">Подключено</span>
      </div>
      
      <!-- Переключатель темы -->
      <div class="theme-toggle" id="theme-toggle" title="Сменить тему">
        <span id="theme-icon">🌙</span>
      </div>
    </div>
  </div>

  <!-- Модальное окно истории сделок -->
  <div class="modal-overlay" id="history-modal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">
          <span>📜</span>
          <span>История сделок</span>
        </div>
        <button class="modal-close" id="modal-close">✕</button>
      </div>
      
      <div class="modal-body" id="modal-body">
        <!-- Содержимое будет добавлено через JavaScript -->
      </div>
      
      <div class="modal-footer">
        <div class="pagination-info" id="pagination-info">Показано 0-0 из 0</div>
        <div class="pagination" id="pagination">
          <!-- Кнопки будут добавлены через JavaScript -->
        </div>
      </div>
    </div>
  </div>

  <div class="container">
    <!-- Секция сделок -->
    <div class="deals-section">
      <!-- Открытые сделки (слева) -->
      <div class="open-deals-container">
        <h2 class="open-deals-title">Открытые сделки</h2>
        <div class="open-deals-content">
          <!-- Открытые сделки будут добавлены через JavaScript -->
        </div>
      </div>
      
      <!-- Подготовка сделки (справа) -->
      <div class="deal-prep-container">
        <h2 class="deal-prep-title">🎯 Подготовка сделки</h2>
        <div class="deal-prep-grid" id="dealPrepGrid">
          <!-- Подготовленные сделки будут добавлены через JavaScript -->
        </div>
      </div>
    </div>

    <!-- Рыночные данные -->
    <div class="market-section">
      <h2 class="market-title">💰 Рыночные данные</h2>
      <div class="crypto-grid" id="cryptoGrid">
        <!-- Криптовалюты будут добавлены через JavaScript -->
      </div>
    </div>

    <!-- Секция аналитики -->
    <div class="analytics-section">
        <h2 class="analytics-title">📊 Техническая аналитика (15m)</h2>
      <div class="analytics-grid" id="analyticsGrid">
        <!-- Аналитика будет добавлена через JavaScript -->
      </div>
    </div>

    <!-- Секция фильтров -->
    <div class="filters-section">
      <h2 class="filters-title">🛡️ Торговые фильтры</h2>
      <div class="filters-grid">
        <div class="filter-card">
          <div class="filter-icon">📊</div>
          <div class="filter-info">
            <div class="filter-name">RSI фильтр</div>
            <div class="filter-desc">
              <div class="filter-rule">🟢 LONG: без ограничений по RSI</div>
              <div class="filter-rule">🔴 SHORT: RSI &gt; 35 (не перепродан)</div>
            </div>
          </div>
        </div>
        
        <div class="filter-card">
          <div class="filter-icon">📈</div>
          <div class="filter-info">
            <div class="filter-name">ATR фильтр (волатильность)</div>
            <div class="filter-desc">
              <div class="filter-rule">✅ ATR &lt; 0.5% от цены</div>
              <div class="filter-rule">🚫 Блокировка при высокой волатильности</div>
            </div>
          </div>
        </div>
        
        <div class="filter-card">
          <div class="filter-icon">📊</div>
          <div class="filter-info">
            <div class="filter-name">Объем свечи</div>
            <div class="filter-desc">
              <div class="filter-rule">🚫 LONG + большой объем вниз</div>
              <div class="filter-rule">🚫 SHORT + большой объем вверх</div>
              <div class="filter-rule">✅ Ловим импульсы по направлению!</div>
            </div>
          </div>
        </div>
        
        <div class="filter-card">
          <div class="filter-icon">⚡</div>
          <div class="filter-info">
            <div class="filter-name">Импульсы и тренды</div>
            <div class="filter-desc">
              <div class="filter-rule">🚀 Ловим импульсы вверх/вниз</div>
              <div class="filter-rule">📈 Входим на коррекциях в тренде</div>
              <div class="filter-rule">✅ Без блокировки по направлению</div>
            </div>
          </div>
        </div>
        
        <div class="filter-card" style="border: 2px solid #f59e0b;">
          <div class="filter-icon">🎯</div>
          <div class="filter-info">
            <div class="filter-name">Контртренд (RSI экстремумы)</div>
            <div class="filter-desc">
              <div class="filter-rule">🔴 SHORT: RSI ≥ 78 + объем &gt; 1.5x</div>
              <div class="filter-rule">🟢 LONG: RSI ≤ 23 + объем &gt; 1.5x</div>
              <div class="filter-rule">⚡ Моментальное открытие без таймера</div>
            </div>
          </div>
        </div>
        
        <div class="filter-card" style="border: 2px solid #10b981;">
          <div class="filter-icon">📈</div>
          <div class="filter-info">
            <div class="filter-name">Консервативная стратегия</div>
            <div class="filter-desc">
              <div class="filter-rule">70%+: TP 0.29%, SL 0.17%</div>
              <div class="filter-rule">55-69%: TP 0.25%, SL 0.14%</div>
              <div class="filter-rule">R:R = 1:1.7 (консервативно!)</div>
            </div>
          </div>
        </div>
      </div>
    </div>
      </div>
    </div>
  </div>

  <script>
    // Бургерное меню
    document.addEventListener('DOMContentLoaded', function() {
      const burgerButton = document.getElementById('burgerButton');
      const burgerMenuContent = document.getElementById('burgerMenuContent');
      
      burgerButton.addEventListener('click', function() {
        burgerButton.classList.toggle('active');
        burgerMenuContent.classList.toggle('active');
      });
      
      // Закрытие меню при клике вне его
      document.addEventListener('click', function(event) {
        if (!burgerButton.contains(event.target) && !burgerMenuContent.contains(event.target)) {
          burgerButton.classList.remove('active');
          burgerMenuContent.classList.remove('active');
        }
      });
      
      // Закрытие меню при клике на пункт меню
      const menuItems = document.querySelectorAll('.burger-menu-item');
      menuItems.forEach(item => {
        item.addEventListener('click', function() {
          burgerButton.classList.remove('active');
          burgerMenuContent.classList.remove('active');
        });
      });
    });

    const ws = new WebSocket('ws://localhost:5000');
    const cryptoGrid = document.getElementById('cryptoGrid');
    const analyticsGrid = document.getElementById('analyticsGrid');
    const dealPrepGrid = document.getElementById('dealPrepGrid');
    const lastPrices = {};
    let dealPrepData = {}; // Хранилище данных для подготовки сделок
    
    // Загружаем сохраненные данные при загрузке страницы
    function loadDealPrepData() {
      const saved = localStorage.getItem('dealPrepData');
      if (saved) {
        try {
          const parsed = JSON.parse(saved);
          const now = Date.now();
          Object.keys(parsed).forEach(symbol => {
            const deal = parsed[symbol];
            if (deal && deal.timestamp) {
              const elapsed = Math.floor((now - deal.timestamp) / 1000);
              const remaining = deal.timerSeconds - elapsed;
              
              if (remaining <= 0) {
                // ⚠️ ТАЙМЕР ИСТЕК ВО ВРЕМЯ ЗАКРЫТОЙ СТРАНИЦЫ
                // Проверяем сколько времени прошло после истечения
                const overdueSeconds = Math.abs(remaining);
                const maxOverdueSeconds = 30; // Максимум 30 секунд после истечения
                
                if (overdueSeconds <= maxOverdueSeconds) {
                  // Таймер истек недавно (≤ 30 секунд назад) → открываем сделку
                  console.log(`⏰ Таймер для ${symbol} истек ${overdueSeconds} секунд назад. Открываем сделку!`);
                  
                  // Открываем сделку автоматически после загрузки цен
                  setTimeout(() => {
                    if (lastPrices[symbol]) {
                      autoOpenDeal(symbol, deal);
                    } else {
                      console.error(`❌ ${symbol}: Цена еще не загружена, ждем...`);
                      // Повторная попытка через 2 секунды
                      setTimeout(() => {
                        if (lastPrices[symbol]) {
                          autoOpenDeal(symbol, deal);
                        } else {
                          console.error(`❌ ${symbol}: Не удалось получить цену, сделка отменена`);
                        }
                      }, 2000);
                    }
                  }, 1500); // Даем 1.5 секунды на загрузку цен
                } else {
                  // Таймер истек СЛИШКОМ давно (> 30 секунд) → отменяем сделку
                  console.log(`❌ ${symbol}: Таймер истек ${overdueSeconds} секунд назад (> ${maxOverdueSeconds}с). Сделка отменена.`);
                }
                
                // НЕ добавляем в dealPrepData (истекшая сделка)
              } else {
                // Таймер еще активен - восстанавливаем с ОБНОВЛЕННЫМ timestamp
                dealPrepData[symbol] = {
                  ...deal,
                  timerSeconds: remaining,
                  timestamp: now // ⚠️ КРИТИЧНО: обновляем timestamp!
                };
                // Восстанавливаем карточку
                createOrUpdateDealCard(symbol, dealPrepData[symbol]);
                
                console.log(`🔄 Восстановлен таймер для ${symbol}: осталось ${remaining} секунд (timestamp обновлен)`);
              }
            }
          });
          
          // Сохраняем обновленные данные с новыми timestamp
          saveDealPrepData();
        } catch (e) {
          console.log('Ошибка загрузки данных сделок:', e);
        }
      }
    }
    
    // Сохраняем данные в localStorage
    function saveDealPrepData() {
      try {
        localStorage.setItem('dealPrepData', JSON.stringify(dealPrepData));
      } catch (e) {
        console.log('Ошибка сохранения данных сделок:', e);
      }
    }
    
    // ============================================
    // Система учета сделок и баланса
    // ============================================
    let initialBalance = 1000; // Начальный баланс
    let currentBalance = 1000; // Текущий баланс (с учетом открытых позиций)
    let realizedPnL = 0; // Прибыль/убыток от закрытых сделок
    let openPositions = []; // Массив открытых позиций
    let closedDeals = []; // История закрытых сделок
    let isAutoTradingEnabled = false; // Режим автоторговли
    let isDarkTheme = false; // Тема интерфейса
    let totalCommissions = 0; // Общая сумма комиссий
    let cooldownSymbols = {}; // Кулдаун для монет после закрытия (symbol -> timestamp)
    
    // Константы Binance Futures
    const FUTURES_TAKER_FEE = 0.0004; // 0.04% комиссия taker
    const POSITION_SIZE_USD = 100; // Размер позиции в долларах
    
    // Функция расчета TP/SL по уверенности (Консервативная стратегия)
    function calculateTPSL(confidence) {
      if (confidence >= 70) {
        return { tp: 0.29, sl: 0.17 };  // TP 0.29%, SL 0.17% → 1:1.71
      } else if (confidence >= 55) {
        return { tp: 0.25, sl: 0.14 };  // TP 0.25%, SL 0.14% → 1:1.79
      } else {
        return null; // Не торгуем ниже 55%
      }
    }
    
    // Функция проверки фильтров RSI, ATR, Объема и Направления свечи
    function checkTradingFilters(symbol, direction, analytics) {
      const currentPrice = lastPrices[symbol] || 0;
      if (!currentPrice || !analytics) return false;
      
      // RSI фильтр (только для SHORT в перепроданности)
      const rsi = analytics.rsi || 50;
      if (direction === 'SHORT' && rsi <= 35) {
        console.log(`🚫 ${symbol}: RSI ${rsi.toFixed(1)} <= 35, SHORT заблокирован`);
        return false;
      }
      
      // ATR фильтр (волатильность)
      const atr = analytics.atr || 0;
      const atrPercent = (atr / currentPrice) * 100;
      const maxVolatility = 0.5; // Максимальная волатильность 0.5%
      
      if (atrPercent > maxVolatility) {
        console.log(`🚫 ${symbol}: ATR ${atrPercent.toFixed(3)}% > ${maxVolatility}%, сделка заблокирована`);
        return false;
      }
      
      // ОБЪЕМ фильтр (блокировка по направлению объема)
      const currentVolume = analytics.currentVolume || 0;
      const previousVolume = analytics.previousVolume || 0;
      const candleOpen = analytics.candleOpen || 0;
      const candleClose = analytics.candleClose || 0;
      
      console.log(`📊 ${symbol}: Объемы - Текущий: ${currentVolume.toLocaleString()}, Предыдущий: ${previousVolume.toLocaleString()}`);
      
      if (currentVolume > 0 && previousVolume > 0 && candleOpen > 0 && candleClose > 0) {
        const volumeRatio = currentVolume / previousVolume;
        const volumePercent = ((volumeRatio - 1) * 100).toFixed(1);
        
        // Определяем направление свечи по объему
        const candleDirection = candleClose > candleOpen ? 'UP' : 'DOWN';
        const signalDirection = direction === 'LONG' ? 'UP' : 'DOWN';
        
        console.log(`📈 ${symbol}: Соотношение объемов: ${volumeRatio.toFixed(2)}x (${volumePercent > 0 ? '+' : ''}${volumePercent}%)`);
        console.log(`🕯️ ${symbol}: Направление свечи: ${candleDirection}, Сигнал: ${signalDirection}`);
        
        // Блокируем только если большой объем идет ПРОТИВ сигнала
        if (volumeRatio > 2.0) { // Большой объем
          if (candleDirection !== signalDirection) {
            console.log(`🚫 ${symbol}: Большой объем ${(volumeRatio * 100).toFixed(0)}% идет ПРОТИВ сигнала ${signalDirection}! Блокируем!`);
            return false;
          } else {
            console.log(`✅ ${symbol}: Большой объем ${(volumeRatio * 100).toFixed(0)}% идет ЗА сигналом ${signalDirection}! Импульс!`);
          }
        } else {
          console.log(`✅ ${symbol}: Объем в норме (${volumeRatio.toFixed(2)}x), направление не критично`);
        }
      } else {
        console.log(`⚠️ ${symbol}: Недостаточно данных для проверки направления объема`);
      }
      
      console.log(`✅ ${symbol}: Все фильтры пройдены - RSI: ${rsi.toFixed(1)}, ATR: ${atrPercent.toFixed(3)}%`);
      return true;
    }
    
    // Проверка кулдауна для монеты
    function isSymbolInCooldown(symbol) {
      if (!cooldownSymbols[symbol]) return false;
      
      const cooldownTime = 60 * 1000; // 1 минута в миллисекундах
      const timeSinceClose = Date.now() - cooldownSymbols[symbol];
      
      if (timeSinceClose >= cooldownTime) {
        // Кулдаун истек, удаляем из списка
        delete cooldownSymbols[symbol];
        return false;
      }
      
      return true;
    }
    
    // Добавление монеты в кулдаун
    function addSymbolToCooldown(symbol) {
      cooldownSymbols[symbol] = Date.now();
      console.log(`⏰ ${symbol} добавлена в кулдаун на 1 минуту`);
    }
    
    // Расчет нереализованного PnL (открытые позиции)
    function calculateUnrealizedPnL() {
      return openPositions.reduce((total, position) => {
        const priceDiff = position.direction === 'LONG' 
          ? (position.currentPrice - position.entryPrice)
          : (position.entryPrice - position.currentPrice);
        
        return total + (priceDiff * position.volume);
      }, 0);
    }
    
    // Расчет общего PnL
    function calculateTotalPnL() {
      const unrealizedPnL = calculateUnrealizedPnL();
      const totalPnL = realizedPnL + unrealizedPnL;
      const roi = (totalPnL / initialBalance) * 100;
      
      return { 
        totalPnL, 
        roi, 
        realizedPnL, 
        unrealizedPnL 
      };
    }
    
    // Расчет суммы в открытых сделках
    function calculateInDeals() {
      return openPositions.reduce((sum, pos) => sum + pos.amountUSD, 0);
    }
    
    // Обновление отображения баланса и PnL
    function updateBalanceDisplay() {
      const pnl = calculateTotalPnL();
      const inDeals = calculateInDeals();
      
      // Обновляем баланс
      document.getElementById('menu-balance').textContent = 
        `$${currentBalance.toFixed(2)}`;
      
      // Обновляем сумму в сделках
      document.getElementById('menu-in-deals').textContent = 
        `$${inDeals.toFixed(2)}`;
      
      // Обновляем PnL
      const sign = pnl.totalPnL >= 0 ? '+' : '';
      const pnlElement = document.getElementById('menu-pnl');
      const pnlContainer = pnlElement.closest('.menu-pnl');
      
      pnlElement.textContent = 
        `${sign}$${pnl.totalPnL.toFixed(2)} (${sign}${pnl.roi.toFixed(2)}%)`;
      
      // Обновляем цвет в зависимости от PnL
      pnlContainer.classList.remove('positive', 'negative');
      if (pnl.totalPnL > 0) {
        pnlContainer.classList.add('positive');
      } else if (pnl.totalPnL < 0) {
        pnlContainer.classList.add('negative');
      }
      
      // Обновляем статистику торговли
      updateTradingStats();
      
      // Обновляем статистику за сегодня
      updateTodayStats();
    }
    
    // Обновление статистики торговли
    function updateTradingStats() {
      const totalDeals = closedDeals.length;
      const profitableDeals = closedDeals.filter(d => d.realizedPnL > 0);
      const losingDeals = closedDeals.filter(d => d.realizedPnL < 0);
      
      const winRate = totalDeals > 0 ? (profitableDeals.length / totalDeals * 100) : 0;
      const lossRate = totalDeals > 0 ? (losingDeals.length / totalDeals * 100) : 0;
      
      const avgProfit = profitableDeals.length > 0
        ? profitableDeals.reduce((sum, d) => sum + d.realizedPnL, 0) / profitableDeals.length
        : 0;
      
      const avgLoss = losingDeals.length > 0
        ? losingDeals.reduce((sum, d) => sum + d.realizedPnL, 0) / losingDeals.length
        : 0;
      
      const rrRatio = avgLoss !== 0 ? Math.abs(avgProfit / avgLoss) : 0;
      const expectancy = totalDeals > 0 ? realizedPnL / totalDeals : 0;
      
      // Обновляем UI
      document.getElementById('stat-total-deals').textContent = totalDeals;
      
      document.getElementById('stat-profitable').textContent = 
        `${profitableDeals.length} (${winRate.toFixed(0)}%)`;
      
      document.getElementById('stat-losses').textContent = 
        `${losingDeals.length} (${lossRate.toFixed(0)}%)`;
      
      document.getElementById('stat-avg-profit').textContent = 
        `+$${avgProfit.toFixed(2)}`;
      
      document.getElementById('stat-avg-loss').textContent = 
        `${avgLoss.toFixed(2) === '0.00' ? '-$0.00' : '$' + avgLoss.toFixed(2)}`;
      
      const rrElement = document.getElementById('stat-rr-ratio');
      rrElement.textContent = rrRatio.toFixed(2);
      rrElement.className = 'stats-item-value';
      if (rrRatio >= 2) {
        rrElement.classList.add('positive');
      } else if (rrRatio >= 1) {
        rrElement.classList.add('neutral');
      } else {
        rrElement.classList.add('negative');
      }
      
      const expElement = document.getElementById('stat-expectancy');
      const expSign = expectancy >= 0 ? '+' : '';
      expElement.textContent = `${expSign}$${expectancy.toFixed(2)}`;
      expElement.className = 'stats-item-value';
      if (expectancy > 0) {
        expElement.classList.add('positive');
      } else if (expectancy < 0) {
        expElement.classList.add('negative');
      } else {
        expElement.classList.add('neutral');
      }
      
      // Обновляем комиссии
      document.getElementById('stat-total-fees').textContent = `-$${totalCommissions.toFixed(2)}`;
      
      // Рассчитываем Gross PnL (до комиссий)
      const grossPnL = closedDeals.reduce((sum, d) => sum + (d.grossProfit || d.realizedPnL), 0);
      const grossElement = document.getElementById('stat-gross-pnl');
      const grossSign = grossPnL >= 0 ? '+' : '';
      grossElement.textContent = `${grossSign}$${grossPnL.toFixed(2)}`;
      grossElement.className = 'stats-item-value';
      if (grossPnL > 0) {
        grossElement.classList.add('positive');
      } else if (grossPnL < 0) {
        grossElement.classList.add('negative');
      } else {
        grossElement.classList.add('neutral');
      }
    }
    
    // Открытие позиции
    function openPosition(symbol, direction, entryPrice, volumeUSD, confidence) {
      const tpslLevels = calculateTPSL(confidence);
      if (!tpslLevels) {
        console.error(`❌ Уверенность ${confidence}% слишком низкая для открытия сделки`);
        return null;
      }
      
      // Для фьючерсов: объем = размер позиции / цена входа
      const volume = volumeUSD / entryPrice;
      const openCommission = volumeUSD * FUTURES_TAKER_FEE;
      
      // Рассчитываем TP и SL цены
      const tpPrice = direction === 'LONG'
        ? entryPrice * (1 + tpslLevels.tp / 100)
        : entryPrice * (1 - tpslLevels.tp / 100);
      
      const slPrice = direction === 'LONG'
        ? entryPrice * (1 - tpslLevels.sl / 100)
        : entryPrice * (1 + tpslLevels.sl / 100);
      
      const position = {
        id: Date.now(), // Уникальный ID
        symbol: symbol,
        direction: direction, // 'LONG' или 'SHORT'
        entryPrice: entryPrice,
        volume: volume,
        amountUSD: volumeUSD,
        tpPercent: tpslLevels.tp,
        slPercent: tpslLevels.sl,
        tpPrice: tpPrice,
        slPrice: slPrice,
        openCommission: openCommission,
        closeCommission: 0,
        totalCommission: openCommission,
        confidence: confidence,
        openTime: Date.now(),
        currentPrice: entryPrice,
        unrealizedPnL: 0,
        grossPnL: 0,
        netPnL: 0
      };

      // Логирование открытия позиции
      console.log(`🚀 ОТКРЫТА ПОЗИЦИЯ: ${symbol} ${direction}`);
      console.log(`   Вход: $${entryPrice.toFixed(2)}`);
      console.log(`   TP: $${tpPrice.toFixed(2)} (${tpslLevels.tp}%)`);
      console.log(`   SL: $${slPrice.toFixed(2)} (${tpslLevels.sl}%)`);
      console.log(`   Уверенность: ${confidence}%`);
      
      openPositions.push(position);
      currentBalance -= (volumeUSD + openCommission); // Вычитаем сумму + комиссию
      totalCommissions += openCommission;
      
      console.log(`📈 Открыта позиция: ${direction} ${symbol} @ $${entryPrice.toFixed(2)}`);
      console.log(`   Объём: $${volumeUSD.toFixed(2)}, Комиссия: $${openCommission.toFixed(2)}`);
      console.log(`   TP: $${tpPrice.toFixed(2)} (+${tpslLevels.tp}%), SL: $${slPrice.toFixed(2)} (-${tpslLevels.sl}%)`);
      
      // Создаем UI карточку
      createOpenDealCard(position);
      
      // ⚠️ УБИРАЕМ МОНЕТУ ИЗ ПОДГОТОВКИ СДЕЛОК
      if (dealPrepData[symbol]) {
        delete dealPrepData[symbol];
        removeDealCard(symbol);
        saveDealPrepData();
        console.log(`🗑️ ${symbol} удалена из подготовки сделок`);
      }
      
      updateBalanceDisplay();
      saveDealData();
      return position;
    }
    
    // Закрытие позиции
    function closePosition(positionIndex, exitPrice, reason = 'MANUAL') {
      const position = openPositions[positionIndex];
      
      if (!position) {
        console.error('❌ Позиция не найдена');
        return null;
      }
      
      // ⚠️ КРИТИЧЕСКАЯ ПРОВЕРКА: Для SL не превышаем установленный лимит!
      if (reason === 'SL') {
        const actualLossPercent = position.direction === 'LONG' 
          ? ((position.entryPrice - exitPrice) / position.entryPrice) * 100
          : ((exitPrice - position.entryPrice) / position.entryPrice) * 100;
        
        if (actualLossPercent > position.slPercent) {
          console.warn(`⚠️ ${position.symbol}: SL превышает лимит! Принудительно закрываем по точному SL`);
          exitPrice = position.slPrice; // Принудительно используем точный SL
        }
      }
      
      const priceDiff = position.direction === 'LONG'
        ? (exitPrice - position.entryPrice)
        : (position.entryPrice - exitPrice);
      
      const grossProfit = priceDiff * position.volume;
      const closeCommission = position.amountUSD * FUTURES_TAKER_FEE;
      const totalCommission = position.openCommission + closeCommission;
      const netProfit = grossProfit - totalCommission;
      
      // Обновляем балансы
      realizedPnL += netProfit;
      currentBalance += position.amountUSD + netProfit;
      totalCommissions += closeCommission;
      
      // Создаем запись о закрытой сделке
      const closedDeal = {
        ...position,
        exitPrice: exitPrice,
        closeTime: Date.now(),
        duration: Date.now() - position.openTime,
        closeCommission: closeCommission,
        totalCommission: totalCommission,
        grossProfit: grossProfit,
        netProfit: netProfit,
        realizedPnL: netProfit,
        profitPercent: (grossProfit / position.amountUSD) * 100,
        closeReason: reason
      };
      
      closedDeals.push(closedDeal);
      openPositions.splice(positionIndex, 1);
      
      // Добавляем монету в кулдаун на 1 минуту
      addSymbolToCooldown(position.symbol);
      
      const emoji = reason === 'TP' ? '🎯' : reason === 'SL' ? '🛑' : '👋';
      console.log(`${emoji} Закрыта позиция: ${position.direction} ${position.symbol} @ $${exitPrice.toFixed(2)}`);
      console.log(`   Причина: ${reason}`);
      console.log(`   Gross PnL: ${grossProfit >= 0 ? '+' : ''}$${grossProfit.toFixed(2)}`);
      console.log(`   Комиссия: -$${totalCommission.toFixed(2)}`);
      console.log(`   Net PnL: ${netProfit >= 0 ? '+' : ''}$${netProfit.toFixed(2)}`);
      
      // Удаляем UI карточку
      removeOpenDealCard(position.id);
      
      updateBalanceDisplay();
      saveDealData();
      return closedDeal;
    }
    
    // Обновление текущих цен в открытых позициях и мониторинг TP/SL
    function updateOpenPositionsPrices(data) {
      openPositions.forEach((position, index) => {
        if (data[position.symbol] && data[position.symbol].futures) {
          const currentPrice = data[position.symbol].futures.price;
          position.currentPrice = currentPrice;
          
          // Пересчитываем PnL
          const priceDiff = position.direction === 'LONG' 
            ? (currentPrice - position.entryPrice)
            : (position.entryPrice - currentPrice);
          
          const grossPnL = priceDiff * position.volume;
          // НЕ вычитаем НИКАКИЕ комиссии из текущего PnL - только при закрытии!
          const netPnL = grossPnL; // Показываем только движение цены!
          
          // СУПЕР ТОЧНЫЙ расчет - до 4 знаков после запятой
          position.grossPnL = Math.round(grossPnL * 10000) / 10000;
          position.netPnL = Math.round(netPnL * 10000) / 10000;
          position.unrealizedPnL = position.netPnL;
          
          // Логирование только при значительных изменениях PnL
          if (position.symbol === 'BTCUSDT' && Math.abs(position.netPnL) > 0.1) {
            console.log(`💰 ${position.symbol}: PnL $${position.netPnL.toFixed(2)} (${((position.netPnL/position.amountUSD)*100).toFixed(2)}%)`);
          }
          
          // ⚠️ ПРОВЕРКА TP
          if (position.direction === 'LONG' && currentPrice >= position.tpPrice) {
            const pnlPercent = ((currentPrice - position.entryPrice) / position.entryPrice) * 100;
            console.log(`🎯 ${position.symbol}: Достигнут Take Profit!`);
            console.log(`   Вход: $${position.entryPrice.toFixed(2)}, Текущая: $${currentPrice.toFixed(2)}, TP: $${position.tpPrice.toFixed(2)}`);
            console.log(`   PnL: ${pnlPercent.toFixed(3)}% (цель: ${position.tpPercent}%)`);
            console.log(`   Превышение: ${(pnlPercent - position.tpPercent).toFixed(3)}%`);
            closePosition(index, position.tpPrice, 'TP'); // Закрываем по точному TP
            return;
          }
          if (position.direction === 'SHORT' && currentPrice <= position.tpPrice) {
            const pnlPercent = ((position.entryPrice - currentPrice) / position.entryPrice) * 100;
            console.log(`🎯 ${position.symbol}: Достигнут Take Profit!`);
            console.log(`   Вход: $${position.entryPrice.toFixed(2)}, Текущая: $${currentPrice.toFixed(2)}, TP: $${position.tpPrice.toFixed(2)}`);
            console.log(`   PnL: ${pnlPercent.toFixed(3)}% (цель: ${position.tpPercent}%)`);
            console.log(`   Превышение: ${(pnlPercent - position.tpPercent).toFixed(3)}%`);
            closePosition(index, position.tpPrice, 'TP'); // Закрываем по точному TP
            return;
          }
          
          // ⚠️ ПРОВЕРКА SL - СТРОГИЙ КОНТРОЛЬ ЛИМИТА
          if (position.direction === 'LONG' && currentPrice <= position.slPrice) {
            const pnlPercent = ((currentPrice - position.entryPrice) / position.entryPrice) * 100;
            console.log(`🛑 ${position.symbol}: Сработал Stop Loss!`);
            console.log(`   Вход: $${position.entryPrice.toFixed(2)}, Текущая: $${currentPrice.toFixed(2)}, SL: $${position.slPrice.toFixed(2)}`);
            console.log(`   PnL: ${pnlPercent.toFixed(3)}% (лимит: -${position.slPercent}%)`);
            
            // ⚠️ КРИТИЧНО: Закрываем по точному SL, НЕ больше лимита!
            closePosition(index, position.slPrice, 'SL');
            return;
          }
          if (position.direction === 'SHORT' && currentPrice >= position.slPrice) {
            const pnlPercent = ((position.entryPrice - currentPrice) / position.entryPrice) * 100;
            console.log(`🛑 ${position.symbol}: Сработал Stop Loss!`);
            console.log(`   Вход: $${position.entryPrice.toFixed(2)}, Текущая: $${currentPrice.toFixed(2)}, SL: $${position.slPrice.toFixed(2)}`);
            console.log(`   PnL: ${pnlPercent.toFixed(3)}% (лимит: -${position.slPercent}%)`);
            
            // ⚠️ КРИТИЧНО: Закрываем по точному SL, НЕ больше лимита!
            closePosition(index, position.slPrice, 'SL');
            return;
          }
          
          // Обновляем UI карточку
          updateOpenDealCardPrices(position);
        }
      });
    }
    
    // Автоматическое открытие сделки по истечению таймера
    function autoOpenDeal(symbol, dealData) {
      // ⚠️ КРИТИЧЕСКАЯ ПРОВЕРКА: Запрещаем дублирование монет
      const existingPosition = openPositions.find(pos => pos.symbol === symbol);
      if (existingPosition) {
        console.error(`❌ ${symbol}: Уже есть открытая позиция! Дублирование запрещено.`);
        return;
      }
      
      // Получаем текущую рыночную цену из lastPrices (futures)
      const entryPrice = lastPrices[symbol];
      
      if (!entryPrice) {
        console.error(`❌ Цена для ${symbol} недоступна`);
        return;
      }
      
      // Проверяем достаточно ли баланса
      const requiredBalance = POSITION_SIZE_USD + (POSITION_SIZE_USD * FUTURES_TAKER_FEE);
      if (currentBalance < requiredBalance) {
        console.error(`❌ Недостаточно средств для открытия сделки. Требуется: $${requiredBalance.toFixed(2)}, Доступно: $${currentBalance.toFixed(2)}`);
        return;
      }
      
      // Открываем позицию
      const direction = dealData.direction === 'buy' ? 'LONG' : 'SHORT';
      const position = openPosition(symbol, direction, entryPrice, POSITION_SIZE_USD, dealData.confidence);
      
      if (position) {
        console.log(`✅ Автоматически открыта сделка ${symbol} ${direction} по цене $${entryPrice.toFixed(2)}`);
      }
    }
    
    // Сохранение/загрузка данных сделок
    function saveDealData() {
      try {
        const data = {
          openPositions: openPositions,
          closedDeals: closedDeals,
          currentBalance: currentBalance,
          realizedPnL: realizedPnL,
          totalCommissions: totalCommissions,
          cooldownSymbols: cooldownSymbols,
          timestamp: Date.now()
        };
        localStorage.setItem('tradingData', JSON.stringify(data));
      } catch (e) {
        console.error('Ошибка сохранения данных:', e);
      }
    }
    
    function loadDealData() {
      try {
        const saved = localStorage.getItem('tradingData');
        if (saved) {
          const data = JSON.parse(saved);
          openPositions = data.openPositions || [];
          closedDeals = data.closedDeals || [];
          currentBalance = data.currentBalance || initialBalance;
          realizedPnL = data.realizedPnL || 0;
          totalCommissions = data.totalCommissions || 0;
          cooldownSymbols = data.cooldownSymbols || {};
          
          // Восстанавливаем UI для открытых позиций
          openPositions.forEach(position => {
            createOpenDealCard(position);
          });
          
          console.log(`✅ Загружены данные: ${openPositions.length} открытых, ${closedDeals.length} закрытых сделок`);
          updateBalanceDisplay();
        }
      } catch (e) {
        console.error('Ошибка загрузки данных:', e);
      }
    }
    // ============================================
    
    // Конфигурация криптовалют
    const cryptoConfig = {
      'BTCUSDT': { name: 'Bitcoin', symbol: '₿', class: 'btc' },
      'ETHUSDT': { name: 'Ethereum', symbol: 'Ξ', class: 'eth' },
      'SOLUSDT': { name: 'Solana', symbol: '◎', class: 'sol' },
      'XRPUSDT': { name: 'Ripple', symbol: '✕', class: 'xrp' },
      'BNBUSDT': { name: 'BNB', symbol: 'B', class: 'bnb' },
      'DOGEUSDT': { name: 'Dogecoin', symbol: 'Ð', class: 'doge' }
    };

    // Создаем карточки для всех криптовалют
    Object.keys(cryptoConfig).forEach(symbol => {
      const config = cryptoConfig[symbol];
      const card = createCryptoCard(symbol, config);
      cryptoGrid.appendChild(card);
      
      // Создаем аналитическую карточку
      const analyticsCard = createAnalyticsCard(symbol, config);
      analyticsGrid.appendChild(analyticsCard);

    });

    function createCryptoCard(symbol, config) {
      const card = document.createElement('div');
      card.className = 'crypto-card';
      card.id = `card-${symbol}`;
      
      card.innerHTML = `
        <div class="header">
          <div class="icon ${config.class}">${config.symbol}</div>
          <div>
            <div class="title">${config.name}</div>
            <div class="subtitle">${symbol}/USDT Futures</div>
          </div>
        </div>

        <div class="price-display">
          <div class="price" id="price-${symbol}">Загрузка...</div>
          <div class="change" id="change-${symbol}">--</div>
        </div>

        <div class="stats">
          <div class="stat-item">
            <div class="stat-label">Максимум 24ч</div>
            <div class="stat-value" id="high-${symbol}">--</div>
          </div>
          <div class="stat-item">
            <div class="stat-label">Минимум 24ч</div>
            <div class="stat-value" id="low-${symbol}">--</div>
          </div>
          <div class="stat-item">
            <div class="stat-label">Объем 24ч</div>
            <div class="stat-value" id="volume-${symbol}">--</div>
          </div>
          <div class="stat-item">
            <div class="stat-label">Обновлено</div>
            <div class="stat-value" id="time-${symbol}">--</div>
          </div>
          <div class="stat-item">
            <div class="stat-label">Точность</div>
            <div class="stat-value" id="precision-${symbol}">--</div>
          </div>
          <div class="stat-item">
            <div class="stat-label">Raw Data</div>
            <div class="stat-value" id="raw-${symbol}">--</div>
          </div>
        </div>

        <div class="status">
          <div class="status-dot"></div>
          <span>Подключено к Binance Futures</span>
        </div>
      `;
      
      return card;
    }

    function createAnalyticsCard(symbol, config) {
      const card = document.createElement('div');
      card.className = 'analytics-card';
      card.id = `analytics-${symbol}`;
      
      card.innerHTML = `
        <div class="analytics-header">
          <div class="analytics-icon ${config.class}">${config.symbol}</div>
          <div class="analytics-name">${config.name}</div>
          <div class="trend-indicators">
            <div class="trend-line">
              <span class="trend-label">LONG:</span>
              <span class="trend-percentage" id="long-percentage-${symbol}">0%</span>
            </div>
            <div class="trend-line">
              <span class="trend-label">SHORT:</span>
              <span class="trend-percentage" id="short-percentage-${symbol}">0%</span>
            </div>
          </div>
        </div>
        
        <div class="indicator">
          <div class="indicator-label-container">
            <div class="dot neutral" id="dot1-${symbol}"></div>
          <div class="indicator-label">EMA 9</div>
          </div>
          <div class="indicator-value" id="ema9-${symbol}">--</div>
        </div>
        
        <div class="indicator">
          <div class="indicator-label-container">
            <div class="dot neutral" id="dot2-${symbol}"></div>
          <div class="indicator-label">EMA 21</div>
          </div>
          <div class="indicator-value" id="ema21-${symbol}">--</div>
        </div>
        
        <div class="indicator">
          <div class="indicator-label-container">
            <div class="dot neutral" id="dot3-${symbol}"></div>
          <div class="indicator-label">EMA 50</div>
          </div>
          <div class="indicator-value" id="ema50-${symbol}">--</div>
        </div>
        
        <div class="indicator">
          <div class="indicator-label-container">
            <div class="dot neutral" id="rsi-dot-${symbol}"></div>
          <div class="indicator-label">RSI (14)</div>
          </div>
          <div class="indicator-value" id="rsi-${symbol}">--</div>
        </div>
        
        <div class="indicator">
          <div class="indicator-label-container">
            <div class="dot neutral" id="macd-dot-${symbol}"></div>
          <div class="indicator-label">MACD</div>
          </div>
          <div class="indicator-value" id="macd-${symbol}">--</div>
          <div class="macd-values" id="macd-details-${symbol}">
            <div class="macd-item">Signal: --</div>
            <div class="macd-item">Hist: --</div>
          </div>
        </div>
        
        <div class="indicator">
          <div class="indicator-label-container">
            <div class="dot neutral" id="atr-dot-${symbol}"></div>
          <div class="indicator-label">ATR (14)</div>
          </div>
          <div class="indicator-value" id="atr-${symbol}">--</div>
        </div>
        
        <div class="indicator">
          <div class="indicator-label-container">
            <div class="dot neutral" id="volume-dot-${symbol}"></div>
          <div class="indicator-label">Volume Ratio</div>
          </div>
          <div class="indicator-value" id="volume-ratio-${symbol}">--</div>
        </div>
        
        <div class="indicator">
          <div class="indicator-label-container">
            <div class="dot neutral" id="spread-dot-${symbol}"></div>
          <div class="indicator-label">Spread</div>
          </div>
          <div class="indicator-value" id="spread-${symbol}">--</div>
        </div>
        
        <div class="indicator liquidity">
          <div class="indicator-label-container">
            <div class="dot neutral" id="liquidity-dot-${symbol}"></div>
          <div class="indicator-label">Liquidity (±0.10%)</div>
          </div>
          <div class="indicator-value" id="liquidity-${symbol}">--</div>
        </div>
        
        <div class="indicator">
          <div class="indicator-label-container">
            <div class="dot neutral" id="bid-ask-dot-${symbol}"></div>
          <div class="indicator-label">Bid/Ask Ratio</div>
          </div>
          <div class="indicator-value" id="bid-ask-ratio-${symbol}">--</div>
        </div>
      `;
      
      return card;
    }


    function updateCryptoCard(symbol, data) {
      const priceEl = document.getElementById(`price-${symbol}`);
      const changeEl = document.getElementById(`change-${symbol}`);
      const highEl = document.getElementById(`high-${symbol}`);
      const lowEl = document.getElementById(`low-${symbol}`);
      const volumeEl = document.getElementById(`volume-${symbol}`);
      const timeEl = document.getElementById(`time-${symbol}`);
      const precisionEl = document.getElementById(`precision-${symbol}`);
      const rawEl = document.getElementById(`raw-${symbol}`);

      // Анимация изменения цены
      if (lastPrices[symbol] !== undefined) {
        priceEl.classList.remove('flash-green', 'flash-red');
        if (data.futures.price > lastPrices[symbol]) {
          priceEl.classList.add('flash-green');
        } else if (data.futures.price < lastPrices[symbol]) {
          priceEl.classList.add('flash-red');
        }
      }
      
      lastPrices[symbol] = data.futures.price;

      // Обновление данных
      priceEl.textContent = `$${data.futures.price.toLocaleString('en-US', { minimumFractionDigits: 5, maximumFractionDigits: 5 })}`;
      
      changeEl.textContent = `${data.futures.change24h >= 0 ? '+' : ''}${data.futures.change24h.toFixed(2)}%`;
      changeEl.className = `change ${data.futures.change24h >= 0 ? 'positive' : 'negative'}`;
      
      highEl.textContent = `$${data.futures.high24h.toLocaleString('en-US', { minimumFractionDigits: 5, maximumFractionDigits: 5 })}`;
      lowEl.textContent = `$${data.futures.low24h.toLocaleString('en-US', { minimumFractionDigits: 5, maximumFractionDigits: 5 })}`;
      volumeEl.textContent = `${(data.futures.volume24h / 1000).toFixed(1)}K ${symbol.replace('USDT', '')}`;
      timeEl.textContent = new Date().toLocaleTimeString('ru-RU');
      precisionEl.textContent = data.futures.price.toFixed(8);
      rawEl.textContent = data.futures.rawData;
    }

    function updateAnalyticsCard(symbol, data) {
      if (!data) return;

      // Отладочная информация
      console.log(`🔍 Updating analytics for ${symbol} (${data.timeframe || '15m'}):`, data);

      // Технические индикаторы
      if (data.analytics) {
        const analytics = data.analytics;
        
        // Обновляем LONG и SHORT проценты
        updateLongPercentage(symbol, analytics);
        updateShortPercentage(symbol, analytics);
        
        // Обновляем модуль "Подготовка сделки"
        updateDealPreparation(symbol, analytics);
        
        // EMA индикаторы
        updateIndicator(`ema9-${symbol}`, analytics.ema9, 'price');
        updateIndicator(`ema21-${symbol}`, analytics.ema21, 'price');
        updateIndicator(`ema50-${symbol}`, analytics.ema50, 'price');
        
          // Обновляем точки тренда
          updateTrendDots(symbol, analytics.isUptrend, analytics.isDowntrend, analytics.ema9_21Signal);
          
          // Обновляем Bid/Ask сигнал
          updateBidAskSignal(symbol, analytics);
          
          // Обновляем Volume сигнал
          updateVolumeSignal(symbol, analytics);
          
          // Обновляем RSI сигнал
          updateRsiSignal(symbol, analytics);
          
          // Обновляем Liquidity сигнал
          updateLiquiditySignal(symbol, analytics);
          
          // Обновляем MACD сигнал
          updateMacdSignal(symbol, analytics);
          
          // Обновляем ATR сигнал
          updateAtrSignal(symbol, analytics);
          
          // Обновляем Spread сигнал
          updateSpreadSignal(symbol, analytics);
        
        // MACD
        if (analytics.macd) {
          updateIndicator(`macd-${symbol}`, analytics.macd.macd, 'price');
          
          const macdDetails = document.getElementById(`macd-details-${symbol}`);
          if (macdDetails) {
            macdDetails.innerHTML = `
              <div class="macd-item">Signal: ${analytics.macd.signal ? analytics.macd.signal.toFixed(4) : '--'}</div>
              <div class="macd-item">Hist: ${analytics.macd.histogram ? analytics.macd.histogram.toFixed(4) : '--'}</div>
            `;
          }
        }
        
        // ATR
        updateIndicator(`atr-${symbol}`, analytics.atr, 'atr');
        
        // Volume Ratio
        updateIndicator(`volume-ratio-${symbol}`, analytics.volumeRatio, 'ratio');
      }
      
      // Данные стакана заявок
      if (data.orderBook) {
        updateIndicator(`spread-${symbol}`, data.orderBook.spreadPercent, 'spread');
        updateIndicator(`liquidity-${symbol}`, data.orderBook.totalLiquidity, 'liquidity');
        updateIndicator(`bid-ask-ratio-${symbol}`, data.orderBook.bidAskRatio, 'bid-ask-ratio');
      }
    }

    function updateLongPercentage(symbol, analytics) {
      const longPercentageEl = document.getElementById(`long-percentage-${symbol}`);
      if (!longPercentageEl) return;

      const percentage = analytics.longPercentage || 0;
      longPercentageEl.textContent = `${percentage}%`;
      
      if (percentage > 0) {
        longPercentageEl.classList.add('long-active');
      } else {
        longPercentageEl.classList.remove('long-active');
      }
    }

    function updateShortPercentage(symbol, analytics) {
      const shortPercentageEl = document.getElementById(`short-percentage-${symbol}`);
      if (!shortPercentageEl) return;

      const percentage = analytics.shortPercentage || 0;
      shortPercentageEl.textContent = `${percentage}%`;
      
      if (percentage > 0) {
        shortPercentageEl.classList.add('short-active');
      } else {
        shortPercentageEl.classList.remove('short-active');
      }
    }

    function updateDealPreparation(symbol, analytics) {
      // ⚠️ КРИТИЧЕСКАЯ ПРОВЕРКА: Если уже есть открытая позиция - не добавляем в подготовку
      const existingPosition = openPositions.find(pos => pos.symbol === symbol);
      if (existingPosition) {
        // Удаляем из подготовки если была
        if (dealPrepData[symbol]) {
          delete dealPrepData[symbol];
          removeDealCard(symbol);
          saveDealPrepData();
        }
        return;
      }
      
      // ⚠️ ПРОВЕРКА КУЛДАУНА: Если монета в кулдауне - не добавляем в подготовку
      if (isSymbolInCooldown(symbol)) {
        // Удаляем из подготовки если была
        if (dealPrepData[symbol]) {
          delete dealPrepData[symbol];
          removeDealCard(symbol);
          saveDealPrepData();
        }
        return;
      }
      
      // 🎯 КОНТРТРЕНДОВАЯ ТОРГОВЛЯ НА ЭКСТРЕМУМАХ RSI
      const rsi = analytics.rsi || 50;
      const currentPrice = lastPrices[symbol] || 0;
      const currentVolume = analytics.currentVolume || 0;
      const previousVolume = analytics.previousVolume || 0;
      const volumeRatio = (previousVolume > 0) ? (currentVolume / previousVolume) : 1;
      
      // Проверка баланса для контртрендовой торговли
      const requiredBalance = POSITION_SIZE_USD + (POSITION_SIZE_USD * FUTURES_TAKER_FEE);
      
      // SHORT на экстремальной перекупленности (RSI >= 78 + объем > 1.5x)
      if (rsi >= 78 && volumeRatio > 1.5 && currentPrice > 0 && currentBalance >= requiredBalance) {
        console.log(`⚡ ${symbol}: RSI ${rsi.toFixed(1)} >= 78 + объем ${(volumeRatio * 100).toFixed(0)}% → МОМЕНТАЛЬНЫЙ SHORT!`);
        openPosition(symbol, 'SHORT', currentPrice, POSITION_SIZE_USD, 85);
        return; // Выходим из функции
      }
      
      // LONG на экстремальной перепроданности (RSI <= 23 + объем > 1.5x)
      if (rsi <= 23 && volumeRatio > 1.5 && currentPrice > 0 && currentBalance >= requiredBalance) {
        console.log(`⚡ ${symbol}: RSI ${rsi.toFixed(1)} <= 23 + объем ${(volumeRatio * 100).toFixed(0)}% → МОМЕНТАЛЬНЫЙ LONG!`);
        openPosition(symbol, 'LONG', currentPrice, POSITION_SIZE_USD, 85);
        return; // Выходим из функции
      }
      
      // ⚠️ ПРОВЕРКА ФИЛЬТРОВ RSI и ATR для обычных сигналов
      const longPercentage = analytics.longPercentage || 0;
      const shortPercentage = analytics.shortPercentage || 0;
      
      if (longPercentage > shortPercentage) {
        // Проверяем фильтры для LONG
        if (!checkTradingFilters(symbol, 'LONG', analytics)) {
          // Удаляем из подготовки если была
          if (dealPrepData[symbol]) {
            delete dealPrepData[symbol];
            removeDealCard(symbol);
            saveDealPrepData();
          }
          return;
        }
      } else if (shortPercentage > longPercentage) {
        // Проверяем фильтры для SHORT
        if (!checkTradingFilters(symbol, 'SHORT', analytics)) {
          // Удаляем из подготовки если была
          if (dealPrepData[symbol]) {
            delete dealPrepData[symbol];
            removeDealCard(symbol);
            saveDealPrepData();
          }
          return;
        }
      }
      
      // Определяем направление сделки и процент уверенности
      let dealDirection = null;
      let confidence = 0;
      let matchedIndicators = 0;
      let totalActiveIndicators = 0;
      
      if (longPercentage >= 55) {
        dealDirection = 'buy';
        confidence = longPercentage;
        // Считаем совпадающие индикаторы для LONG (только активные, не нейтральные)
        if (analytics.ema9_21Signal === 'long') matchedIndicators++;
        if (analytics.macdSignal === 'long') matchedIndicators++;
        if (analytics.atrSignal === 'long') matchedIndicators++;
        if (analytics.rsiSignal && analytics.rsiSignal.includes('long')) matchedIndicators++;
        if (analytics.volumeSignal === 'long') matchedIndicators++;
        if (analytics.liquiditySignal === 'long') matchedIndicators++;
        if (analytics.bidAskSignal === 'long') matchedIndicators++;
        if (analytics.spreadSignal === 'long') matchedIndicators++;
        
        // Подсчитываем общее количество активных индикаторов (не нейтральных)
        if (analytics.ema9_21Signal !== 'neutral') totalActiveIndicators++;
        if (analytics.macdSignal !== 'neutral') totalActiveIndicators++;
        if (analytics.atrSignal !== 'neutral') totalActiveIndicators++;
        if (analytics.rsiSignal && analytics.rsiSignal !== 'neutral') totalActiveIndicators++;
        if (analytics.volumeSignal !== 'neutral') totalActiveIndicators++;
        if (analytics.liquiditySignal !== 'neutral') totalActiveIndicators++;
        if (analytics.bidAskSignal !== 'neutral') totalActiveIndicators++;
        if (analytics.spreadSignal !== 'neutral') totalActiveIndicators++;
      } else if (shortPercentage >= 55) {
        dealDirection = 'sell';
        confidence = shortPercentage;
        // Считаем совпадающие индикаторы для SHORT (только активные, не нейтральные)
        if (analytics.ema9_21Signal === 'short') matchedIndicators++;
        if (analytics.macdSignal === 'short') matchedIndicators++;
        if (analytics.atrSignal === 'short') matchedIndicators++;
        if (analytics.rsiSignal && analytics.rsiSignal.includes('short')) matchedIndicators++;
        if (analytics.volumeSignal === 'short') matchedIndicators++;
        if (analytics.liquiditySignal === 'short') matchedIndicators++;
        if (analytics.bidAskSignal === 'short') matchedIndicators++;
        if (analytics.spreadSignal === 'short') matchedIndicators++;
        
        // Подсчитываем общее количество активных индикаторов (не нейтральных)
        if (analytics.ema9_21Signal !== 'neutral') totalActiveIndicators++;
        if (analytics.macdSignal !== 'neutral') totalActiveIndicators++;
        if (analytics.atrSignal !== 'neutral') totalActiveIndicators++;
        if (analytics.rsiSignal && analytics.rsiSignal !== 'neutral') totalActiveIndicators++;
        if (analytics.volumeSignal !== 'neutral') totalActiveIndicators++;
        if (analytics.liquiditySignal !== 'neutral') totalActiveIndicators++;
        if (analytics.bidAskSignal !== 'neutral') totalActiveIndicators++;
        if (analytics.spreadSignal !== 'neutral') totalActiveIndicators++;
      }
      
      // Если есть направление сделки
      if (dealDirection) {
        // Если это новая сделка, инициализируем таймер
        if (!dealPrepData[symbol]) {
          // Определяем время таймера на основе уверенности
          const timerSeconds = confidence >= 65 ? 60 : 120; // 1 минута для высоких сигналов, 2 минуты для слабых
          
          dealPrepData[symbol] = {
            direction: dealDirection,
            confidence: confidence,
            price: currentPrice,
            timestamp: Date.now(),
            timerSeconds: timerSeconds,
            matchedIndicators: matchedIndicators,
            totalActiveIndicators: totalActiveIndicators
          };
          
          // Сохраняем в localStorage
          saveDealPrepData();
        } else {
          // Обновляем уверенность, цену и совпадения
          const oldConfidence = dealPrepData[symbol].confidence;
          dealPrepData[symbol].confidence = confidence;
          dealPrepData[symbol].price = currentPrice;
          dealPrepData[symbol].matchedIndicators = matchedIndicators;
          dealPrepData[symbol].totalActiveIndicators = totalActiveIndicators;
          
          // Если уверенность изменилась с низкой на высокую, обновляем таймер
          if (oldConfidence < 65 && confidence >= 65) {
            dealPrepData[symbol].timerSeconds = 60; // Переключаем на 1 минуту
            dealPrepData[symbol].timestamp = Date.now(); // Обновляем время начала
          } else if (oldConfidence >= 65 && confidence < 65) {
            dealPrepData[symbol].timerSeconds = 120; // Переключаем на 2 минуты
            dealPrepData[symbol].timestamp = Date.now(); // Обновляем время начала
          }
          
          // Сохраняем изменения
          saveDealPrepData();
        }
        
        // Создаем или обновляем карточку
        createOrUpdateDealCard(symbol, dealPrepData[symbol]);
      } else {
        // Проверяем, нужно ли удалить карточку (если уверенность упала ниже 50%)
        if (dealPrepData[symbol]) {
          const existingDirection = dealPrepData[symbol].direction;
          const currentConfidence = existingDirection === 'buy' ? longPercentage : shortPercentage;
          if (currentConfidence < 50) {
            removeDealCard(symbol);
            delete dealPrepData[symbol];
            // Сохраняем изменения
            saveDealPrepData();
          }
        }
      }
    }

    function createOrUpdateDealCard(symbol, dealData) {
      const config = cryptoConfig[symbol];
      if (!config) return;
      
      let card = document.getElementById(`deal-card-${symbol}`);
      
      if (!card) {
        // Создаем новую карточку
        card = document.createElement('div');
        card.className = 'deal-card';
        card.id = `deal-card-${symbol}`;
        dealPrepGrid.appendChild(card);
      }
      
      // Рассчитываем TP и SL
      const entryPrice = dealData.price;
      const tpPrice = dealData.direction === 'buy' ? 
        (entryPrice * 1.0025).toFixed(4) : 
        (entryPrice * 0.9975).toFixed(4);
      const slPrice = dealData.direction === 'buy' ? 
        (entryPrice * 0.9987).toFixed(4) : 
        (entryPrice * 1.0013).toFixed(4);
      
      const tpPercent = dealData.direction === 'buy' ? '+0.25%' : '-0.25%';
      const slPercent = dealData.direction === 'buy' ? '-0.13%' : '+0.13%';
      
      // Инициализируем таймер для отображения
      const timerSeconds = dealData.timerSeconds || (dealData.confidence >= 65 ? 60 : 120);
      const minutes = Math.floor(timerSeconds / 60);
      const seconds = timerSeconds % 60;
      const timerDisplay = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
      
      // Определяем цвет счетчика совпадений
      const matchedCount = dealData.matchedIndicators || 0;
      const totalActive = dealData.totalActiveIndicators || 8;
      let matchColor = '#ef4444'; // красный по умолчанию (0-3)
      if (matchedCount >= 6) {
        matchColor = '#10b981'; // зеленый (6+)
      } else if (matchedCount >= 4) {
        matchColor = '#f59e0b'; // оранжевый (4-5)
      }
      
      card.innerHTML = `
        <div class="deal-header">
          <div class="deal-symbol">${config.symbol} ${config.name}</div>
          <div class="deal-action ${dealData.direction}">${dealData.direction === 'buy' ? 'ЛОНГ' : 'ШОРТ'}</div>
          <div class="deal-match-count" style="color: ${matchColor}; font-weight: 600;">${matchedCount}/${totalActive}</div>
        </div>
        
        <div class="deal-timer ${dealData.confidence >= 65 ? 'fast-timer' : 'standard-timer'}" id="timer-${symbol}">
          <div class="timer-value" id="timer-value-${symbol}">${timerDisplay}</div>
        </div>

        <div class="deal-confidence">
          <div class="confidence-left">
            <div class="confidence-label">Уверенность</div>
            <div class="confidence-bar">
              <div class="confidence-fill ${dealData.confidence >= 70 ? 'high' : dealData.confidence >= 40 ? 'medium' : 'low'}" style="width: ${dealData.confidence}%"></div>
            </div>
          </div>
          <div class="confidence-percent">${dealData.confidence}%</div>
        </div>
        
      `;
    }

    function removeDealCard(symbol) {
      const card = document.getElementById(`deal-card-${symbol}`);
      if (card) {
        card.remove();
      }
    }

    // ============================================
    // UI функции для открытых сделок
    // ============================================
    
    function createOpenDealCard(position) {
      const container = document.querySelector('.open-deals-content');
      const config = cryptoConfig[position.symbol];
      if (!config) return;
      
      // Удаляем пустое сообщение если есть
      const emptyMsg = container.querySelector('.empty-state');
      if (emptyMsg) emptyMsg.remove();
      
      let card = document.getElementById(`open-deal-${position.id}`);
      
      if (!card) {
        card = document.createElement('div');
        card.className = 'open-deal-card';
        card.id = `open-deal-${position.id}`;
        container.appendChild(card);
      }
      
      const pnlClass = position.netPnL >= 0 ? 'profit' : 'loss';
      const pnlSign = position.netPnL >= 0 ? '+' : '';
      const pnlPercent = ((position.netPnL / position.amountUSD) * 100).toFixed(2);
      
      const directionClass = position.direction === 'LONG' ? 'long' : 'short';
      const directionText = position.direction === 'LONG' ? 'ЛОНГ' : 'ШОРТ';
      
      // Рассчитываем прогресс до TP/SL
      const distanceToTP = Math.abs(position.tpPrice - position.entryPrice);
      const distanceToSL = Math.abs(position.slPrice - position.entryPrice);
      const currentDistance = position.currentPrice - position.entryPrice;
      
      const tpProgress = position.direction === 'LONG'
        ? Math.min(100, Math.max(0, (currentDistance / distanceToTP) * 100))
        : Math.min(100, Math.max(0, ((position.entryPrice - position.currentPrice) / distanceToTP) * 100));
      
      const slProgress = position.direction === 'LONG'
        ? Math.min(100, Math.max(0, ((position.entryPrice - position.currentPrice) / distanceToSL) * 100))
        : Math.min(100, Math.max(0, (currentDistance / distanceToSL) * 100));
      
      card.innerHTML = `
        <div class="deal-left">
          <div class="deal-symbol">${config.symbol} ${config.name}</div>
          <div class="deal-action ${directionClass}">${directionText}</div>
        </div>
        
        <div class="deal-center">
          <div class="price-row">
            <span class="price-label">Вход:</span>
            <span class="price-value">$${position.entryPrice.toLocaleString('en-US', { minimumFractionDigits: 5, maximumFractionDigits: 5 })}</span>
          </div>
          <div class="price-row">
            <span class="price-label">Текущая:</span>
            <span class="price-value" id="current-price-${position.id}">$${position.currentPrice.toLocaleString('en-US', { minimumFractionDigits: 5, maximumFractionDigits: 5 })}</span>
          </div>
        </div>
        
        <div class="deal-pnl ${pnlClass}">
          <div class="pnl-main" id="pnl-main-${position.id}">
            ${pnlSign}$${position.netPnL.toFixed(2)}
          </div>
          <div class="pnl-percent">${pnlSign}${pnlPercent}%</div>
        </div>
        
        <div class="deal-targets">
          <div class="target-row tp">
            <span class="target-label">🎯</span>
            <span class="target-value">$${position.tpPrice.toLocaleString('en-US', { minimumFractionDigits: 5, maximumFractionDigits: 5 })}</span>
          </div>
          <div class="target-row sl">
            <span class="target-label">🛑</span>
            <span class="target-value">$${position.slPrice.toLocaleString('en-US', { minimumFractionDigits: 5, maximumFractionDigits: 5 })}</span>
          </div>
        </div>
        
        <div class="deal-right">
          <div class="deal-volume">$${position.amountUSD.toFixed(0)}</div>
          <div class="deal-time">${new Date(position.openTime).toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' })}</div>
        </div>
      `;
    }
    
    function updateOpenDealCardPrices(position) {
      const currentPriceEl = document.getElementById(`current-price-${position.id}`);
      const pnlMainEl = document.getElementById(`pnl-main-${position.id}`);
      const card = document.getElementById(`open-deal-${position.id}`);
      
      if (!card) return;
      
      if (currentPriceEl) {
        currentPriceEl.textContent = `$${position.currentPrice.toLocaleString('en-US', { minimumFractionDigits: 5, maximumFractionDigits: 5 })}`;
      }
      
      if (pnlMainEl) {
        const pnlSign = position.netPnL >= 0 ? '+' : '';
        pnlMainEl.textContent = `${pnlSign}$${position.netPnL.toFixed(2)}`;
        
        // Обновляем класс PnL блока
        const pnlBlock = pnlMainEl.closest('.deal-pnl');
        if (pnlBlock) {
          pnlBlock.className = `deal-pnl ${position.netPnL >= 0 ? 'profit' : 'loss'}`;
        }
        
        // Обновляем процент
        const pnlPercentEl = pnlBlock.querySelector('.pnl-percent');
        if (pnlPercentEl) {
          const pnlPercent = ((position.netPnL / position.amountUSD) * 100).toFixed(2);
          pnlPercentEl.textContent = `${pnlSign}${pnlPercent}%`;
        }
      }
    }
    
    function removeOpenDealCard(positionId) {
      const card = document.getElementById(`open-deal-${positionId}`);
      if (card) {
        card.remove();
      }
      
      // Если нет открытых сделок, показываем пустое сообщение
      const container = document.querySelector('.open-deals-content');
      if (container && container.children.length === 0) {
        container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">📭</div><div class="empty-state-text">Нет открытых сделок</div></div>';
      }
    }
    // ============================================

      function updateTrendDots(symbol, isUptrend, isDowntrend, ema9_21Signal) {
        const dot1 = document.getElementById(`dot1-${symbol}`);
        const dot2 = document.getElementById(`dot2-${symbol}`);
        const dot3 = document.getElementById(`dot3-${symbol}`);
        
        if (!dot1 || !dot2 || !dot3) return;
      
        if (isUptrend) {
          // Зеленые точки для восходящего тренда (все три EMA)
          dot1.className = 'dot green';
          dot2.className = 'dot green';
          dot3.className = 'dot green';
        } else if (isDowntrend) {
          // Красные точки для нисходящего тренда (все три EMA)
          dot1.className = 'dot red';
          dot2.className = 'dot red';
          dot3.className = 'dot red';
        } else {
          // EMA 50 нейтральная, но проверяем EMA 9/21
          if (ema9_21Signal === 'long') {
            // EMA 9 > EMA 21 → зеленые EMA 9 и 21, серая EMA 50
            dot1.className = 'dot green';
            dot2.className = 'dot green';
            dot3.className = 'dot neutral';
          } else if (ema9_21Signal === 'short') {
            // EMA 9 < EMA 21 → красные EMA 9 и 21, серая EMA 50
            dot1.className = 'dot red';
            dot2.className = 'dot red';
            dot3.className = 'dot neutral';
          } else {
            // Все серые
            dot1.className = 'dot neutral';
            dot2.className = 'dot neutral';
            dot3.className = 'dot neutral';
          }
        }
      }

      function updateBidAskSignal(symbol, analytics) {
        const bidAskDot = document.getElementById(`bid-ask-dot-${symbol}`);
        if (!bidAskDot) return;
      
        const signal = analytics.bidAskSignal || 'neutral';
        const ratio = analytics.bidAskRatio || 1.0;
        
        // Bid/Ask - ромбики (borderRadius: 2px + rotate 45deg)
        bidAskDot.style.borderRadius = '2px';
        bidAskDot.style.transform = 'rotate(45deg)';
        
        // Обновляем цвет ромба в зависимости от силы сигнала
        switch (signal) {
          case 'long':
            // Зелёный ромб - устойчивое доминирование покупателей (2.0x-5.0x)
            bidAskDot.className = 'dot green';
            bidAskDot.innerHTML = '';
            break;
          case 'short':
            // Красный ромб - явный перекос в сторону продавцов (0.10x-0.90x)
            bidAskDot.className = 'dot red';
            bidAskDot.innerHTML = '';
            break;
          case 'volatile':
            // Волатильность - красный крестик (резкий скачок > 1.0)
            bidAskDot.className = 'dot volatile';
            bidAskDot.innerHTML = '✕';
            break;
          default:
            // Серый кружок - нет сильного дисбаланса
            bidAskDot.className = 'dot neutral';
            bidAskDot.innerHTML = '';
        }
        
        // Обновляем значение Bid/Ask Ratio с дополнительной информацией
        const bidAskElement = document.getElementById(`bid-ask-ratio-${symbol}`);
        if (bidAskElement) {
          let displayText = `${ratio.toFixed(2)}x`;
          if (analytics.bidAskConfidence > 0) {
            displayText += ` (+${analytics.bidAskConfidence}%)`;
          }
          bidAskElement.textContent = displayText;
        }
      }

      function updateVolumeSignal(symbol, analytics) {
        const volumeDot = document.getElementById(`volume-dot-${symbol}`);
        if (!volumeDot) return;
      
        const signal = analytics.volumeSignal || 'neutral';
        const ratio = analytics.volumeRatio;
        
        // Volume - квадратики (borderRadius: 2px)
        volumeDot.style.borderRadius = '2px';
        volumeDot.style.transform = 'none';
        
        // Обновляем цвет квадрата в зависимости от силы сигнала
        switch (signal) {
          case 'long-weak':
            // Зелёный квадрат - объем растет (1.5-1.99)
            volumeDot.className = 'dot green';
            volumeDot.innerHTML = '';
            break;
          case 'long-strong':
            // Зелёный квадрат - сильный рост объема (2.0-2.99)
            volumeDot.className = 'dot green';
            volumeDot.innerHTML = '';
            break;
          case 'short-weak':
            // Красный кружок - объем падает (< 0.7)
            volumeDot.className = 'dot red';
            volumeDot.innerHTML = '';
            break;
          case 'short-strong':
            // Красный кружок - сильное падение объема (< 0.5)
            volumeDot.className = 'dot red';
            volumeDot.innerHTML = '';
            break;
          case 'caution':
            // Желтый кружок - осторожность (3.0-19.99)
            volumeDot.className = 'dot caution';
            volumeDot.innerHTML = '';
            break;
          case 'anomaly':
            // Красный крестик - аномалия (> 19.99)
            volumeDot.className = 'dot anomaly';
            volumeDot.innerHTML = '✕';
            break;
          case 'critical':
            // Красный крестик с надписью АНОМАЛИЯ (≥ 20.0)
            volumeDot.className = 'dot anomaly';
            volumeDot.innerHTML = '✕';
            break;
          default:
            // Серый кружок - стабильный объем (0.7-1.5)
            volumeDot.className = 'dot neutral';
            volumeDot.innerHTML = '';
        }
        
        // Обновляем значение Volume Ratio
        const volumeElement = document.getElementById(`volume-ratio-${symbol}`);
        if (volumeElement) {
          if (ratio !== null) {
            let displayText = ratio.toFixed(2);
            
            if (signal === 'critical') {
              displayText = 'АНОМАЛИЯ';
            } else if (analytics.volumeConfidence > 0) {
              displayText += ` (+${analytics.volumeConfidence}%)`;
            }
            
            volumeElement.textContent = displayText;
          } else {
            volumeElement.textContent = '--';
          }
        }
      }

      function updateRsiSignal(symbol, analytics) {
        const rsiDot = document.getElementById(`rsi-dot-${symbol}`);
        if (!rsiDot) return;
      
        const signal = analytics.rsiSignal || 'neutral';
        const rsi = analytics.rsi || 50;
        
        // RSI - квадратики (borderRadius: 2px)
        rsiDot.style.borderRadius = '2px';
        rsiDot.style.transform = 'none';
        
        // Обновляем цвет квадрата в зависимости от силы сигнала
        switch (signal) {
          case 'long-extreme':
            // Зелёный квадрат - экстремальная перепроданность (15-30)
            rsiDot.className = 'dot green';
            rsiDot.innerHTML = '';
            break;
          case 'long-strong':
            // Зелёный квадрат - сильная перепроданность (30-40)
            rsiDot.className = 'dot green';
            rsiDot.innerHTML = '';
            break;
          case 'long-weak':
            // Зелёный кружок - умеренная перепроданность (40-50)
            rsiDot.className = 'dot green';
            rsiDot.innerHTML = '';
            break;
          case 'short-weak':
            // Красный кружок - умеренная перекупленность (60-70)
            rsiDot.className = 'dot red';
            rsiDot.innerHTML = '';
            break;
          case 'short-strong':
            // Красный кружок - сильная перекупленность (70-80)
            rsiDot.className = 'dot red';
            rsiDot.innerHTML = '';
            break;
          case 'short-extreme':
            // Красный кружок - экстремальная перекупленность (80-100)
            rsiDot.className = 'dot red';
            rsiDot.innerHTML = '';
            break;
          default:
            // Серый кружок - нейтральная зона (50-60 и < 15)
            rsiDot.className = 'dot neutral';
            rsiDot.innerHTML = '';
        }
        
        // Обновляем значение RSI
        const rsiElement = document.getElementById(`rsi-${symbol}`);
        if (rsiElement) {
          let displayText = rsi.toFixed(2);
          
          if (analytics.rsiConfidence > 0) {
            displayText += ` (+${analytics.rsiConfidence}%)`;
          }
          
          rsiElement.textContent = displayText;
        }
      }

      function updateLiquiditySignal(symbol, analytics) {
        const liquidityDot = document.getElementById(`liquidity-dot-${symbol}`);
        if (!liquidityDot) return;
      
        const signal = analytics.liquiditySignal || 'neutral';
        const ratio = analytics.liquidityRatio;
        
        // Liquidity - ромбики (borderRadius: 2px + rotate 45deg)
        liquidityDot.style.borderRadius = '2px';
        liquidityDot.style.transform = 'rotate(45deg)';
        
        // Обновляем цвет ромба в зависимости от сигнала
        switch (signal) {
          case 'long':
            // Зелёный ромб - ликвидность растет (>= 1.15)
            liquidityDot.className = 'dot green';
            liquidityDot.innerHTML = '';
            break;
          case 'short':
            // Красный ромб - ликвидность падает (< 0.85)
            liquidityDot.className = 'dot red';
            liquidityDot.innerHTML = '';
            break;
          default:
            // Серый кружок - стабильная ликвидность (0.85-1.15)
            liquidityDot.className = 'dot neutral';
            liquidityDot.innerHTML = '';
        }
        
        // Обновляем значение Liquidity
        const liquidityElement = document.getElementById(`liquidity-${symbol}`);
        if (liquidityElement && analytics.orderBook) {
          const liq = analytics.orderBook.totalLiquidity;
          let displayText = liq >= 1000000 
            ? `$${(liq / 1000000).toFixed(2)}M` 
            : `$${(liq / 1000).toFixed(0)}k`;
          
          if (ratio !== null) {
            displayText += ` (${ratio.toFixed(2)})`;
          }
          
          if (analytics.liquidityConfidence > 0) {
            displayText += ` +${analytics.liquidityConfidence}%`;
          }
          
          liquidityElement.textContent = displayText;
        }
      }

      function updateMacdSignal(symbol, analytics) {
        const macdDot = document.getElementById(`macd-dot-${symbol}`);
        if (!macdDot) return;
      
        const signal = analytics.macdSignal || 'neutral';
        const confidence = analytics.macdConfidence || 0;
        
        // Обновляем цвет кружка в зависимости от сигнала
        switch (signal) {
          case 'long':
            // Зелёный кружок - MACD > Signal (momentum растет)
            macdDot.className = 'dot green';
            macdDot.innerHTML = '';
            break;
          case 'short':
            // Красный кружок - MACD < Signal (momentum падает)
            macdDot.className = 'dot red';
            macdDot.innerHTML = '';
            break;
          default:
            // Серый кружок - нейтральный сигнал
            macdDot.className = 'dot neutral';
            macdDot.innerHTML = '';
        }
      }

      function updateAtrSignal(symbol, analytics) {
        const atrDot = document.getElementById(`atr-dot-${symbol}`);
        if (!atrDot) {
          console.log(`ATR dot not found for ${symbol}`);
          return;
        }
      
        const signal = analytics.atrSignal || 'neutral';
        const confidence = analytics.atrConfidence || 0;
        
        console.log(`ATR ${symbol}: signal=${signal}, confidence=${confidence}, atr=${analytics.atr}`);
        
        // ATR - ромбики (borderRadius: 2px + rotate 45deg)
        atrDot.style.borderRadius = '2px';
        atrDot.style.transform = 'rotate(45deg)';
        
        // Обновляем цвет ромба в зависимости от сигнала
        switch (signal) {
          case 'long':
            // Зелёный ромб - ATR в диапазоне + EMA в LONG
            atrDot.className = 'dot green';
            atrDot.innerHTML = '';
            break;
          case 'short':
            // Красный ромб - ATR в диапазоне + EMA в SHORT
            atrDot.className = 'dot red';
            atrDot.innerHTML = '';
            break;
          default:
            // Серый ромб - ATR вне диапазона или EMA нейтральны
            atrDot.className = 'dot neutral';
            atrDot.innerHTML = '';
        }
        
        console.log(`ATR ${symbol} dot updated: ${signal} color`);
      }
      
      function updateSpreadSignal(symbol, analytics) {
        const spreadDot = document.getElementById(`spread-dot-${symbol}`);
        if (!spreadDot) {
          console.log(`Spread dot not found for ${symbol}`);
          return;
        }
      
        const signal = analytics.spreadSignal || 'neutral';
        const confidence = analytics.spreadConfidence || 0;
        
        console.log(`Spread ${symbol}: signal=${signal}, confidence=${confidence}`);
        
        // Spread - ромбики (borderRadius: 2px + rotate 45deg)
        spreadDot.style.borderRadius = '2px';
        spreadDot.style.transform = 'rotate(45deg)';
        
        // Обновляем цвет ромба в зависимости от сигнала
        switch (signal) {
          case 'long':
            // Зелёный ромб - узкий спред (хорошие условия)
            spreadDot.className = 'dot green';
            spreadDot.innerHTML = '';
            break;
          case 'short':
            // Красный ромб - широкий спред (плохие условия)
            spreadDot.className = 'dot red';
            spreadDot.innerHTML = '';
            break;
          default:
            // Серый ромб - нормальный спред
            spreadDot.className = 'dot neutral';
            spreadDot.innerHTML = '';
        }
        
        console.log(`Spread ${symbol} dot updated: ${signal} color`);
    }

    function updateIndicator(elementId, value, type) {
      const element = document.getElementById(elementId);
      if (!element || value === null || value === undefined) return;

      let formattedValue = '--';
      let cssClass = 'neutral';

      switch (type) {
        case 'price':
          formattedValue = `$${value.toFixed(4)}`;
          break;
        case 'rsi':
          formattedValue = value.toFixed(2);
          if (value > 70) cssClass = 'negative'; // Перекупленность
          else if (value < 30) cssClass = 'positive'; // Перепроданность
          else cssClass = 'neutral';
          break;
        case 'ratio':
          formattedValue = value.toFixed(2) + 'x';
          if (value > 1.2) cssClass = 'positive'; // Высокий объем
          else if (value < 0.8) cssClass = 'negative'; // Низкий объем
          else cssClass = 'neutral';
          break;
        case 'spread':
          formattedValue = value.toFixed(4) + '%';
          cssClass = value < 0.1 ? 'positive' : (value < 0.5 ? 'neutral' : 'negative');
          break;
        case 'liquidity':
          // Форматируем большие числа с разделителями тысяч и символом $
          if (value >= 1000000) {
            formattedValue = '$' + (value / 1000000).toFixed(1) + 'M';
          } else if (value >= 1000) {
            formattedValue = '$' + (value / 1000).toFixed(1) + 'K';
          } else {
            formattedValue = '$' + value.toFixed(0);
          }
          cssClass = 'neutral';
          break;
        case 'atr':
          // Специальная обработка для ATR с большей точностью
          formattedValue = value.toFixed(5);
          cssClass = 'neutral';
          break;
        case 'bid-ask-ratio': // Special case for Bid/Ask Ratio
          formattedValue = value.toFixed(2) + 'x';
          // Красный цвет для экстремальных значений (< 0.8 или > 2.0)
          if (value < 0.8 || value > 2.0) {
            cssClass = 'negative';
          } else {
            cssClass = 'neutral';
          }
          break;
        default:
          formattedValue = value.toFixed(4);
      }

      element.textContent = formattedValue;
      element.className = `indicator-value ${cssClass}`;
    }

    function updateSignalCard(symbol, data) {
      const analytics = data.analytics;
      const orderBook = data.orderBook;
      const spotPrice = data.spot.price;
      
      if (!analytics || !orderBook) return;

      console.log(`🎯 Calculating signal for ${symbol}:`, {
        ema9: analytics.ema9,
        ema21: analytics.ema21,
        ema50: analytics.ema50,
        rsi: analytics.rsi,
        macd: analytics.macd,
        volumeRatio: analytics.volumeRatio
      });

      // Расчет confidence для LONG
      let longScore = 0;

      // EMA структура (20 баллов)
      if (analytics.ema9 > analytics.ema21 && analytics.ema21 > analytics.ema50) {
        longScore += 20;
      }

      // MACD (15 баллов)
      if (analytics.macd && analytics.macd.macd > analytics.macd.signal && analytics.macd.histogram > 0) {
        longScore += 15;
      }

      // RSI (10 баллов)
      if (analytics.rsi >= 45 && analytics.rsi <= 70) {
        longScore += 10;
      } else if ((analytics.rsi >= 40 && analytics.rsi < 45) || (analytics.rsi > 70 && analytics.rsi <= 75)) {
        longScore += 5;
      }

      // Volume Ratio (15 баллов)
      if (analytics.volumeRatio >= 1.30) {
        longScore += 15;
      } else if (analytics.volumeRatio >= 1.00) {
        longScore += 8;
      }

      // Бонусы
      if (analytics.volumeRatio >= 1.50) {
        longScore += 10;
      }

      // Расчет confidence для SHORT
      let shortScore = 0;

      // EMA структура (20 баллов)
      if (analytics.ema9 < analytics.ema21 && analytics.ema21 < analytics.ema50) {
        shortScore += 20;
      }

      // MACD (15 баллов)
      if (analytics.macd && analytics.macd.macd < analytics.macd.signal && analytics.macd.histogram < 0) {
        shortScore += 15;
      }

      // RSI (10 баллов)
      if (analytics.rsi >= 25 && analytics.rsi <= 55) {
        shortScore += 10;
      } else if ((analytics.rsi >= 20 && analytics.rsi < 25) || (analytics.rsi > 55 && analytics.rsi <= 60)) {
        shortScore += 5;
      }

      // Volume Ratio (15 баллов)
      if (analytics.volumeRatio >= 1.40) {
        shortScore += 15;
      } else if (analytics.volumeRatio >= 1.10) {
        shortScore += 8;
      }

      // Бонусы
      if (analytics.volumeRatio >= 1.50) {
        shortScore += 10;
      }

      // Определяем сигнал
      let signal = 'HOLD';
      let confidence = 0;
      let tpPercent = 0;
      let slPercent = 0;

      console.log(`📊 ${symbol} Scores: LONG=${longScore}, SHORT=${shortScore}`);

      if (longScore >= 50) {
        signal = 'BUY';
        confidence = longScore;
        tpPercent = 0.25;
        slPercent = -0.13;
      } else if (shortScore >= 60) {
        signal = 'SELL';
        confidence = shortScore;
        tpPercent = -0.25;
        slPercent = 0.15;
      } else {
        confidence = Math.max(longScore, shortScore);
      }

      console.log(`🎯 ${symbol} Signal: ${signal}, Confidence: ${confidence}%`);

      // Рассчитываем уровни входа, TP, SL
      const entryPrice = spotPrice;
      const tpPrice = entryPrice * (1 + tpPercent / 100);
      const slPrice = entryPrice * (1 + slPercent / 100);
      const riskReward = Math.abs(tpPercent / slPercent);

      // Обновляем UI
      const badgeEl = document.getElementById(`signal-badge-${symbol}`);
      const confidenceValueEl = document.getElementById(`confidence-value-${symbol}`);
      const confidenceFillEl = document.getElementById(`confidence-fill-${symbol}`);
      const entryEl = document.getElementById(`entry-${symbol}`);
      const tpEl = document.getElementById(`tp-${symbol}`);
      const slEl = document.getElementById(`sl-${symbol}`);
      const rrEl = document.getElementById(`rr-${symbol}`);

      if (badgeEl) {
        badgeEl.textContent = signal;
        badgeEl.className = `signal-badge ${signal.toLowerCase()}`;
      }

      if (confidenceValueEl) {
        confidenceValueEl.textContent = `${confidence}%`;
      }

      if (confidenceFillEl) {
        confidenceFillEl.style.width = `${confidence}%`;
        if (confidence >= 70) {
          confidenceFillEl.className = 'confidence-fill high';
        } else if (confidence >= 40) {
          confidenceFillEl.className = 'confidence-fill medium';
        } else {
          confidenceFillEl.className = 'confidence-fill low';
        }
      }

      if (entryEl) {
        entryEl.textContent = `$${entryPrice.toFixed(4)}`;
      }

      if (tpEl && signal !== 'HOLD') {
        tpEl.textContent = `$${tpPrice.toFixed(4)} (${tpPercent > 0 ? '+' : ''}${tpPercent.toFixed(2)}%)`;
      }

      if (slEl && signal !== 'HOLD') {
        slEl.textContent = `$${slPrice.toFixed(4)} (${slPercent > 0 ? '+' : ''}${slPercent.toFixed(2)}%)`;
      }

      if (rrEl && signal !== 'HOLD') {
        rrEl.textContent = `1:${riskReward.toFixed(1)}`;
      }
    }

    // ============================================
    // История сделок - модальное окно
    // ============================================
    let currentPage = 1;
    const itemsPerPage = 10;
    const maxPages = 10;
    
    function openHistoryModal() {
      const modal = document.getElementById('history-modal');
      modal.classList.add('show');
      currentPage = 1;
      renderHistoryPage();
    }
    
    function closeHistoryModal() {
      const modal = document.getElementById('history-modal');
      modal.classList.remove('show');
    }
    
    function renderHistoryPage() {
      const modalBody = document.getElementById('modal-body');
      const paginationInfo = document.getElementById('pagination-info');
      const pagination = document.getElementById('pagination');
      
      // Сортируем сделки (последние первыми)
      const sortedDeals = [...closedDeals].reverse();
      
      // Если нет сделок
      if (sortedDeals.length === 0) {
        modalBody.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">📊</div>
            <div class="empty-state-text">История сделок пока пуста</div>
            <p style="margin-top: 10px; color: #a0aec0; font-size: 14px;">Закрытые сделки будут отображаться здесь</p>
          </div>
        `;
        paginationInfo.textContent = 'Показано 0-0 из 0';
        pagination.innerHTML = '';
        return;
      }
      
      // Расчет пагинации
      const totalPages = Math.min(Math.ceil(sortedDeals.length / itemsPerPage), maxPages);
      const startIndex = (currentPage - 1) * itemsPerPage;
      const endIndex = Math.min(startIndex + itemsPerPage, sortedDeals.length, maxPages * itemsPerPage);
      const pageDeals = sortedDeals.slice(startIndex, endIndex);
      
      // Рендерим таблицу
      modalBody.innerHTML = `
        <table class="deals-table">
          <thead>
            <tr>
              <th>Монета</th>
              <th>Направление</th>
              <th>Вход</th>
              <th>Выход</th>
              <th>PnL</th>
              <th>%</th>
              <th>Время закрытия</th>
              <th>Длительность</th>
            </tr>
          </thead>
          <tbody>
            ${pageDeals.map(deal => {
              const duration = formatDuration(deal.duration);
              const closeTime = new Date(deal.closeTime).toLocaleString('ru-RU', {
                day: '2-digit',
                month: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
              });
              
              const pnlClass = deal.realizedPnL >= 0 ? 'positive' : 'negative';
              const pnlSign = deal.realizedPnL >= 0 ? '+' : '';
              
              return `
                <tr>
                  <td><div class="deal-symbol">${deal.symbol.replace('USDT', '')}</div></td>
                  <td><span class="deal-direction ${deal.direction.toLowerCase()}">${deal.direction}</span></td>
                  <td>$${deal.entryPrice.toFixed(5)}</td>
                  <td>$${deal.exitPrice.toFixed(5)}</td>
                  <td><div class="deal-pnl ${pnlClass}">${pnlSign}$${deal.realizedPnL.toFixed(2)}</div></td>
                  <td><div class="deal-pnl ${pnlClass}">${pnlSign}${deal.profitPercent.toFixed(2)}%</div></td>
                  <td>${closeTime}</td>
                  <td>${duration}</td>
                </tr>
              `;
            }).join('')}
          </tbody>
        </table>
      `;
      
      // Обновляем информацию о пагинации
      const displayedTo = Math.min(endIndex, maxPages * itemsPerPage);
      paginationInfo.textContent = `Показано ${startIndex + 1}-${displayedTo} из ${Math.min(sortedDeals.length, maxPages * itemsPerPage)}`;
      
      // Рендерим кнопки пагинации
      let paginationHTML = `
        <button class="pagination-btn" onclick="goToPage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>‹</button>
      `;
      
      for (let i = 1; i <= totalPages; i++) {
        paginationHTML += `
          <button class="pagination-btn ${i === currentPage ? 'active' : ''}" onclick="goToPage(${i})">${i}</button>
        `;
      }
      
      paginationHTML += `
        <button class="pagination-btn" onclick="goToPage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>›</button>
      `;
      
      pagination.innerHTML = paginationHTML;
    }
    
    function goToPage(page) {
      const totalPages = Math.min(Math.ceil(closedDeals.length / itemsPerPage), maxPages);
      if (page < 1 || page > totalPages) return;
      currentPage = page;
      renderHistoryPage();
    }
    
    function formatDuration(ms) {
      const seconds = Math.floor(ms / 1000);
      const minutes = Math.floor(seconds / 60);
      const hours = Math.floor(minutes / 60);
      
      if (hours > 0) {
        return `${hours}ч ${minutes % 60}м`;
      } else if (minutes > 0) {
        return `${minutes}м ${seconds % 60}с`;
      } else {
        return `${seconds}с`;
      }
    }
    
    // ============================================
    // Автоторговля и настройки
    // ============================================
    
    // Переключатель AUTO/MANUAL
    document.getElementById('auto-toggle').addEventListener('click', function() {
      isAutoTradingEnabled = !isAutoTradingEnabled;
      const toggle = this;
      const status = document.getElementById('toggle-status');
      
      if (isAutoTradingEnabled) {
        toggle.classList.add('active');
        status.textContent = 'AUTO';
        status.classList.remove('manual');
        status.classList.add('auto');
        console.log('🤖 Автоторговля ВКЛЮЧЕНА');
      } else {
        toggle.classList.remove('active');
        status.textContent = 'MANUAL';
        status.classList.remove('auto');
        status.classList.add('manual');
        console.log('✋ Ручной режим');
      }
      
      // Сохраняем настройку
      localStorage.setItem('autoTrading', isAutoTradingEnabled);
    });
    
    // Загрузка настройки автоторговли
    const savedAutoTrading = localStorage.getItem('autoTrading');
    if (savedAutoTrading === 'true') {
      document.getElementById('auto-toggle').click();
    }
    
    // ============================================
    // Таймер до следующей свечи
    // ============================================
    function getTimeToNextCandle() {
      const now = new Date();
      const minutes = now.getMinutes();
      const seconds = now.getSeconds();
      
      // Найти следующую отметку: 00, 15, 30, 45
      let nextMark;
      if (minutes < 15) {
        nextMark = 15;
      } else if (minutes < 30) {
        nextMark = 30;
      } else if (minutes < 45) {
        nextMark = 45;
      } else {
        nextMark = 60; // Следующий час
      }
      
      const minutesToNext = nextMark - minutes;
      const secondsToNext = 60 - seconds;
      
      const totalSeconds = (minutesToNext - 1) * 60 + secondsToNext;
      
      const mins = Math.floor(totalSeconds / 60);
      const secs = totalSeconds % 60;
      
      return `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
    }
    
    // Обновляем таймер каждую секунду
    setInterval(() => {
      document.getElementById('candle-timer').textContent = getTimeToNextCandle();
    }, 1000);
    
    // Инициализируем таймер
    document.getElementById('candle-timer').textContent = getTimeToNextCandle();
    
    // ============================================
    // Статистика за сегодня
    // ============================================
    function updateTodayStats() {
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      
      const todayDeals = closedDeals.filter(deal => {
        const dealDate = new Date(deal.closeTime);
        dealDate.setHours(0, 0, 0, 0);
        return dealDate.getTime() === today.getTime();
      });
      
      const todayProfitable = todayDeals.filter(d => d.realizedPnL > 0).length;
      const todayWinRate = todayDeals.length > 0 ? (todayProfitable / todayDeals.length * 100) : 0;
      const todayPnL = todayDeals.reduce((sum, d) => sum + d.realizedPnL, 0);
      
      document.getElementById('today-deals').textContent = todayDeals.length;
      document.getElementById('today-wr').textContent = `${todayWinRate.toFixed(0)}%`;
      
      const pnlEl = document.getElementById('today-pnl');
      const sign = todayPnL >= 0 ? '+' : '';
      pnlEl.textContent = `${sign}$${Math.abs(todayPnL).toFixed(0)}`;
    }
    
    // ============================================
    // Переключатель темы
    // ============================================
    document.getElementById('theme-toggle').addEventListener('click', function() {
      isDarkTheme = !isDarkTheme;
      const icon = document.getElementById('theme-icon');
      
      if (isDarkTheme) {
        document.body.classList.add('dark-theme');
        icon.textContent = '☀️';
        console.log('🌙 Темная тема');
      } else {
        document.body.classList.remove('dark-theme');
        icon.textContent = '🌙';
        console.log('☀️ Светлая тема');
      }
      
      // Сохраняем настройку
      localStorage.setItem('darkTheme', isDarkTheme);
    });
    
    // Загрузка настройки темы
    const savedTheme = localStorage.getItem('darkTheme');
    if (savedTheme === 'true') {
      document.getElementById('theme-toggle').click();
    }
    
    // Обработчики событий
    document.getElementById('history-toggle').addEventListener('click', openHistoryModal);
    document.getElementById('modal-close').addEventListener('click', closeHistoryModal);
    
    // Закрытие при клике на оверлей
    document.getElementById('history-modal').addEventListener('click', function(e) {
      if (e.target === this) {
        closeHistoryModal();
      }
    });
    
    // Обработчик клика для открытия/закрытия статистики
    document.getElementById('stats-toggle').addEventListener('click', function(e) {
      e.stopPropagation();
      const dropdown = document.getElementById('stats-dropdown');
      const icon = document.getElementById('stats-icon');
      
      dropdown.classList.toggle('show');
      icon.classList.toggle('open');
    });

    // Закрытие при клике вне меню
    document.addEventListener('click', function(e) {
      const dropdown = document.getElementById('stats-dropdown');
      const toggle = document.getElementById('stats-toggle');
      const icon = document.getElementById('stats-icon');
      
      if (!toggle.contains(e.target)) {
        dropdown.classList.remove('show');
        icon.classList.remove('open');
      }
    });

    ws.onopen = () => {
      console.log('✅ Подключено к серверу');
    };

    // Функция обновления таймеров
    function updateTimers() {
      Object.keys(dealPrepData).forEach(symbol => {
        const deal = dealPrepData[symbol];
        if (deal && deal.timerSeconds !== undefined && deal.timerSeconds > 0) {
          deal.timerSeconds--;
          
          // Обновляем отображение таймера
          const timerValueEl = document.getElementById(`timer-value-${symbol}`);
          if (timerValueEl) {
            const minutes = Math.floor(deal.timerSeconds / 60);
            const seconds = deal.timerSeconds % 60;
            timerValueEl.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            
            // Обновляем шкалу уверенности с правильным цветом
            const confidenceFillEl = document.querySelector(`#timer-${symbol}`).parentElement.querySelector('.confidence-fill');
            const confidencePercentEl = document.querySelector(`#timer-${symbol}`).parentElement.querySelector('.confidence-percent');
            if (confidenceFillEl) {
              const confidence = deal.confidence;
              confidenceFillEl.className = `confidence-fill ${confidence >= 70 ? 'high' : confidence >= 40 ? 'medium' : 'low'}`;
              confidenceFillEl.style.width = `${confidence}%`;
            }
            if (confidencePercentEl) {
              confidencePercentEl.textContent = `${deal.confidence}%`;
            }
          }
          
          // Когда таймер истек
          if (deal.timerSeconds === 0) {
            console.log(`⏰ Время вышло для ${symbol}. Открываем сделку автоматически!`);
            
            // Автоматически открываем сделку
            autoOpenDeal(symbol, deal);
          }
        }
      });
    }

    // Запускаем обновление таймеров каждую секунду
    setInterval(updateTimers, 1000);
    
    // Запускаем СУПЕР ЧУВСТВИТЕЛЬНЫЙ мониторинг TP/SL каждые 100мс
    setInterval(() => {
      if (openPositions.length > 0) {
        // Получаем последние данные из lastPrices в правильном формате
        const currentData = {};
        openPositions.forEach(position => {
          const symbol = position.symbol;
          if (lastPrices[symbol]) {
            currentData[symbol] = {
              futures: { price: lastPrices[symbol] }
            };
          }
        });
        
        if (Object.keys(currentData).length > 0) {
          updateOpenPositionsPrices(currentData);
        }
      }
    }, 100); // 100мс = 10 раз в секунду!
    
    // Загружаем сохраненные данные при загрузке страницы
    loadDealPrepData();
    loadDealData();
    
    // Функция очистки всех данных
    window.clearAllData = function() {
      const confirmClear = confirm(`🗑️ ОЧИСТИТЬ ВСЕ ДАННЫЕ?\n\nЭто удалит:\n• Все открытые позиции\n• Всю историю сделок\n• Подготовку сделок\n• Баланс и статистику\n\nЭто действие нельзя отменить!`);
      if (!confirmClear) return;
      
      // Очищаем все массивы
      openPositions = [];
      closedDeals = [];
      dealPrepData = {};
      cooldownSymbols = {};
      
      // Сбрасываем баланс и статистику
      currentBalance = initialBalance;
      realizedPnL = 0;
      totalCommissions = 0;
      
      // Очищаем localStorage
      localStorage.removeItem('tradingData');
      localStorage.removeItem('dealPrepData');
      
      // Очищаем UI
      document.querySelector('.open-deals-content').innerHTML = '<div class="empty-state">Нет открытых позиций</div>';
      updateBalanceDisplay();
      updateTradingStats();
      
      console.log('🗑️ Все данные очищены!');
      alert('✅ Все данные успешно очищены!');
    };
    
    // Функция закрытия всех позиций
    window.closeAllPositions = function() {
      if (openPositions.length === 0) {
        alert('❌ Нет открытых позиций для закрытия');
        return;
      }
      
      const confirmClose = confirm(`🛑 Закрыть все ${openPositions.length} позиций?\n\nЭто действие нельзя отменить!`);
      if (!confirmClose) {
        return;
      }
      
      console.log(`🛑 Закрываем все ${openPositions.length} позиций...`);
      
      // Закрываем все позиции в обратном порядке (чтобы индексы не сбились)
      for (let i = openPositions.length - 1; i >= 0; i--) {
        const position = openPositions[i];
        const currentPrice = lastPrices[position.symbol] || position.entryPrice;
        
        console.log(`🛑 Закрываем ${position.direction} ${position.symbol} @ $${currentPrice.toFixed(2)}`);
        closePosition(i, currentPrice, 'MANUAL_CLOSE_ALL');
      }
      
      console.log('✅ Все позиции закрыты!');
      alert(`✅ Закрыто ${openPositions.length} позиций`);
    };

    ws.onmessage = (event) => {
      const message = JSON.parse(event.data);
      
      // Проверяем тип сообщения
      if (message.type === 'prices') {
        const data = message.data;
      
      // Обновляем цены в открытых позициях
      updateOpenPositionsPrices(data);
      
      // Обновляем баланс и PnL (если есть открытые позиции)
      if (openPositions.length > 0) {
        updateBalanceDisplay();
      }
      
      let longSignals = 0;
      let shortSignals = 0;
      let totalVolumeRatio = 0;
      let totalRsi = 0;
      let activeCoins = 0;
      
      // Обновляем каждую криптовалюту
      Object.keys(data).forEach(symbol => {
        updateCryptoCard(symbol, data[symbol]);
        
        // Обновляем аналитику
        if (data[symbol].analytics || data[symbol].orderBook) {
          updateAnalyticsCard(symbol, data[symbol]);
        }

        // Обновляем торговые сигналы
        if (data[symbol].analytics && data[symbol].orderBook) {
          updateSignalCard(symbol, data[symbol]);
        }
        
        // Собираем статистику для меню
        if (data[symbol].analytics) {
          activeCoins++;
          const analytics = data[symbol].analytics;
          
          if (analytics.longPercentage >= 55) longSignals++;
          if (analytics.shortPercentage >= 55) shortSignals++;
          
          if (analytics.volumeRatio) totalVolumeRatio += analytics.volumeRatio;
          if (analytics.rsi) totalRsi += analytics.rsi;
        }
      });
      
      // Обновляем верхнее меню
      updateTopMenu(activeCoins, longSignals, shortSignals, totalVolumeRatio, totalRsi);
      } // Закрываем if (message.type === 'prices')
    };
    
    function updateTopMenu(activeCoins, longSignals, shortSignals, totalVolumeRatio, totalRsi) {
      // Обновление меню происходит через updateBalanceDisplay()
      // Эта функция больше не нужна для баланса/PnL
    }

    ws.onerror = (error) => {
      console.error('❌ Ошибка WebSocket:', error);
    };

    ws.onclose = () => {
      console.log('⚠️ Соединение закрыто');
      document.getElementById('menu-status').textContent = 'Переподключение...';
      Object.keys(cryptoConfig).forEach(symbol => {
        const priceEl = document.getElementById(`price-${symbol}`);
        if (priceEl) priceEl.textContent = 'Переподключение...';
      });
    };
  </script>
</body>
</html>

