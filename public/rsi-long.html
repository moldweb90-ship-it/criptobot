<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RSI Long Only Strategy - Crypto Bot</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    .header {
      text-align: center;
      margin-bottom: 30px;
      color: white;
    }

    .header h1 {
      font-size: 2.5rem;
      margin-bottom: 10px;
      text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }

    .header .strategy-badge {
      display: inline-block;
      background: linear-gradient(135deg, #22c55e, #16a34a);
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 600;
      margin-top: 10px;
      box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
    }

    .header p {
      font-size: 1.2rem;
      opacity: 0.9;
    }

    .strategy-info {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 30px;
      margin-bottom: 30px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      text-align: center;
    }

    .strategy-info h2 {
      color: #2d3748;
      margin-bottom: 20px;
      font-size: 1.8rem;
    }

    .strategy-rules {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .rule-card {
      background: #f8fafc;
      border-radius: 12px;
      padding: 20px;
      border-left: 4px solid #4299e1;
    }

    .rule-card.long {
      border-left-color: #48bb78;
    }

    .rule-card.short {
      border-left-color: #f56565;
    }

    .rule-title {
      font-weight: 700;
      font-size: 1.2rem;
      margin-bottom: 10px;
      color: #2d3748;
    }

    .rule-desc {
      color: #718096;
      line-height: 1.6;
    }

    .crypto-grid {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 15px;
      margin-bottom: 30px;
    }

    .crypto-card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      padding: 15px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      transition: transform 0.3s ease;
      min-height: 220px;
    }

    .crypto-card:hover {
      transform: translateY(-5px);
    }

    .header-card {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 12px;
    }

    .icon {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: bold;
      color: white;
    }

    .icon.btc { background: linear-gradient(135deg, #f7931a 0%, #ffa726 100%); }
    .icon.eth { background: linear-gradient(135deg, #627eea 0%, #8c9eff 100%); }
    .icon.sol { background: linear-gradient(135deg, #9945ff 0%, #14f195 100%); }
    .icon.xrp { background: linear-gradient(135deg, #23292f 0%, #4a90e2 100%); }
    .icon.bnb { background: linear-gradient(135deg, #f3ba2f 0%, #f7d794 100%); }
    .icon.doge { background: linear-gradient(135deg, #c2a633 0%, #d4c17d 100%); }

    .title {
      font-size: 14px;
      font-weight: 700;
      color: #2d3748;
    }

    .subtitle {
      font-size: 10px;
      color: #718096;
      margin-top: 2px;
    }

    .price-display {
      text-align: center;
      margin: 15px 0;
    }

    .price {
      font-size: 20px;
      font-weight: 800;
      color: #2d3748;
      margin-bottom: 4px;
      transition: all 0.3s ease;
    }

    .change {
      font-size: 16px;
      font-weight: 600;
      padding: 6px 12px;
      border-radius: 12px;
      display: inline-block;
    }

    .change.positive {
      background: #c6f6d5;
      color: #22543d;
    }

    .change.negative {
      background: #fed7d7;
      color: #742a2a;
    }

    .rsi-indicator {
      text-align: center;
      margin: 15px 0;
      padding: 10px;
      border-radius: 8px;
      background: #f8fafc;
    }

    .rsi-value {
      font-size: 24px;
      font-weight: 800;
      margin-bottom: 5px;
    }

    .rsi-value.oversold {
      color: #48bb78;
    }

    .rsi-value.overbought {
      color: #f56565;
    }

    .rsi-value.neutral {
      color: #718096;
    }

    .rsi-label {
      font-size: 12px;
      color: #718096;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .rsi-signal {
      text-align: center;
      margin: 10px 0;
      padding: 8px;
      border-radius: 6px;
      font-weight: 700;
      font-size: 14px;
    }

    .rsi-signal.long {
      background: #c6f6d5;
      color: #22543d;
    }

    .rsi-signal.short {
      background: #fed7d7;
      color: #742a2a;
    }

    .rsi-signal.neutral {
      background: #e2e8f0;
      color: #718096;
    }

    .stats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 6px;
      margin-top: 12px;
    }

    .stat {
      font-size: 11px;
      color: #718096;
    }

    .stat-value {
      font-weight: 600;
      color: #2d3748;
    }

    .connection-status {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      margin-top: 15px;
      font-size: 12px;
      color: #718096;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #48bb78;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    /* Бургерное меню */
    .burger-menu {
      position: fixed;
      top: 20px;
      left: 20px;
      z-index: 1000;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
      transition: all 0.3s ease;
    }

    .burger-button {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      width: 50px;
      height: 50px;
      background: none;
      border: none;
      cursor: pointer;
      padding: 0;
      transition: all 0.3s ease;
    }

    .burger-line {
      width: 24px;
      height: 3px;
      background: #2d3748;
      margin: 2px 0;
      transition: all 0.3s ease;
      border-radius: 2px;
    }

    .burger-button:hover .burger-line {
      background: #4299e1;
    }

    .burger-button.active .burger-line:nth-child(1) {
      transform: rotate(45deg) translate(5px, 5px);
    }

    .burger-button.active .burger-line:nth-child(2) {
      opacity: 0;
    }

    .burger-button.active .burger-line:nth-child(3) {
      transform: rotate(-45deg) translate(7px, -6px);
    }

    .burger-menu-content {
      position: absolute;
      top: 60px;
      left: 0;
      background: rgba(255, 255, 255, 0.98);
      backdrop-filter: blur(20px);
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      min-width: 250px;
      max-width: 300px;
      opacity: 0;
      visibility: hidden;
      transform: translateY(-20px);
      transition: all 0.3s ease;
      overflow: hidden;
    }

    .burger-menu-content.active {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }

    .burger-menu-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      text-align: center;
    }

    .burger-menu-title {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 5px;
    }

    .burger-menu-subtitle {
      font-size: 12px;
      opacity: 0.9;
    }

    .burger-menu-items {
      padding: 10px 0;
    }

    .burger-menu-item {
      display: flex;
      align-items: center;
      padding: 15px 20px;
      color: #2d3748;
      text-decoration: none;
      transition: all 0.3s ease;
      border-left: 4px solid transparent;
    }

    .burger-menu-item:hover {
      background: #f7fafc;
      border-left-color: #4299e1;
      color: #4299e1;
    }

    .burger-menu-item.active {
      background: #e6fffa;
      border-left-color: #38a169;
      color: #38a169;
    }

    .burger-menu-icon {
      font-size: 20px;
      margin-right: 12px;
      width: 24px;
      text-align: center;
    }

    .burger-menu-text {
      font-weight: 600;
      font-size: 14px;
    }

    .burger-menu-desc {
      font-size: 11px;
      color: #718096;
      margin-top: 2px;
    }

    .burger-menu-divider {
      height: 1px;
      background: #e2e8f0;
      margin: 10px 20px;
    }

    /* Горизонтальное меню */
    .horizontal-menu {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid #e2e8f0;
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      z-index: 1000;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .menu-left {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .burger-icon {
      background: none;
      border: none;
      cursor: pointer;
      padding: 5px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      z-index: 1001;
    }

    .burger-icon span {
      width: 25px;
      height: 3px;
      background: #2d3748;
      border-radius: 2px;
      transition: all 0.3s ease;
    }

    .burger-icon:hover span {
      background: #4299e1;
    }

    .menu-left .logo {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo-icon {
      font-size: 24px;
    }

    .logo-text {
      font-size: 18px;
      font-weight: 700;
      color: #2d3748;
    }

    .menu-center .balance-info {
      display: flex;
      gap: 30px;
      align-items: center;
    }

    .balance-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2px;
    }

    .balance-label {
      font-size: 12px;
      color: #718096;
      font-weight: 500;
    }

    .balance-value {
      font-size: 16px;
      font-weight: 700;
      color: #2d3748;
    }

    .balance-value.positive {
      color: #48bb78;
    }

    .balance-value.negative {
      color: #f56565;
    }

    .menu-right .connection-status {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      color: #718096;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #48bb78;
      animation: pulse 2s infinite;
    }

    .status-dot.disconnected {
      background: #f56565;
    }

    /* Отступ для контента под меню */
    .container {
      margin-top: 80px;
      max-width: 100%;
      padding: 0 20px;
    }

    @media (max-width: 768px) {
      .crypto-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .strategy-rules {
        grid-template-columns: 1fr;
      }

      .menu-center .balance-info {
        gap: 15px;
      }

      .balance-item {
        min-width: 60px;
      }

      .balance-label {
        font-size: 10px;
      }

      .balance-value {
        font-size: 14px;
      }
    }

    /* Секции сделок */
    .positions-section, .history-section, .crypto-stats-section, .long-short-stats-section, .losses-section, .trading-controls-section {
      margin-top: 40px;
      margin-bottom: 40px;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    /* Стили для управления торговлей */
    .trading-controls {
      margin-top: 20px;
    }

    .control-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding: 15px;
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
      border-radius: 12px;
      border-left: 4px solid #4299e1;
    }

    .control-header span {
      font-weight: 600;
      color: #2d3748;
    }

    .control-buttons {
      display: flex;
      gap: 10px;
    }

    .control-btn {
      padding: 8px 16px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 14px;
    }

    .control-btn.enable {
      background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
      color: white;
    }

    .control-btn.enable:hover {
      background: linear-gradient(135deg, #38a169 0%, #2f855a 100%);
      transform: translateY(-1px);
    }

    .control-btn.disable {
      background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);
      color: white;
    }

    .control-btn.disable:hover {
      background: linear-gradient(135deg, #e53e3e 0%, #c53030 100%);
      transform: translateY(-1px);
    }

    .coins-toggle-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
    }

    .coin-toggle {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 15px;
      background: linear-gradient(135deg, #ffffff 0%, #f7fafc 100%);
      border-radius: 12px;
      border: 2px solid #e2e8f0;
      transition: all 0.3s ease;
    }

    .coin-toggle:hover {
      border-color: #4299e1;
      box-shadow: 0 4px 12px rgba(66, 153, 225, 0.15);
    }

    .coin-toggle.disabled {
      background: linear-gradient(135deg, #fed7d7 0%, #feb2b2 100%);
      border-color: #f56565;
      opacity: 0.7;
    }

    .coin-info {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .coin-icon {
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      font-weight: bold;
      font-size: 14px;
    }

    .coin-icon.btc { background: linear-gradient(135deg, #f7931a 0%, #ff6b35 100%); color: white; }
    .coin-icon.eth { background: linear-gradient(135deg, #627eea 0%, #4f46e5 100%); color: white; }
    .coin-icon.sol { background: linear-gradient(135deg, #9945ff 0%, #14f195 100%); color: white; }
    .coin-icon.xrp { background: linear-gradient(135deg, #23292f 0%, #3659f4 100%); color: white; }
    .coin-icon.bnb { background: linear-gradient(135deg, #f3ba2f 0%, #ff6b35 100%); color: white; }
    .coin-icon.doge { background: linear-gradient(135deg, #c2a633 0%, #f3ba2f 100%); color: white; }

    .coin-name {
      font-weight: 600;
      color: #2d3748;
    }

    .coin-status {
      font-size: 12px;
      color: #718096;
    }

    .toggle-switch {
      position: relative;
      width: 50px;
      height: 24px;
      background: #cbd5e0;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .toggle-switch.active {
      background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
    }

    .toggle-switch.disabled {
      background: #f56565;
    }

    .toggle-slider {
      position: absolute;
      top: 2px;
      left: 2px;
      width: 20px;
      height: 20px;
      background: white;
      border-radius: 50%;
      transition: all 0.3s ease;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .toggle-switch.active .toggle-slider {
      transform: translateX(26px);
    }

    /* Статистика по монетам */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 15px;
      margin-top: 20px;
    }

    @media (max-width: 1200px) {
      .stats-grid {
        grid-template-columns: repeat(3, 1fr);
      }
    }

    @media (max-width: 768px) {
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 480px) {
      .stats-grid {
        grid-template-columns: 1fr;
      }
    }

    .stat-card {
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
      border-radius: 12px;
      padding: 15px;
      border-left: 4px solid #4299e1;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      min-height: 140px;
    }

    .stat-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
    }

    .stat-card.profitable {
      border-left-color: #48bb78;
      background: linear-gradient(135deg, #f0fff4 0%, #c6f6d5 100%);
    }

    .stat-card.loss {
      border-left-color: #f56565;
      background: linear-gradient(135deg, #fff5f5 0%, #fed7d7 100%);
    }

    .stat-card.top-profit {
      border-left-color: #38a169;
      background: linear-gradient(135deg, #e6fffa 0%, #b2f5ea 100%);
      box-shadow: 0 0 20px rgba(56, 161, 105, 0.3);
    }

    .stat-card.top-loss {
      border-left-color: #e53e3e;
      background: linear-gradient(135deg, #fffaf0 0%, #fbd38d 100%);
      box-shadow: 0 0 20px rgba(229, 62, 62, 0.3);
    }

    .stat-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 10px;
    }

    .stat-icon {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: bold;
      color: white;
    }

    .stat-icon.btc { background: linear-gradient(135deg, #f7931a 0%, #ffa726 100%); }
    .stat-icon.eth { background: linear-gradient(135deg, #627eea 0%, #8c9eff 100%); }
    .stat-icon.sol { background: linear-gradient(135deg, #9945ff 0%, #14f195 100%); }
    .stat-icon.xrp { background: linear-gradient(135deg, #23292f 0%, #4a90e2 100%); }
    .stat-icon.bnb { background: linear-gradient(135deg, #f3ba2f 0%, #f7d794 100%); }
    .stat-icon.doge { background: linear-gradient(135deg, #c2a633 0%, #d4c17d 100%); }

    .stat-title {
      font-size: 14px;
      font-weight: 700;
      color: #2d3748;
    }

    .stat-badge {
      position: absolute;
      top: 10px;
      right: 10px;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .stat-badge.top-profit {
      background: #38a169;
      color: white;
    }

    .stat-badge.top-loss {
      background: #e53e3e;
      color: white;
    }

    .stat-metrics {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr 1fr;
      gap: 6px;
      margin-bottom: 10px;
    }

    .stat-metric {
      text-align: center;
    }

    .stat-metric-label {
      font-size: 9px;
      color: #718096;
      margin-bottom: 3px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .stat-metric-value {
      font-size: 12px;
      font-weight: 700;
      color: #2d3748;
    }

    .stat-pnl {
      text-align: center;
      padding: 8px;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 800;
    }

    .stat-pnl.positive {
      background: #c6f6d5;
      color: #22543d;
    }

    .stat-pnl.negative {
      background: #fed7d7;
      color: #742a2a;
    }

    /* Стили для статистики LONG/SHORT */
    .long-short-stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
      margin-top: 20px;
    }

    @media (max-width: 768px) {
      .long-short-stats-grid {
        grid-template-columns: 1fr;
      }
    }

    .long-short-card {
      background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
      border-radius: 16px;
      padding: 25px;
      border-left: 6px solid #0ea5e9;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      min-height: 200px;
    }

    .long-short-card.long {
      background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
      border-left-color: #22c55e;
    }

    .long-short-card.short {
      background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
      border-left-color: #ef4444;
    }

    .long-short-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 20px;
    }

    .long-short-icon {
      font-size: 24px;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
    }

    .long-short-icon.long {
      background: #22c55e;
      color: white;
    }

    .long-short-icon.short {
      background: #ef4444;
      color: white;
    }

    .long-short-title {
      font-size: 18px;
      font-weight: 700;
      color: #1f2937;
    }

    .long-short-stats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }

    .long-short-stat {
      text-align: center;
      padding: 10px;
      background: rgba(255, 255, 255, 0.7);
      border-radius: 8px;
    }

    .long-short-stat-label {
      font-size: 12px;
      color: #6b7280;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 5px;
    }

    .long-short-stat-value {
      font-size: 16px;
      font-weight: 800;
      color: #1f2937;
    }

    .long-short-stat-value.positive {
      color: #059669;
    }

    .long-short-stat-value.negative {
      color: #dc2626;
    }

    /* Стили для убыточных сделок */
    .losses-grid {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 15px;
      margin-top: 20px;
    }

    @media (max-width: 1200px) {
      .losses-grid {
        grid-template-columns: repeat(3, 1fr);
      }
    }

    @media (max-width: 768px) {
      .losses-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 480px) {
      .losses-grid {
        grid-template-columns: 1fr;
      }
    }

    .loss-card {
      background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);
      border-radius: 12px;
      padding: 15px;
      border-left: 4px solid #f44336;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      min-height: 140px;
    }

    .loss-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(244, 67, 54, 0.3);
    }

    .loss-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 10px;
    }

    .loss-icon {
      width: 32px;
      height: 32px;
      font-size: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
      color: white;
      font-weight: bold;
    }

    .loss-title {
      font-size: 14px;
      font-weight: 600;
      color: #333;
    }

    .loss-metrics {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 6px;
      margin-bottom: 10px;
    }

    .loss-metric-label {
      font-size: 9px;
      color: #666;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .loss-metric-value {
      font-size: 12px;
      font-weight: 600;
      color: #333;
    }

    .loss-amount {
      padding: 8px;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      text-align: center;
      background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
      color: white;
    }

    .loss-badge {
      position: absolute;
      top: 8px;
      right: 8px;
      background: #f44336;
      color: white;
      padding: 2px 6px;
      border-radius: 10px;
      font-size: 8px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .stat-pnl.neutral {
      background: #e2e8f0;
      color: #4a5568;
    }

    /* Общая статистика */
    .overall-stats {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 20px;
      color: white;
      text-align: center;
    }

    .overall-stats h3 {
      margin: 0 0 15px 0;
      font-size: 18px;
      font-weight: 700;
    }

    .overall-metrics {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 15px;
    }

    .overall-metric {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      padding: 12px;
      backdrop-filter: blur(10px);
    }

    .overall-metric-label {
      font-size: 11px;
      opacity: 0.8;
      margin-bottom: 5px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .overall-metric-value {
      font-size: 16px;
      font-weight: 700;
    }

    .positions-section {
      margin-top: 30px;
    }

    .crypto-grid {
      margin-top: 30px;
      margin-bottom: 30px;
    }

    .strategy-info {
      margin-top: 40px;
      margin-bottom: 40px;
    }

    .header {
      margin-bottom: 30px;
    }

    .container {
      padding-bottom: 40px;
    }

    .positions-section h2, .history-section h2 {
      color: #2d3748;
      margin-bottom: 20px;
      font-size: 1.8rem;
      text-align: center;
    }

    .positions-container, .history-container {
      min-height: 200px;
    }

    .no-positions, .no-history {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 40px;
      text-align: center;
      color: #718096;
    }

    .no-positions-icon, .no-history-icon {
      font-size: 48px;
      margin-bottom: 15px;
      opacity: 0.5;
    }

    .no-positions-text, .no-history-text {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 8px;
      color: #4a5568;
    }

    .no-positions-desc, .no-history-desc {
      font-size: 14px;
      opacity: 0.8;
    }

    /* Карточки позиций */
    .position-card {
      background: #f8fafc;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 15px;
      border-left: 4px solid #4299e1;
      transition: all 0.3s ease;
    }

    .position-card.long {
      border-left-color: #48bb78;
    }

    .position-card.short {
      border-left-color: #f56565;
    }

    .position-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .position-symbol {
      font-size: 18px;
      font-weight: 700;
      color: #2d3748;
    }

    .position-direction {
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .position-direction.long {
      background: #c6f6d5;
      color: #22543d;
    }

    .position-direction.short {
      background: #fed7d7;
      color: #742a2a;
    }

    .position-details {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-bottom: 15px;
    }

    .position-detail {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .position-detail-label {
      font-size: 12px;
      color: #718096;
      font-weight: 500;
    }

    .position-detail-value {
      font-size: 14px;
      font-weight: 600;
      color: #2d3748;
    }

    .position-pnl {
      text-align: center;
      padding: 10px;
      border-radius: 8px;
      font-weight: 700;
      font-size: 16px;
    }

    .position-pnl.positive {
      background: #c6f6d5;
      color: #22543d;
    }

    .position-pnl.negative {
      background: #fed7d7;
      color: #742a2a;
    }

    .position-pnl.neutral {
      background: #e2e8f0;
      color: #718096;
    }

    /* Планируемые прибыли/убытки */
    .position-planned-pnl {
      display: flex;
      justify-content: space-between;
      margin: 10px 0;
      padding: 8px 12px;
      background: #f8fafc;
      border-radius: 6px;
      border: 1px solid #e2e8f0;
    }

    .planned-tp, .planned-sl {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2px;
    }

    .planned-label {
      font-size: 11px;
      color: #718096;
      font-weight: 500;
    }

    .planned-value {
      font-size: 13px;
      font-weight: 700;
    }

    .planned-value.positive {
      color: #48bb78;
    }

    .planned-value.negative {
      color: #f56565;
    }

    /* Кнопки действий */
    .position-actions {
      margin-top: 15px;
      text-align: center;
    }

    .close-btn {
      background: linear-gradient(135deg, #f56565, #e53e3e);
      color: white;
      border: none;
      border-radius: 8px;
      padding: 8px 16px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(245, 101, 101, 0.3);
    }

    .close-btn:hover {
      background: linear-gradient(135deg, #e53e3e, #c53030);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(245, 101, 101, 0.4);
    }

    .close-btn:active {
      transform: translateY(0);
      box-shadow: 0 2px 6px rgba(245, 101, 101, 0.3);
    }

    /* Сетка для открытых сделок RSI */
    .positions-container {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 20px;
    }

    @media (max-width: 1400px) {
      .positions-container {
        grid-template-columns: repeat(3, 1fr);
      }
    }

    @media (max-width: 1000px) {
      .positions-container {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 600px) {
      .positions-container {
        grid-template-columns: 1fr;
      }
    }

    /* Статистика истории */
    .history-stats {
      display: flex;
      justify-content: space-around;
      margin-bottom: 20px;
      padding: 15px;
      background: #f8fafc;
      border-radius: 12px;
      border: 1px solid #e2e8f0;
    }

    .stat-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
    }

    .stat-label {
      font-size: 12px;
      color: #718096;
      font-weight: 500;
    }

    .stat-value {
      font-size: 16px;
      font-weight: 700;
      color: #2d3748;
    }

    .stat-value.positive {
      color: #48bb78;
    }

    .stat-value.negative {
      color: #f56565;
    }

    /* Список истории сделок */
    .history-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .history-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      background: #f8fafc;
      border-radius: 8px;
      border-left: 4px solid #4299e1;
      transition: all 0.2s ease;
    }

    .history-item:hover {
      background: #edf2f7;
      transform: translateX(2px);
    }

    .history-item.long {
      border-left-color: #48bb78;
    }

    .history-item.short {
      border-left-color: #f56565;
    }

    .history-item.profit {
      background: #f0fff4;
    }

    .history-item.loss {
      background: #fff5f5;
    }

    .history-main {
      display: flex;
      align-items: center;
      gap: 12px;
      flex: 1;
    }

    .history-symbol {
      font-weight: 700;
      font-size: 14px;
      color: #2d3748;
      min-width: 80px;
    }

    .history-direction {
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .history-direction.long {
      background: #c6f6d5;
      color: #22543d;
    }

    .history-direction.short {
      background: #fed7d7;
      color: #742a2a;
    }

    .history-prices {
      display: flex;
      flex-direction: column;
      gap: 2px;
      font-size: 12px;
      color: #718096;
    }

    .history-pnl {
      text-align: right;
      font-weight: 700;
      font-size: 14px;
    }

    .history-pnl.positive {
      color: #48bb78;
    }

    .history-pnl.negative {
      color: #f56565;
    }

    .history-time {
      font-size: 11px;
      color: #a0aec0;
      margin-top: 2px;
    }

    /* Постраничная навигация */
    .pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 20px;
      margin-top: 20px;
      padding: 15px;
    }

    .page-btn {
      background: #4299e1;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 8px 16px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .page-btn:hover:not(:disabled) {
      background: #3182ce;
      transform: translateY(-1px);
    }

    .page-btn:disabled {
      background: #e2e8f0;
      color: #a0aec0;
      cursor: not-allowed;
    }

    .page-info {
      font-size: 14px;
      color: #718096;
      font-weight: 500;
    }
  </style>
</head>
<body>
  <!-- Бургерное меню -->
  <div class="burger-menu">
    <button class="burger-button" id="burgerButton">
      <div class="burger-line"></div>
      <div class="burger-line"></div>
      <div class="burger-line"></div>
    </button>
    
    <div class="burger-menu-content" id="burgerMenuContent">
      <div class="burger-menu-header">
        <div class="burger-menu-title">🎯 Crypto Bot</div>
        <div class="burger-menu-subtitle">Торговые стратегии</div>
      </div>
      
      <div class="burger-menu-items">
        <a href="/" class="burger-menu-item">
          <div class="burger-menu-icon">🏠</div>
          <div>
            <div class="burger-menu-text">Основная стратегия</div>
            <div class="burger-menu-desc">Консервативная TP/SL</div>
          </div>
        </a>
        
        <a href="/rsi" class="burger-menu-item">
          <div class="burger-menu-icon">📊</div>
          <div>
            <div class="burger-menu-text">RSI стратегия</div>
            <div class="burger-menu-desc">Экстремумы RSI</div>
          </div>
        </a>
        
        <a href="/rsi-long" class="burger-menu-item active">
          <div class="burger-menu-icon">📈</div>
          <div>
            <div class="burger-menu-text">RSI Long Only</div>
            <div class="burger-menu-desc">Только лонги</div>
          </div>
        </a>
        
        <a href="/rsi-40-50" class="burger-menu-item">
          <div class="burger-menu-icon">📊</div>
          <div>
            <div class="burger-menu-text">RSI 40-50</div>
            <div class="burger-menu-desc">LONG/SHORT</div>
          </div>
        </a>
        
        <a href="/rsi-max" class="burger-menu-item">
          <div class="burger-menu-icon">🚀</div>
          <div>
            <div class="burger-menu-text">RSI Max</div>
            <div class="burger-menu-desc">Большие движения</div>
          </div>
        </a>
        
        <div class="burger-menu-divider"></div>
        
        <a href="#" class="burger-menu-item">
          <div class="burger-menu-icon">⚙️</div>
          <div>
            <div class="burger-menu-text">Настройки</div>
            <div class="burger-menu-desc">Скоро...</div>
          </div>
        </a>
        
        <a href="#" class="burger-menu-item">
          <div class="burger-menu-icon">📈</div>
          <div>
            <div class="burger-menu-text">MACD стратегия</div>
            <div class="burger-menu-desc">В разработке</div>
          </div>
        </a>
      </div>
    </div>
  </div>

  <!-- Горизонтальное меню -->
  <div class="horizontal-menu">
    <div class="menu-left">
      <button class="burger-icon" id="rsiBurgerButton">
        <span></span>
        <span></span>
        <span></span>
      </button>
      <div class="logo">
        <span class="logo-icon">📊</span>
        <span class="logo-text">RSI Strategy</span>
      </div>
    </div>
    
    <div class="menu-center">
      <div class="balance-info">
        <div class="balance-item">
          <span class="balance-label">Баланс:</span>
          <span class="balance-value" id="rsiBalance">$1,000.00</span>
        </div>
        <div class="balance-item">
          <span class="balance-label">Реализованный PnL:</span>
          <span class="balance-value" id="rsiRealizedPnL">$0.00</span>
        </div>
        <div class="balance-item">
          <span class="balance-label">Нереализованный PnL:</span>
          <span class="balance-value" id="rsiUnrealizedPnL">$0.00</span>
        </div>
        <div class="balance-item">
          <span class="balance-label">Сделок:</span>
          <span class="balance-value" id="rsiDealsCount">0</span>
        </div>
        <div class="balance-item">
          <span class="balance-label">Win Rate:</span>
          <span class="balance-value" id="rsiWinRate">0%</span>
        </div>
        <div class="balance-item">
          <span class="balance-label">Заблокировано:</span>
          <span class="balance-value" id="rsiLocked">$0.00</span>
        </div>
      </div>
    </div>
    
    <div class="menu-right">
      <div class="connection-status">
        <div class="status-dot" id="rsiConnectionStatus"></div>
        <span id="rsiConnectionText">Подключено</span>
      </div>
    </div>
  </div>

  <div class="container">
    <div class="header">
      <h1>📈 RSI Long Only Strategy</h1>
      <p>Торговля только LONG позициями на основе RSI индикатора (3-минутный таймфрейм)</p>
      <div class="strategy-badge">🟢 ТОЛЬКО ЛОНГИ</div>
    </div>

    <!-- Открытые сделки RSI -->
    <div class="positions-section">
      <h2>📈 Открытые сделки RSI</h2>
      <div class="positions-container" id="rsiPositionsContainer">
        <div class="no-positions">
          <div class="no-positions-icon">📊</div>
          <div class="no-positions-text">Нет открытых сделок</div>
          <div class="no-positions-desc">Сделки появятся при RSI ≤ 25 (только LONG позиции)</div>
        </div>
      </div>
    </div>

    <!-- Управление торговлей по монетам -->
    <div class="trading-controls-section">
      <h2>🎛️ Управление торговлей</h2>
      <div class="trading-controls">
        <div class="control-header">
          <span>Включить/отключить торговлю по монетам:</span>
          <div class="control-buttons">
            <button id="enableAllCoins" class="control-btn enable">Включить все</button>
            <button id="disableAllCoins" class="control-btn disable">Отключить все</button>
          </div>
        </div>
        <div class="coins-toggle-grid" id="coinsToggleGrid">
          <!-- Переключатели монет будут добавлены динамически -->
        </div>
      </div>
    </div>

    <div class="crypto-grid" id="cryptoGrid">
      <!-- Криптовалюты будут добавлены динамически -->
    </div>


    <!-- Статистика по монетам -->
    <div class="crypto-stats-section">
      <h2>📊 Статистика по монетам</h2>
      
      <!-- Общая статистика -->
      <div class="overall-stats" id="overallStats">
        <!-- Общая статистика будет добавлена динамически -->
      </div>
      
      <div class="stats-grid" id="cryptoStatsGrid">
        <!-- Статистика будет добавлена динамически -->
      </div>
    </div>

    <!-- Статистика LONG/SHORT -->
    <div class="long-short-stats-section">
      <h2>📈📉 Статистика LONG/SHORT</h2>
      <div class="long-short-stats-grid" id="longShortStatsGrid">
        <!-- Статистика LONG/SHORT будет добавлена динамически -->
      </div>
    </div>

    <!-- Убыточные сделки по монетам -->
    <div class="losses-section">
      <h2>📉 Убыточные сделки по монетам</h2>
      <div class="losses-grid" id="lossesGrid">
        <!-- Убытки будут добавлены динамически -->
      </div>
    </div>

    <!-- История сделок RSI -->
    <div class="history-section">
      <h2>📋 История сделок RSI</h2>
      <div class="history-stats">
        <div class="stat-item">
          <span class="stat-label">Всего сделок:</span>
          <span class="stat-value" id="rsiTotalDeals">0</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">Прибыльных:</span>
          <span class="stat-value positive" id="rsiWinningDeals">0</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">Убыточных:</span>
          <span class="stat-value negative" id="rsiLosingDeals">0</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">Win Rate:</span>
          <span class="stat-value" id="rsiHistoryWinRate">0%</span>
        </div>
      </div>
      <div class="history-container" id="rsiHistoryContainer">
        <div class="no-history">
          <div class="no-history-icon">📝</div>
          <div class="no-history-text">История сделок пуста</div>
          <div class="no-history-desc">Закрытые сделки будут отображаться здесь</div>
        </div>
      </div>
      <div class="pagination" id="rsiPagination" style="display: none;">
        <button class="page-btn" id="rsiPrevPage" onclick="changeRSIPage(-1)">← Назад</button>
        <span class="page-info" id="rsiPageInfo">Страница 1 из 1</span>
        <button class="page-btn" id="rsiNextPage" onclick="changeRSIPage(1)">Вперед →</button>
      </div>
      <div class="data-controls" style="text-align: center; margin-top: 20px;">
        <div style="margin-bottom: 10px; font-size: 12px; color: #718096;">
          💾 Данные автоматически сохраняются каждые 5 секунд
        </div>
        <button class="clear-btn" onclick="clearRSIData()" style="background: #f56565; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">
          🗑️ Очистить все данные RSI Long
        </button>
      </div>
    </div>

    <div class="strategy-info">
      <h2>🎯 Правила RSI стратегии</h2>
      <div class="strategy-rules">
        <div class="rule-card long">
          <div class="rule-title">🟢 LONG сигнал</div>
          <div class="rule-desc">
          RSI ≤ 25 (перепроданность)<br>
            Моментальное открытие позиции<br>
          TP: 0.5%, SL: 0.25%<br>
          <strong>Сумма сделки: $100</strong><br>
          <strong>Средства блокируются до закрытия</strong>
          </div>
        </div>
        <div class="rule-card short disabled">
          <div class="rule-title">🔴 SHORT сигнал</div>
          <div class="rule-desc">
            <span style="color: #999; text-decoration: line-through;">RSI ≥ 69 (перекупленность)</span><br>
            <span style="color: #999;">Моментальное открытие позиции</span><br>
            <span style="color: #999;">TP: 0.37%, SL: 0.25%</span><br>
            <strong style="color: #999;">Сумма сделки: $100</strong><br>
            <strong style="color: #999;">Средства блокируются до закрытия</strong><br>
            <span style="color: #ef4444; font-weight: bold;">❌ ОТКЛЮЧЕНО</span>
          </div>
        </div>
        <div class="rule-card">
          <div class="rule-title">⚙️ Настройки</div>
          <div class="rule-desc">
            Размер позиции: $100<br>
            Начальный баланс: $1000<br>
            Таймфрейм: 3 минуты<br>
            R:R = 1:2.23<br>
            Без комиссий (тестирование)
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Бургерное меню
    document.addEventListener('DOMContentLoaded', function() {
      const burgerButton = document.getElementById('burgerButton');
      const rsiBurgerButton = document.getElementById('rsiBurgerButton');
      const burgerMenuContent = document.getElementById('burgerMenuContent');
      
      // Обработчик для старой кнопки бургера
      if (burgerButton) {
      burgerButton.addEventListener('click', function() {
        burgerButton.classList.toggle('active');
        burgerMenuContent.classList.toggle('active');
      });
      }

      // Обработчик для новой кнопки в горизонтальном меню
      if (rsiBurgerButton) {
        rsiBurgerButton.addEventListener('click', function(e) {
          e.stopPropagation();
          burgerMenuContent.classList.toggle('active');
        });
      }
      
      // Закрытие меню при клике вне его
      document.addEventListener('click', function(event) {
        const isBurgerClick = burgerButton && burgerButton.contains(event.target);
        const isRsiBurgerClick = rsiBurgerButton && rsiBurgerButton.contains(event.target);
        const isMenuClick = burgerMenuContent && burgerMenuContent.contains(event.target);
        
        if (!isBurgerClick && !isRsiBurgerClick && !isMenuClick) {
          if (burgerButton) burgerButton.classList.remove('active');
          if (burgerMenuContent) burgerMenuContent.classList.remove('active');
        }
      });
      
      // Закрытие меню при клике на пункт меню
      const menuItems = document.querySelectorAll('.burger-menu-item');
      menuItems.forEach(item => {
        item.addEventListener('click', function() {
          if (burgerButton) burgerButton.classList.remove('active');
          if (burgerMenuContent) burgerMenuContent.classList.remove('active');
        });
      });
    });

    // Данные для RSI стратегии
    let lastPrices = {};
    let rsiData = {};
    let openPositions = [];
    let closedDeals = [];
    let currentBalance = 1000; // Начальный баланс
    let realizedPnL = 0;
    let totalCommissions = 0;
    let cooldownSymbols = {};
    
    // Константы для RSI стратегии
    const FUTURES_TAKER_FEE = 0.0004; // 0.04% комиссия taker
    const POSITION_SIZE_USD = 100; // Размер позиции в долларах
    const RSI_LONG_THRESHOLD = 25; // RSI для LONG (перепроданность)
    const RSI_SHORT_THRESHOLD = 100; // RSI для SHORT (отключено - только лонги)
    
    // RSI торговые данные (отдельные от главной страницы и rsi.html)
    let rsiOpenPositions = [];
    let rsiClosedDeals = [];
    let rsiRealizedPnL = 0; // Реализованный PnL (баланс = 1000 + rsiRealizedPnL)
    let rsiTotalCommissions = 0;
    let rsiCooldownSymbols = {};
    let rsiLastPrices = {};
    
    // Управление торговлей по монетам
    let enabledCoins = {
      'BTCUSDT': true,
      'ETHUSDT': true,
      'SOLUSDT': true,
      'XRPUSDT': true,
      'BNBUSDT': true,
      'DOGEUSDT': true
    };
    
    // Постраничная навигация для истории
    let rsiCurrentPage = 1;
    const rsiDealsPerPage = 20;
    
    // WebSocket соединение
    let ws = null;
    
    // Сохранение данных RSI в localStorage
    function saveRSIData() {
      try {
        const data = {
          openPositions: rsiOpenPositions,
          closedDeals: rsiClosedDeals,
          realizedPnL: rsiRealizedPnL,
          totalCommissions: rsiTotalCommissions,
          cooldownSymbols: rsiCooldownSymbols,
          lastPrices: rsiLastPrices,
          currentPage: rsiCurrentPage,
          enabledCoins: enabledCoins,
          lastSaved: Date.now()
        };
        localStorage.setItem('rsiLongTradingData', JSON.stringify(data));
        console.log(`💾 RSI данные сохранены: ${rsiOpenPositions.length} позиций, ${rsiClosedDeals.length} сделок`);
      } catch (error) {
        console.error('❌ Ошибка сохранения RSI данных:', error);
      }
    }

    // Загрузка данных RSI из localStorage
    function loadRSIData() {
      try {
        const savedData = localStorage.getItem('rsiLongTradingData');
        if (savedData) {
          const data = JSON.parse(savedData);
          rsiOpenPositions = data.openPositions || [];
          rsiClosedDeals = data.closedDeals || [];
          rsiRealizedPnL = data.realizedPnL || 0;
          rsiTotalCommissions = data.totalCommissions || 0;
          rsiCooldownSymbols = data.cooldownSymbols || {};
          rsiLastPrices = data.lastPrices || {};
          rsiCurrentPage = data.currentPage || 1;
          enabledCoins = data.enabledCoins || {
            'BTCUSDT': true,
            'ETHUSDT': true,
            'SOLUSDT': true,
            'XRPUSDT': true,
            'BNBUSDT': true,
            'DOGEUSDT': true
          };
          
          console.log('📁 RSI данные загружены из localStorage');
          console.log(`   Открытых позиций: ${rsiOpenPositions.length}`);
          console.log(`   Закрытых сделок: ${rsiClosedDeals.length}`);
          console.log(`   Реализованный PnL: $${rsiRealizedPnL.toFixed(2)}`);
          
          // Показываем последние сделки
          if (rsiClosedDeals.length > 0) {
            const lastDeal = rsiClosedDeals[rsiClosedDeals.length - 1];
            console.log(`   Последняя сделка: ${lastDeal.symbol} ${lastDeal.direction} PnL: $${lastDeal.netPnL.toFixed(2)}`);
          }
        }
      } catch (error) {
        console.error('❌ Ошибка загрузки RSI данных:', error);
      }
    }
    
    // Инициализация
    document.addEventListener('DOMContentLoaded', function() {
      loadRSIData(); // Загружаем сохраненные данные
      initializeCryptoGrid();
      connectWebSocket();
      updateRSIBalance();
      updateRSIPositions();
      updateRSIHistory();
      updateCryptoStats();
      updateLongShortStats();
      updateLossesStats();
      initializeTradingControls();
    });

    // Сохранение данных при закрытии/переключении страницы
    window.addEventListener('beforeunload', function() {
      saveRSIData();
    });

    // Сохранение данных при потере фокуса (переключение вкладок)
    window.addEventListener('blur', function() {
      saveRSIData();
    });

    // Периодическое сохранение каждые 5 секунд
    setInterval(function() {
      saveRSIData();
    }, 5000);

    // Обновление баланса RSI
    function updateRSIBalance() {
      const unrealizedPnL = calculateUnrealizedPnL();
      const totalPnL = rsiRealizedPnL + unrealizedPnL;
      
      // Рассчитываем заблокированные средства в открытых позициях
      const lockedInPositions = rsiOpenPositions.reduce((total, pos) => total + pos.amountUSD, 0);
      
      // Доступный баланс = начальный + реализованный PnL - заблокированные средства
      const availableBalance = 1000 + rsiRealizedPnL - lockedInPositions;
      
      // Win Rate по netPnL (учитывает комиссии)
      const winRate = rsiClosedDeals.length > 0 
        ? (rsiClosedDeals.filter(deal => deal.netPnL > 0).length / rsiClosedDeals.length * 100).toFixed(1)
        : 0;

      document.getElementById('rsiBalance').textContent = `$${availableBalance.toFixed(2)}`;
      
      // Реализованный PnL
      const realizedPnLElement = document.getElementById('rsiRealizedPnL');
      realizedPnLElement.textContent = `${rsiRealizedPnL >= 0 ? '+' : ''}$${rsiRealizedPnL.toFixed(2)}`;
      realizedPnLElement.className = `balance-value ${rsiRealizedPnL >= 0 ? 'positive' : 'negative'}`;
      
      // Нереализованный PnL
      const unrealizedPnLElement = document.getElementById('rsiUnrealizedPnL');
      unrealizedPnLElement.textContent = `${unrealizedPnL >= 0 ? '+' : ''}$${unrealizedPnL.toFixed(2)}`;
      unrealizedPnLElement.className = `balance-value ${unrealizedPnL >= 0 ? 'positive' : 'negative'}`;
      
      document.getElementById('rsiDealsCount').textContent = rsiClosedDeals.length;
      document.getElementById('rsiWinRate').textContent = `${winRate}%`;
      document.getElementById('rsiLocked').textContent = `$${lockedInPositions.toFixed(2)}`;
      
      // Логирование для отладки
      console.log(`💰 Баланс RSI: Доступно: $${availableBalance.toFixed(2)}, Реализованный: $${rsiRealizedPnL.toFixed(2)}, Нереализованный: $${unrealizedPnL.toFixed(2)}, Заблокировано: $${lockedInPositions.toFixed(2)}`);
    }

    // Расчет нереализованного PnL
    function calculateUnrealizedPnL() {
      let totalUnrealized = 0;
      rsiOpenPositions.forEach(position => {
        const currentPrice = rsiLastPrices[position.symbol] || position.entryPrice;
        const pnl = position.direction === 'LONG' 
          ? (currentPrice - position.entryPrice) * position.volume
          : (position.entryPrice - currentPrice) * position.volume;
        totalUnrealized += pnl;
        
        console.log(`📊 ${position.symbol} ${position.direction}: Вход: $${position.entryPrice.toFixed(4)}, Текущая: $${currentPrice.toFixed(4)}, PnL: $${pnl.toFixed(2)}`);
      });
      console.log(`📈 Общий нереализованный PnL: $${totalUnrealized.toFixed(2)}`);
      return totalUnrealized;
    }

    // Обновление отображения позиций
    function updateRSIPositions() {
      const container = document.getElementById('rsiPositionsContainer');
      
      if (rsiOpenPositions.length === 0) {
        container.innerHTML = `
          <div class="no-positions">
            <div class="no-positions-icon">📊</div>
            <div class="no-positions-text">Нет открытых сделок</div>
            <div class="no-positions-desc">Сделки появятся при RSI ≤ 25 (только LONG позиции)</div>
          </div>
        `;
        return;
      }

      container.innerHTML = rsiOpenPositions.map(position => {
        const currentPrice = rsiLastPrices[position.symbol] || position.entryPrice;
        const pnl = position.direction === 'LONG' 
          ? (currentPrice - position.entryPrice) * position.volume
          : (position.entryPrice - currentPrice) * position.volume;
        const pnlPercent = (pnl / position.amountUSD) * 100;

        return `
          <div class="position-card ${position.direction.toLowerCase()}">
            <div class="position-header">
              <div class="position-symbol">${position.symbol}</div>
              <div class="position-direction ${position.direction.toLowerCase()}">${position.direction}</div>
            </div>
            <div class="position-details">
              <div class="position-detail">
                <div class="position-detail-label">Сумма сделки</div>
                <div class="position-detail-value">$${position.amountUSD.toFixed(2)}</div>
              </div>
              <div class="position-detail">
                <div class="position-detail-label">Вход</div>
                <div class="position-detail-value">$${position.entryPrice.toFixed(4)}</div>
              </div>
              <div class="position-detail">
                <div class="position-detail-label">Текущая</div>
                <div class="position-detail-value">$${currentPrice.toFixed(4)}</div>
              </div>
              <div class="position-detail">
                <div class="position-detail-label">Объем</div>
                <div class="position-detail-value">${position.volume.toFixed(6)}</div>
              </div>
              <div class="position-detail">
                <div class="position-detail-label">TP</div>
                <div class="position-detail-value">$${position.tpPrice.toFixed(4)}</div>
              </div>
              <div class="position-detail">
                <div class="position-detail-label">SL</div>
                <div class="position-detail-value">$${position.slPrice.toFixed(4)}</div>
              </div>
            </div>
            <div class="position-planned-pnl">
              <div class="planned-tp">
                <span class="planned-label">Планируемый TP:</span>
                <span class="planned-value positive">+$${(position.amountUSD * 0.37 / 100).toFixed(2)}</span>
              </div>
              <div class="planned-sl">
                <span class="planned-label">Планируемый SL:</span>
                <span class="planned-value negative">-$${(position.amountUSD * 0.25 / 100).toFixed(2)}</span>
              </div>
            </div>
            <div class="position-pnl ${pnl >= 0 ? 'positive' : 'negative'}">
              ${pnl >= 0 ? '+' : ''}$${pnl.toFixed(2)} (${pnlPercent >= 0 ? '+' : ''}${pnlPercent.toFixed(2)}%)
            </div>
            <div class="position-actions">
              <button class="close-btn" onclick="closeRSIPositionByMarket(${position.id})" style="background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%); color: white; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s ease;">
                ⚡ МГНОВЕННО ЗАКРЫТЬ
              </button>
            </div>
          </div>
        `;
      }).join('');
    }
    
    function initializeCryptoGrid() {
      const cryptos = [
        { symbol: 'BTCUSDT', name: 'Bitcoin', icon: '₿' },
        { symbol: 'ETHUSDT', name: 'Ethereum', icon: 'Ξ' },
        { symbol: 'SOLUSDT', name: 'Solana', icon: '◎' },
        { symbol: 'XRPUSDT', name: 'Ripple', icon: 'X' },
        { symbol: 'BNBUSDT', name: 'Binance Coin', icon: 'B' },
        { symbol: 'DOGEUSDT', name: 'Dogecoin', icon: 'Đ' }
      ];
      
      const grid = document.getElementById('cryptoGrid');
      grid.innerHTML = '';
      
      cryptos.forEach(crypto => {
        const card = createCryptoCard(crypto);
        grid.appendChild(card);
      });
    }
    
    function createCryptoCard(crypto) {
      const card = document.createElement('div');
      card.className = 'crypto-card';
      card.id = `card-${crypto.symbol}`;
      
      const iconClass = crypto.symbol.toLowerCase().replace('usdt', '');
      
      card.innerHTML = `
        <div class="header-card">
          <div class="icon ${iconClass}">${crypto.icon}</div>
          <div>
            <div class="title">${crypto.name}</div>
            <div class="subtitle">${crypto.symbol}/USDT Futures</div>
          </div>
        </div>
        
        <div class="price-display">
          <div class="price" id="price-${crypto.symbol}">$0.00000</div>
          <div class="change" id="change-${crypto.symbol}">+0.00%</div>
        </div>
        
        <div class="rsi-indicator">
          <div class="rsi-value neutral" id="rsi-${crypto.symbol}">50.0</div>
          <div class="rsi-label">RSI (14)</div>
        </div>
        
        <div class="rsi-signal neutral" id="signal-${crypto.symbol}">
          Нейтрально
        </div>
        
        <div class="stats">
          <div class="stat">
            <div>24h High</div>
            <div class="stat-value" id="high-${crypto.symbol}">$0.00000</div>
          </div>
          <div class="stat">
            <div>24h Low</div>
            <div class="stat-value" id="low-${crypto.symbol}">$0.00000</div>
          </div>
        </div>
        
        <div class="connection-status">
          <div class="status-dot"></div>
          <span>Подключено к Binance Futures</span>
        </div>
      `;
      
      return card;
    }
    
    function connectWebSocket() {
      const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
      const wsUrl = `${protocol}//${window.location.host}`;
      
      ws = new WebSocket(wsUrl);
      
      ws.onopen = function() {
        console.log('🔗 Подключено к WebSocket серверу');
      };
      
    ws.onmessage = function(event) {
      try {
        const message = JSON.parse(event.data);
        
        if (message.type === 'prices') {
          updatePrices(message.data);
        } else if (message.type === 'analytics3m') {
          updateAnalytics3m(message.data);
        }
      } catch (error) {
        console.error('❌ Ошибка обработки сообщения:', error);
      }
    };
      
      ws.onclose = function() {
        console.log('🔌 WebSocket соединение закрыто');
        setTimeout(connectWebSocket, 5000);
      };
      
      ws.onerror = function(error) {
        console.error('❌ Ошибка WebSocket:', error);
      };
    }
    
    function updatePrices(data) {
      Object.keys(data).forEach(symbol => {
        if (data[symbol] && data[symbol].futures) {
          // Обновляем цены для RSI торговли с проверкой
          const newPrice = data[symbol].futures.price;
          const oldPrice = rsiLastPrices[symbol];
          
          // Проверяем на корректность цены
          if (newPrice && newPrice > 0 && newPrice < 1000000) { // Разумные пределы
            // Проверяем на резкие скачки (более 10% изменения за секунду)
            if (oldPrice && Math.abs(newPrice - oldPrice) / oldPrice > 0.1) {
              console.log(`⚠️ РЕЗКИЙ СКАЧОК ЦЕНЫ ${symbol}: ${oldPrice.toFixed(4)} → ${newPrice.toFixed(4)}`);
              console.log(`   Изменение: ${((newPrice - oldPrice) / oldPrice * 100).toFixed(2)}%`);
              console.log(`   Время: ${new Date().toLocaleTimeString()}`);
              
              // Проверяем, не является ли это реальным резким движением рынка
              // Если изменение в разумных пределах (до 20%), принимаем
              if (Math.abs(newPrice - oldPrice) / oldPrice <= 0.2) {
                console.log(`✅ Принимаем резкое движение рынка для ${symbol}`);
                rsiLastPrices[symbol] = newPrice;
                lastPrices[symbol] = newPrice;
              } else {
                console.log(`❌ Блокируем подозрительное изменение для ${symbol}`);
                return;
              }
            } else {
              // Обычное обновление цены
              rsiLastPrices[symbol] = newPrice;
              lastPrices[symbol] = newPrice;
            }
          } else {
            console.log(`❌ НЕКОРРЕКТНАЯ ЦЕНА ${symbol}: ${newPrice}`);
          }
          
          // Отладочная информация для цен (только при резких движениях)
          if ((symbol === 'BTCUSDT' || symbol === 'BNBUSDT' || symbol === 'ETHUSDT') && 
              oldPrice && Math.abs(newPrice - oldPrice) / oldPrice > 0.05) {
            console.log(`🔍 ОТЛАДКА РЕЗКОГО ДВИЖЕНИЯ ${symbol}:`);
            console.log(`   Старая цена: $${oldPrice.toFixed(4)}`);
            console.log(`   Новая цена: $${newPrice.toFixed(4)}`);
            console.log(`   Изменение: ${((newPrice - oldPrice) / oldPrice * 100).toFixed(2)}%`);
            console.log(`   Время: ${new Date().toLocaleTimeString()}`);
          }
          
          const priceEl = document.getElementById(`price-${symbol}`);
          const changeEl = document.getElementById(`change-${symbol}`);
          const highEl = document.getElementById(`high-${symbol}`);
          const lowEl = document.getElementById(`low-${symbol}`);
          
          if (priceEl) {
            priceEl.textContent = `$${data[symbol].futures.price.toLocaleString('en-US', { minimumFractionDigits: 5, maximumFractionDigits: 5 })}`;
          }
          
          if (changeEl) {
            changeEl.textContent = `${data[symbol].futures.change24h >= 0 ? '+' : ''}${data[symbol].futures.change24h.toFixed(2)}%`;
            changeEl.className = `change ${data[symbol].futures.change24h >= 0 ? 'positive' : 'negative'}`;
          }
          
          if (highEl) {
            highEl.textContent = `$${data[symbol].futures.high24h.toLocaleString('en-US', { minimumFractionDigits: 5, maximumFractionDigits: 5 })}`;
          }
          
          if (lowEl) {
            lowEl.textContent = `$${data[symbol].futures.low24h.toLocaleString('en-US', { minimumFractionDigits: 5, maximumFractionDigits: 5 })}`;
          }
        }
      });
      
      // Обновляем позиции и баланс после обновления цен
      updateRSIPositions();
      updateRSIBalance();
      saveRSIData(); // Сохраняем данные
    }
    
    function updateAnalytics3m(data) {
      Object.keys(data).forEach(symbol => {
        if (data[symbol] && data[symbol].rsi !== undefined) {
          rsiData[symbol] = data[symbol].rsi;
          
          const rsiEl = document.getElementById(`rsi-${symbol}`);
          const signalEl = document.getElementById(`signal-${symbol}`);
          
          if (rsiEl && signalEl) {
            const rsi = data[symbol].rsi;
            rsiEl.textContent = rsi.toFixed(2);
            
            // Обновляем цвет RSI
            rsiEl.className = 'rsi-value';
            if (rsi <= RSI_LONG_THRESHOLD) {
              rsiEl.classList.add('oversold');
            } else if (rsi >= RSI_SHORT_THRESHOLD) {
              rsiEl.classList.add('overbought');
            } else {
              rsiEl.classList.add('neutral');
            }
            
            // Обновляем сигнал
            signalEl.className = 'rsi-signal';
            if (rsi <= RSI_LONG_THRESHOLD) {
              signalEl.textContent = '🟢 LONG';
              signalEl.classList.add('long');
              checkRSISignal(symbol, 'LONG', rsi);
            } else if (rsi >= RSI_SHORT_THRESHOLD) {
              signalEl.textContent = '🔴 SHORT';
              signalEl.classList.add('short');
              checkRSISignal(symbol, 'SHORT', rsi);
            } else {
              signalEl.textContent = '⚪ Нейтрально';
              signalEl.classList.add('neutral');
            }
          }
        }
      });
    }
    
    function checkRSISignal(symbol, direction, rsi) {
      const currentPrice = rsiLastPrices[symbol];
      if (!currentPrice) return;
      
      // Проверяем, включена ли торговля по этой монете
      if (!enabledCoins[symbol]) {
        console.log(`🚫 ${symbol}: Торговля отключена, пропускаем сигнал`);
        return;
      }
      
      // Проверяем, нет ли уже открытой позиции по этой монете
      const existingPosition = rsiOpenPositions.find(pos => pos.symbol === symbol);
      if (existingPosition) {
        console.log(`🚫 ${symbol}: Позиция уже открыта (${existingPosition.direction}), пропускаем`);
        return;
      }
      
      // Проверяем кулдаун
      const now = Date.now();
      if (rsiCooldownSymbols[symbol] && (now - rsiCooldownSymbols[symbol]) < 1000) {
        return; // Кулдаун 1 секунда
      }
      
      // Проверяем доступный баланс (учитываем заблокированные средства)
      const lockedInPositions = rsiOpenPositions.reduce((total, pos) => total + pos.amountUSD, 0);
      const availableBalance = 1000 + rsiRealizedPnL - lockedInPositions;
      const requiredBalance = POSITION_SIZE_USD; // БЕЗ КОМИССИЙ
      
      if (availableBalance < requiredBalance) {
        console.log(`❌ ${symbol}: Недостаточно средств для RSI сделки`);
        console.log(`   Доступно: $${availableBalance.toFixed(2)}, требуется: $${requiredBalance.toFixed(2)}`);
        console.log(`   Заблокировано в позициях: $${lockedInPositions.toFixed(2)}`);
        return;
      }
      
      // Открываем позицию
      openRSIPosition(symbol, direction, currentPrice, rsi);
      rsiCooldownSymbols[symbol] = now;
    }
    
    function openRSIPosition(symbol, direction, entryPrice, rsi) {
      const volume = POSITION_SIZE_USD / entryPrice;
      const openCommission = 0; // БЕЗ КОМИССИЙ для тестирования
      
      // RSI Long Only стратегия: TP 0.5%, SL 0.25%
      const tpPrice = direction === 'LONG' 
        ? entryPrice * (1 + 0.5 / 100) 
        : entryPrice * (1 - 0.5 / 100);
      const slPrice = direction === 'LONG' 
        ? entryPrice * (1 - 0.25 / 100)
        : entryPrice * (1 + 0.25 / 100);
      
      // ОТЛАДКА РАСЧЕТА TP/SL
      console.log(`🔍 ОТЛАДКА TP/SL для ${symbol} ${direction}:`);
      console.log(`   Вход: $${entryPrice.toFixed(4)}`);
      console.log(`   TP: $${tpPrice.toFixed(4)} (${direction === 'LONG' ? '+' : '-'}0.5%)`);
      console.log(`   SL: $${slPrice.toFixed(4)} (${direction === 'LONG' ? '-' : '+'}0.25%)`);
      console.log(`   Проверка TP: ${entryPrice.toFixed(4)} * ${direction === 'LONG' ? '1.005' : '0.995'} = ${tpPrice.toFixed(4)}`);
      console.log(`   Проверка SL: ${entryPrice.toFixed(4)} * ${direction === 'LONG' ? '0.9975' : '1.0025'} = ${slPrice.toFixed(4)}`);
      
      const position = {
        id: Date.now(),
        symbol: symbol,
        direction: direction,
        entryPrice: entryPrice,
        volume: volume,
        amountUSD: POSITION_SIZE_USD,
        tpPercent: 0.37,
        slPercent: 0.25,
        tpPrice: tpPrice,
        slPrice: slPrice,
        openCommission: openCommission,
        closeCommission: 0,
        totalCommission: openCommission,
        confidence: rsi <= RSI_LONG_THRESHOLD ? 85 : 85, // RSI экстремумы = высокая уверенность
        openTime: Date.now(),
        currentPrice: entryPrice,
        unrealizedPnL: 0,
        grossPnL: 0,
        netPnL: 0,
        strategy: 'RSI'
      };
      
      rsiOpenPositions.push(position);
      // НЕ вычитаем из баланса - баланс = начальный + реализованный PnL
      rsiTotalCommissions += openCommission;
      
      console.log(`🚀 RSI ПОЗИЦИЯ: ${symbol} ${direction} @ $${entryPrice.toFixed(5)}`);
      console.log(`   RSI: ${rsi.toFixed(1)}, TP: $${tpPrice.toFixed(5)}, SL: $${slPrice.toFixed(5)}`);
      console.log(`   Объем: ${volume.toFixed(6)}, Сумма: $${POSITION_SIZE_USD.toFixed(2)}`);
      console.log(`   Планируемый TP: +$${(POSITION_SIZE_USD * 0.5 / 100).toFixed(2)}`);
      console.log(`   Планируемый SL: -$${(POSITION_SIZE_USD * 0.25 / 100).toFixed(2)}`);
      
      updateRSIPositions();
      updateRSIBalance();
      saveRSIData(); // Сохраняем данные
    }

    // Функция закрытия RSI позиции
    function closeRSIPosition(positionId, exitPrice, reason) {
      console.log(`🔍 Закрытие позиции ID: ${positionId} (тип: ${typeof positionId})`);
      const positionIndex = rsiOpenPositions.findIndex(pos => pos.id === positionId);
      if (positionIndex === -1) {
        console.log('❌ Позиция не найдена для закрытия');
        return;
      }

      const position = rsiOpenPositions[positionIndex];
      const closeCommission = 0; // БЕЗ КОМИССИЙ для тестирования
      
      // Расчет PnL БЕЗ КОМИССИЙ
      const pnl = position.direction === 'LONG' 
        ? (exitPrice - position.entryPrice) * position.volume
        : (position.entryPrice - exitPrice) * position.volume;
      
      const netPnL = pnl; // БЕЗ КОМИССИЙ
      const pnlPercent = (netPnL / position.amountUSD) * 100;
      
      console.log(`💰 Закрытие ${position.symbol} ${position.direction}:`);
      console.log(`   Вход: $${position.entryPrice.toFixed(4)}, Выход: $${exitPrice.toFixed(4)}`);
      console.log(`   Объем: ${position.volume.toFixed(6)}, Сумма: $${position.amountUSD.toFixed(2)}`);
      console.log(`   PnL: $${netPnL.toFixed(2)} (${pnlPercent.toFixed(2)}%)`);
      console.log(`   Причина: ${reason}`);
      console.log(`🔍 ОТЛАДКА ЦЕН:`);
      console.log(`   Текущая цена из rsiLastPrices: $${rsiLastPrices[position.symbol]?.toFixed(4) || 'НЕТ'}`);
      console.log(`   Цена входа: $${position.entryPrice.toFixed(4)}`);
      console.log(`   Цена выхода: $${exitPrice.toFixed(4)}`);
      console.log(`   Разница: ${((exitPrice - position.entryPrice) / position.entryPrice * 100).toFixed(2)}%`);

      // Создаем закрытую сделку
      const closedDeal = {
        ...position,
        exitPrice: exitPrice,
        closeTime: Date.now(),
        closeCommission: closeCommission,
        totalCommission: position.openCommission + closeCommission,
        pnl: pnl,
        netPnL: netPnL,
        pnlPercent: pnlPercent,
        closeReason: reason
      };

      // Перемещаем в историю (проверяем на дублирование)
      const existingDeal = rsiClosedDeals.find(deal => deal.id === closedDeal.id);
      if (!existingDeal) {
        rsiClosedDeals.unshift(closedDeal); // Добавляем в начало массива (новые первыми)
        console.log(`📋 Новая сделка добавлена в историю: ${closedDeal.symbol} ${closedDeal.direction}`);
      } else {
        console.log(`⚠️ Сделка уже существует в истории: ${closedDeal.symbol} ${closedDeal.direction}`);
      }
      rsiOpenPositions.splice(positionIndex, 1);
      
      // Обновляем реализованный PnL (баланс = начальный + реализованный PnL)
      const oldRealizedPnL = rsiRealizedPnL;
      rsiRealizedPnL += netPnL;
      // rsiTotalCommissions += closeCommission; // БЕЗ КОМИССИЙ

      console.log(`🔒 RSI позиция закрыта: ${position.symbol} ${position.direction} @ $${exitPrice.toFixed(5)}`);
      console.log(`   PnL: ${netPnL >= 0 ? '+' : ''}$${netPnL.toFixed(2)} (${pnlPercent >= 0 ? '+' : ''}${pnlPercent.toFixed(2)}%)`);
      console.log(`   Причина: ${reason}`);
      console.log(`   Реализованный PnL: $${oldRealizedPnL.toFixed(2)} → $${rsiRealizedPnL.toFixed(2)} (+$${netPnL.toFixed(2)})`);
      console.log(`📋 Сделка добавлена в историю. Всего сделок: ${rsiClosedDeals.length}`);

      updateRSIPositions();
      updateRSIBalance();
      updateRSIHistory();
      saveRSIData(); // Сохраняем данные
    }

    // Обновление истории сделок RSI
    function updateRSIHistory() {
      const container = document.getElementById('rsiHistoryContainer');
      const pagination = document.getElementById('rsiPagination');
      
      if (rsiClosedDeals.length === 0) {
        container.innerHTML = `
          <div class="no-history">
            <div class="no-history-icon">📝</div>
            <div class="no-history-text">История сделок пуста</div>
            <div class="no-history-desc">Закрытые сделки будут отображаться здесь</div>
          </div>
        `;
        pagination.style.display = 'none';
        updateRSIHistoryStats();
        return;
      }

      // Сделки уже отсортированы (новые добавлены в начало массива)
      const sortedDeals = rsiClosedDeals;
      
      // Вычисляем пагинацию
      const totalPages = Math.ceil(sortedDeals.length / rsiDealsPerPage);
      const startIndex = (rsiCurrentPage - 1) * rsiDealsPerPage;
      const endIndex = startIndex + rsiDealsPerPage;
      const pageDeals = sortedDeals.slice(startIndex, endIndex);

      // Отображаем сделки
      container.innerHTML = `
        <div class="history-list">
          ${pageDeals.map(deal => {
            const isProfit = deal.netPnL > 0;
            const duration = Math.round((deal.closeTime - deal.openTime) / 1000 / 60); // минуты
            const closeTime = new Date(deal.closeTime).toLocaleString('ru-RU', {
              year: 'numeric',
              month: '2-digit',
              day: '2-digit',
              hour: '2-digit',
              minute: '2-digit',
              second: '2-digit',
              hour12: false
            });
            
            return `
              <div class="history-item ${deal.direction.toLowerCase()} ${isProfit ? 'profit' : 'loss'}">
                <div class="history-main">
                  <div class="history-symbol">${deal.symbol}</div>
                  <div class="history-direction ${deal.direction.toLowerCase()}">${deal.direction}</div>
                  <div class="history-prices">
                    <div>Вход: $${deal.entryPrice.toFixed(4)}</div>
                    <div>Выход: $${deal.exitPrice.toFixed(4)}</div>
                    <div class="history-time">${closeTime} (${duration}м)</div>
                  </div>
                </div>
                <div class="history-pnl ${isProfit ? 'positive' : 'negative'}">
                  ${isProfit ? '+' : ''}$${deal.netPnL.toFixed(2)}
                  <div style="font-size: 11px; color: #a0aec0;">
                    ${isProfit ? '+' : ''}${deal.pnlPercent.toFixed(2)}%
                  </div>
                </div>
              </div>
            `;
          }).join('')}
        </div>
      `;

      // Обновляем пагинацию
      updateRSIPagination(totalPages);
      updateRSIHistoryStats();
      updateCryptoStats(); // Обновляем статистику по монетам
      updateLongShortStats(); // Обновляем статистику LONG/SHORT
      updateLossesStats(); // Обновляем статистику убытков
    }

    // Обновление статистики истории
    function updateRSIHistoryStats() {
      const totalDeals = rsiClosedDeals.length;
      const winningDeals = rsiClosedDeals.filter(deal => deal.netPnL > 0).length;
      const losingDeals = rsiClosedDeals.filter(deal => deal.netPnL < 0).length;
      const winRate = totalDeals > 0 ? (winningDeals / totalDeals * 100).toFixed(1) : 0;
      
      // Проверяем сумму всех сделок
      const totalPnLFromHistory = rsiClosedDeals.reduce((sum, deal) => sum + deal.netPnL, 0);
      console.log(`📊 Статистика истории: Всего сделок: ${totalDeals}, Сумма PnL: $${totalPnLFromHistory.toFixed(2)}, Реализованный PnL: $${rsiRealizedPnL.toFixed(2)}`);
      
      if (Math.abs(totalPnLFromHistory - rsiRealizedPnL) > 0.01) {
        console.warn(`⚠️ НЕСООТВЕТСТВИЕ: Сумма сделок ($${totalPnLFromHistory.toFixed(2)}) ≠ Реализованный PnL ($${rsiRealizedPnL.toFixed(2)})`);
      }

      document.getElementById('rsiTotalDeals').textContent = totalDeals;
      document.getElementById('rsiWinningDeals').textContent = winningDeals;
      document.getElementById('rsiLosingDeals').textContent = losingDeals;
      document.getElementById('rsiHistoryWinRate').textContent = `${winRate}%`;
    }

    // Обновление пагинации
    function updateRSIPagination(totalPages) {
      const pagination = document.getElementById('rsiPagination');
      const pageInfo = document.getElementById('rsiPageInfo');
      const prevBtn = document.getElementById('rsiPrevPage');
      const nextBtn = document.getElementById('rsiNextPage');

      if (totalPages <= 1) {
        pagination.style.display = 'none';
        return;
      }

      pagination.style.display = 'flex';
      pageInfo.textContent = `Страница ${rsiCurrentPage} из ${totalPages}`;
      
      prevBtn.disabled = rsiCurrentPage <= 1;
      nextBtn.disabled = rsiCurrentPage >= totalPages;
    }

    // Смена страницы
    function changeRSIPage(direction) {
      const totalPages = Math.ceil(rsiClosedDeals.length / rsiDealsPerPage);
      const newPage = rsiCurrentPage + direction;
      
      if (newPage >= 1 && newPage <= totalPages) {
        rsiCurrentPage = newPage;
        updateRSIHistory();
        saveRSIData(); // Сохраняем данные
      }
    }

    // Очистка всех данных RSI
    function clearRSIData() {
      if (confirm('⚠️ Вы уверены, что хотите очистить ВСЕ данные RSI?\n\nЭто удалит:\n- Все открытые позиции\n- Всю историю сделок\n- Статистику и баланс\n\nДействие необратимо!')) {
        rsiOpenPositions = [];
        rsiClosedDeals = [];
        rsiRealizedPnL = 0;
        rsiTotalCommissions = 0;
        rsiCooldownSymbols = {};
        rsiLastPrices = {};
        rsiCurrentPage = 1;
        
        localStorage.removeItem('rsiLongTradingData');
        
        updateRSIBalance();
        updateRSIPositions();
        updateRSIHistory();
        
        console.log('🗑️ Все данные RSI очищены');
      }
    }

    // Функция закрытия позиции по рынку (ручное закрытие)
    function closeRSIPositionByMarket(positionId) {
      console.log(`🔍 ПОИСК ПОЗИЦИИ: ID=${positionId}, тип=${typeof positionId}`);
      console.log(`📊 ВСЕ ПОЗИЦИИ:`, rsiOpenPositions);
      console.log(`📊 КОЛИЧЕСТВО ПОЗИЦИЙ:`, rsiOpenPositions.length);
      
      // Проверяем, что позиции есть
      if (rsiOpenPositions.length === 0) {
        console.log('❌ НЕТ ОТКРЫТЫХ ПОЗИЦИЙ');
        alert('❌ Нет открытых позиций для закрытия');
        return;
      }

      // Ищем позицию по разным типам ID
      let position = null;
      let numericId = null;

      console.log(`🔍 ПОИСК ПО ID: ${positionId}`);
      
      // Пробуем найти как число
      numericId = parseInt(positionId);
      console.log(`🔍 ПАРСИНГ ID: ${numericId}`);
      position = rsiOpenPositions.find(pos => pos.id === numericId);
      console.log(`🔍 ПОИСК ПО ===:`, position);
      
      // Если не найдено, пробуем найти как строку
      if (!position) {
        console.log(`🔍 ПОИСК ПО == (строка)`);
        position = rsiOpenPositions.find(pos => pos.id == positionId);
        console.log(`🔍 ПОИСК ПО ==:`, position);
        if (position) {
          numericId = position.id;
        }
      }

      if (!position) {
        console.log('❌ ПОЗИЦИЯ НЕ НАЙДЕНА');
        console.log(`❌ ИСКОМЫЙ ID: ${positionId}`);
        console.log(`❌ ДОСТУПНЫЕ ID:`, rsiOpenPositions.map(p => p.id));
        alert(`❌ Позиция с ID ${positionId} не найдена`);
        return;
      }

      console.log(`✅ ПОЗИЦИЯ НАЙДЕНА:`, position);

      // Получаем текущую цену с проверкой
      const currentPrice = rsiLastPrices[position.symbol];
      console.log(`💰 ТЕКУЩАЯ ЦЕНА: ${position.symbol} = $${currentPrice}`);
      console.log(`💰 ВСЕ ЦЕНЫ:`, rsiLastPrices);
      
      if (!currentPrice || currentPrice <= 0) {
        console.log('❌ ТЕКУЩАЯ ЦЕНА НЕДОСТУПНА');
        console.log(`❌ ЦЕНА: ${currentPrice}`);
        alert(`❌ Текущая цена для ${position.symbol} недоступна. Попробуйте позже.`);
        return;
      }

      // МГНОВЕННОЕ ЗАКРЫТИЕ БЕЗ ПОДТВЕРЖДЕНИЯ
      console.log(`🚀 МГНОВЕННОЕ ЗАКРЫТИЕ БЕЗ ПОДТВЕРЖДЕНИЯ`);
      console.log(`   Позиция: ${position.symbol} ${position.direction}`);
      console.log(`   Вход: $${position.entryPrice.toFixed(4)}`);
      console.log(`   Текущая: $${currentPrice.toFixed(4)}`);
      console.log(`   PnL: ${((currentPrice - position.entryPrice) * position.volume * (position.direction === 'LONG' ? 1 : -1)).toFixed(2)}`);

      // Закрываем БЕЗ подтверждения
      {
        try {
          console.log(`🚀 НАЧИНАЕМ ЗАКРЫТИЕ: ${position.symbol} ${position.direction}`);
          console.log(`   ID: ${numericId}, Цена: $${currentPrice.toFixed(4)}`);
          console.log(`   Вход: $${position.entryPrice.toFixed(4)}`);
          
          console.log(`🔧 ВЫЗЫВАЕМ closeRSIPosition...`);
          const result = closeRSIPosition(numericId, currentPrice, 'Закрыто вручную');
          console.log(`🔧 РЕЗУЛЬТАТ closeRSIPosition:`, result);
          
          console.log(`🔄 ОБНОВЛЯЕМ ИНТЕРФЕЙС...`);
          updateRSIPositions();
          updateRSIBalance();
          updateRSIHistory();
          
          console.log(`✅ ПОЗИЦИЯ ЗАКРЫТА И ИНТЕРФЕЙС ОБНОВЛЕН!`);
          alert(`✅ Позиция ${position.symbol} закрыта мгновенно!`);
          
        } catch (error) {
          console.error('❌ ОШИБКА ПРИ ЗАКРЫТИИ:', error);
          console.error('❌ СТЕК ОШИБКИ:', error.stack);
          alert('❌ Ошибка при закрытии позиции. Попробуйте еще раз.');
        }
      }
    }

    // Обновление статистики по монетам
    function updateCryptoStats() {
      const container = document.getElementById('cryptoStatsGrid');
      if (!container) return;

      // Подсчитываем статистику по каждой монете
      const cryptoStats = {};
      const cryptos = ['BTCUSDT', 'ETHUSDT', 'SOLUSDT', 'XRPUSDT', 'BNBUSDT', 'DOGEUSDT'];
      
      // Инициализируем статистику для всех монет
      cryptos.forEach(symbol => {
        cryptoStats[symbol] = {
          symbol: symbol,
          totalDeals: 0,
          profitableDeals: 0,
          totalPnL: 0,
          winRate: 0,
          avgPnL: 0,
          totalTP: 0,
          totalSL: 0,
          avgTP: 0,
          avgSL: 0
        };
      });

      // Анализируем историю сделок
      rsiClosedDeals.forEach(deal => {
        const symbol = deal.symbol;
        if (cryptoStats[symbol]) {
          cryptoStats[symbol].totalDeals++;
          cryptoStats[symbol].totalPnL += deal.pnl;
          
          if (deal.pnl > 0) {
            cryptoStats[symbol].profitableDeals++;
            cryptoStats[symbol].totalTP += deal.pnl; // Прибыльные сделки = тейк-профит
          } else {
            cryptoStats[symbol].totalSL += Math.abs(deal.pnl); // Убыточные сделки = стоп-лосс
          }
        }
      });

      // Рассчитываем дополнительные метрики
      Object.values(cryptoStats).forEach(stat => {
        if (stat.totalDeals > 0) {
          stat.winRate = (stat.profitableDeals / stat.totalDeals * 100).toFixed(1);
          stat.avgPnL = (stat.totalPnL / stat.totalDeals).toFixed(2);
          
          // Средний тейк-профит
          if (stat.profitableDeals > 0) {
            stat.avgTP = (stat.totalTP / stat.profitableDeals).toFixed(2);
          }
          
          // Средний стоп-лосс
          const losingDeals = stat.totalDeals - stat.profitableDeals;
          if (losingDeals > 0) {
            stat.avgSL = (stat.totalSL / losingDeals).toFixed(2);
          }
        }
      });

      // Сортируем статистику по убыванию PnL (от прибыльной к убыточной)
      const sortedStats = Object.values(cryptoStats).sort((a, b) => b.totalPnL - a.totalPnL);
      const topProfit = sortedStats[0];
      const topLoss = sortedStats[sortedStats.length - 1];

      // Рассчитываем общую статистику
      const overallStats = {
        totalDeals: 0,
        totalPnL: 0,
        totalTP: 0,
        totalSL: 0,
        profitableDeals: 0,
        losingDeals: 0,
        avgTP: 0,
        avgSL: 0,
        winRate: 0
      };

      Object.values(cryptoStats).forEach(stat => {
        overallStats.totalDeals += stat.totalDeals;
        overallStats.totalPnL += stat.totalPnL;
        overallStats.totalTP += stat.totalTP;
        overallStats.totalSL += stat.totalSL;
        overallStats.profitableDeals += stat.profitableDeals;
        overallStats.losingDeals += (stat.totalDeals - stat.profitableDeals);
      });

      // Рассчитываем общие средние значения
      if (overallStats.profitableDeals > 0) {
        overallStats.avgTP = (overallStats.totalTP / overallStats.profitableDeals).toFixed(2);
      }
      if (overallStats.losingDeals > 0) {
        overallStats.avgSL = (overallStats.totalSL / overallStats.losingDeals).toFixed(2);
      }
      if (overallStats.totalDeals > 0) {
        overallStats.winRate = (overallStats.profitableDeals / overallStats.totalDeals * 100).toFixed(1);
      }

      // Отображаем общую статистику
      const overallContainer = document.getElementById('overallStats');
      if (overallContainer) {
        overallContainer.innerHTML = `
          <h3>🎯 Общая статистика по всем монетам</h3>
          <div class="overall-metrics">
            <div class="overall-metric">
              <div class="overall-metric-label">Всего сделок</div>
              <div class="overall-metric-value">${overallStats.totalDeals}</div>
            </div>
            <div class="overall-metric">
              <div class="overall-metric-label">Общий PnL</div>
              <div class="overall-metric-value">${overallStats.totalPnL > 0 ? '+' : ''}${overallStats.totalPnL.toFixed(2)} USDT</div>
            </div>
            <div class="overall-metric">
              <div class="overall-metric-label">Винрейт</div>
              <div class="overall-metric-value">${overallStats.winRate}%</div>
            </div>
            <div class="overall-metric">
              <div class="overall-metric-label">Средний Тейк</div>
              <div class="overall-metric-value">${overallStats.avgTP} USDT</div>
            </div>
            <div class="overall-metric">
              <div class="overall-metric-label">Средний Стоп</div>
              <div class="overall-metric-value">${overallStats.avgSL} USDT</div>
            </div>
          </div>
        `;
      }

      // Отображаем статистику
      container.innerHTML = sortedStats.map(stat => {
        const iconClass = stat.symbol.toLowerCase().replace('usdt', '');
        const iconMap = {
          'btc': '₿',
          'eth': 'Ξ',
          'sol': '◎',
          'xrp': 'X',
          'bnb': 'B',
          'doge': 'Đ'
        };

        // Определяем класс карточки
        let cardClass = 'stat-card';
        if (stat.symbol === topProfit.symbol && stat.totalPnL > 0) {
          cardClass += ' top-profit';
        } else if (stat.symbol === topLoss.symbol && stat.totalPnL < 0) {
          cardClass += ' top-loss';
        } else if (stat.totalPnL > 0) {
          cardClass += ' profitable';
        } else if (stat.totalPnL < 0) {
          cardClass += ' loss';
        }

        // Определяем класс PnL
        let pnlClass = 'stat-pnl';
        if (stat.totalPnL > 0) {
          pnlClass += ' positive';
        } else if (stat.totalPnL < 0) {
          pnlClass += ' negative';
        } else {
          pnlClass += ' neutral';
        }

        // Определяем бейдж
        let badge = '';
        if (stat.symbol === topProfit.symbol && stat.totalPnL > 0) {
          badge = '<div class="stat-badge top-profit">ТОП ПРИБЫЛЬ</div>';
        } else if (stat.symbol === topLoss.symbol && stat.totalPnL < 0) {
          badge = '<div class="stat-badge top-loss">ТОП УБЫТОК</div>';
        }

        return `
          <div class="${cardClass}">
            ${badge}
            <div class="stat-header">
              <div class="stat-icon ${iconClass}">${iconMap[iconClass] || '?'}</div>
              <div class="stat-title">${stat.symbol}</div>
            </div>
            
            <div class="stat-metrics">
              <div class="stat-metric">
                <div class="stat-metric-label">Сделок</div>
                <div class="stat-metric-value">${stat.totalDeals}</div>
              </div>
              <div class="stat-metric">
                <div class="stat-metric-label">Винрейт</div>
                <div class="stat-metric-value">${stat.winRate}%</div>
              </div>
              <div class="stat-metric">
                <div class="stat-metric-label">Ср. Тейк</div>
                <div class="stat-metric-value">${stat.avgTP || '0.00'}</div>
              </div>
              <div class="stat-metric">
                <div class="stat-metric-label">Ср. Стоп</div>
                <div class="stat-metric-value">${stat.avgSL || '0.00'}</div>
              </div>
            </div>
            
            <div class="${pnlClass}">
              ${stat.totalPnL > 0 ? '+' : ''}${stat.totalPnL.toFixed(2)} USDT
            </div>
          </div>
        `;
      }).join('');
    }

    // Обновление статистики LONG/SHORT
    function updateLongShortStats() {
      const container = document.getElementById('longShortStatsGrid');
      if (!container) return;

      // Подсчитываем статистику по LONG и SHORT сделкам
      const longStats = {
        totalDeals: 0,
        profitableDeals: 0,
        losingDeals: 0,
        totalPnL: 0,
        totalProfit: 0,
        totalLoss: 0
      };

      const shortStats = {
        totalDeals: 0,
        profitableDeals: 0,
        losingDeals: 0,
        totalPnL: 0,
        totalProfit: 0,
        totalLoss: 0
      };

      // Анализируем все закрытые сделки
      rsiClosedDeals.forEach(deal => {
        if (deal.direction === 'LONG') {
          longStats.totalDeals++;
          longStats.totalPnL += deal.pnl;
          
          if (deal.pnl > 0) {
            longStats.profitableDeals++;
            longStats.totalProfit += deal.pnl;
          } else {
            longStats.losingDeals++;
            longStats.totalLoss += Math.abs(deal.pnl);
          }
        } else if (deal.direction === 'SHORT') {
          shortStats.totalDeals++;
          shortStats.totalPnL += deal.pnl;
          
          if (deal.pnl > 0) {
            shortStats.profitableDeals++;
            shortStats.totalProfit += deal.pnl;
          } else {
            shortStats.losingDeals++;
            shortStats.totalLoss += Math.abs(deal.pnl);
          }
        }
      });

      // Рассчитываем проценты
      const longWinRate = longStats.totalDeals > 0 ? ((longStats.profitableDeals / longStats.totalDeals) * 100).toFixed(1) : 0;
      const shortWinRate = shortStats.totalDeals > 0 ? ((shortStats.profitableDeals / shortStats.totalDeals) * 100).toFixed(1) : 0;

      // Отображаем статистику
      container.innerHTML = `
        <div class="long-short-card long">
          <div class="long-short-header">
            <div class="long-short-icon long">📈</div>
            <div class="long-short-title">LONG Сделки</div>
          </div>
          <div class="long-short-stats">
            <div class="long-short-stat">
              <div class="long-short-stat-label">Всего сделок</div>
              <div class="long-short-stat-value">${longStats.totalDeals}</div>
            </div>
            <div class="long-short-stat">
              <div class="long-short-stat-label">Прибыльных</div>
              <div class="long-short-stat-value positive">${longStats.profitableDeals}</div>
            </div>
            <div class="long-short-stat">
              <div class="long-short-stat-label">Убыточных</div>
              <div class="long-short-stat-value negative">${longStats.losingDeals}</div>
            </div>
            <div class="long-short-stat">
              <div class="long-short-stat-label">Винрейт</div>
              <div class="long-short-stat-value">${longWinRate}%</div>
            </div>
            <div class="long-short-stat">
              <div class="long-short-stat-label">Общий PnL</div>
              <div class="long-short-stat-value ${longStats.totalPnL >= 0 ? 'positive' : 'negative'}">$${longStats.totalPnL.toFixed(2)}</div>
            </div>
            <div class="long-short-stat">
              <div class="long-short-stat-label">Прибыль</div>
              <div class="long-short-stat-value positive">$${longStats.totalProfit.toFixed(2)}</div>
            </div>
            <div class="long-short-stat">
              <div class="long-short-stat-label">Убытки</div>
              <div class="long-short-stat-value negative">$${longStats.totalLoss.toFixed(2)}</div>
            </div>
            <div class="long-short-stat">
              <div class="long-short-stat-label">Средний PnL</div>
              <div class="long-short-stat-value ${longStats.totalDeals > 0 ? (longStats.totalPnL / longStats.totalDeals >= 0 ? 'positive' : 'negative') : ''}">
                ${longStats.totalDeals > 0 ? '$' + (longStats.totalPnL / longStats.totalDeals).toFixed(2) : '$0.00'}
              </div>
            </div>
          </div>
        </div>

        <div class="long-short-card short">
          <div class="long-short-header">
            <div class="long-short-icon short">📉</div>
            <div class="long-short-title">SHORT Сделки</div>
          </div>
          <div class="long-short-stats">
            <div class="long-short-stat">
              <div class="long-short-stat-label">Всего сделок</div>
              <div class="long-short-stat-value">${shortStats.totalDeals}</div>
            </div>
            <div class="long-short-stat">
              <div class="long-short-stat-label">Прибыльных</div>
              <div class="long-short-stat-value positive">${shortStats.profitableDeals}</div>
            </div>
            <div class="long-short-stat">
              <div class="long-short-stat-label">Убыточных</div>
              <div class="long-short-stat-value negative">${shortStats.losingDeals}</div>
            </div>
            <div class="long-short-stat">
              <div class="long-short-stat-label">Винрейт</div>
              <div class="long-short-stat-value">${shortWinRate}%</div>
            </div>
            <div class="long-short-stat">
              <div class="long-short-stat-label">Общий PnL</div>
              <div class="long-short-stat-value ${shortStats.totalPnL >= 0 ? 'positive' : 'negative'}">$${shortStats.totalPnL.toFixed(2)}</div>
            </div>
            <div class="long-short-stat">
              <div class="long-short-stat-label">Прибыль</div>
              <div class="long-short-stat-value positive">$${shortStats.totalProfit.toFixed(2)}</div>
            </div>
            <div class="long-short-stat">
              <div class="long-short-stat-label">Убытки</div>
              <div class="long-short-stat-value negative">$${shortStats.totalLoss.toFixed(2)}</div>
            </div>
            <div class="long-short-stat">
              <div class="long-short-stat-label">Средний PnL</div>
              <div class="long-short-stat-value ${shortStats.totalDeals > 0 ? (shortStats.totalPnL / shortStats.totalDeals >= 0 ? 'positive' : 'negative') : ''}">
                ${shortStats.totalDeals > 0 ? '$' + (shortStats.totalPnL / shortStats.totalDeals).toFixed(2) : '$0.00'}
              </div>
            </div>
          </div>
        </div>
      `;
    }

    // Обновление статистики убыточных сделок
    function updateLossesStats() {
      const container = document.getElementById('lossesGrid');
      if (!container) return;

      // Подсчитываем убыточные сделки по каждой монете
      const lossesStats = {};
      const cryptos = ['BTCUSDT', 'ETHUSDT', 'SOLUSDT', 'XRPUSDT', 'BNBUSDT', 'DOGEUSDT'];

      // Инициализируем статистику для всех монет
      cryptos.forEach(symbol => {
        lossesStats[symbol] = {
          symbol: symbol,
          losingDeals: 0,
          totalLoss: 0,
          avgLoss: 0
        };
      });

      // Анализируем убыточные сделки
      rsiClosedDeals.forEach(deal => {
        if (deal.pnl < 0) { // Только убыточные сделки
          const symbol = deal.symbol;
          if (lossesStats[symbol]) {
            lossesStats[symbol].losingDeals++;
            lossesStats[symbol].totalLoss += Math.abs(deal.pnl);
          }
        }
      });

      // Рассчитываем средний убыток
      Object.values(lossesStats).forEach(stat => {
        if (stat.losingDeals > 0) {
          stat.avgLoss = (stat.totalLoss / stat.losingDeals).toFixed(2);
        }
      });

      // Фильтруем только монеты с убытками и сортируем по убытку
      const sortedLosses = Object.values(lossesStats)
        .filter(stat => stat.losingDeals > 0)
        .sort((a, b) => b.totalLoss - a.totalLoss);

      // Отображаем статистику убытков
      container.innerHTML = sortedLosses.map(stat => {
        const iconClass = stat.symbol.toLowerCase().replace('usdt', '');
        const iconMap = {
          'btc': '₿',
          'eth': 'Ξ',
          'sol': '◎',
          'xrp': 'X',
          'bnb': 'B',
          'doge': 'Đ'
        };

        return `
          <div class="loss-card">
            <div class="loss-badge">УБЫТОК</div>
            <div class="loss-header">
              <div class="loss-icon ${iconClass}">${iconMap[iconClass] || '?'}</div>
              <div class="loss-title">${stat.symbol}</div>
            </div>

            <div class="loss-metrics">
              <div class="loss-metric">
                <div class="loss-metric-label">Убыточных</div>
                <div class="loss-metric-value">${stat.losingDeals}</div>
              </div>
              <div class="loss-metric">
                <div class="loss-metric-label">Средний</div>
                <div class="loss-metric-value">${stat.avgLoss} USDT</div>
              </div>
            </div>

            <div class="loss-amount">
              -${stat.totalLoss.toFixed(2)} USDT
            </div>
          </div>
        `;
      }).join('');

      // Если нет убыточных сделок, показываем сообщение
      if (sortedLosses.length === 0) {
        container.innerHTML = `
          <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #666;">
            <div style="font-size: 48px; margin-bottom: 20px;">🎉</div>
            <h3 style="color: #4CAF50; margin-bottom: 10px;">Отлично!</h3>
            <p>У вас пока нет убыточных сделок по RSI стратегии</p>
          </div>
        `;
      }
    }

    // Инициализация управления торговлей
    function initializeTradingControls() {
      const container = document.getElementById('coinsToggleGrid');
      if (!container) return;

      const cryptos = ['BTCUSDT', 'ETHUSDT', 'SOLUSDT', 'XRPUSDT', 'BNBUSDT', 'DOGEUSDT'];
      const iconMap = {
        'BTCUSDT': { icon: '₿', class: 'btc' },
        'ETHUSDT': { icon: 'Ξ', class: 'eth' },
        'SOLUSDT': { icon: '◎', class: 'sol' },
        'XRPUSDT': { icon: 'X', class: 'xrp' },
        'BNBUSDT': { icon: 'B', class: 'bnb' },
        'DOGEUSDT': { icon: 'Đ', class: 'doge' }
      };

      container.innerHTML = cryptos.map(symbol => {
        const isEnabled = enabledCoins[symbol];
        const iconData = iconMap[symbol];
        
        return `
          <div class="coin-toggle ${isEnabled ? '' : 'disabled'}" data-symbol="${symbol}">
            <div class="coin-info">
              <div class="coin-icon ${iconData.class}">${iconData.icon}</div>
              <div>
                <div class="coin-name">${symbol}</div>
                <div class="coin-status">${isEnabled ? 'Торговля включена' : 'Торговля отключена'}</div>
              </div>
            </div>
            <div class="toggle-switch ${isEnabled ? 'active' : 'disabled'}" data-symbol="${symbol}">
              <div class="toggle-slider"></div>
            </div>
          </div>
        `;
      }).join('');

      // Обработчики событий для переключателей
      container.addEventListener('click', function(e) {
        const toggle = e.target.closest('.toggle-switch');
        if (toggle) {
          const symbol = toggle.dataset.symbol;
          toggleCoin(symbol);
        }
      });

      // Обработчики для кнопок "Включить все" / "Отключить все"
      document.getElementById('enableAllCoins')?.addEventListener('click', () => {
        Object.keys(enabledCoins).forEach(symbol => {
          enabledCoins[symbol] = true;
        });
        updateTradingControls();
        saveRSIData();
        console.log('✅ Торговля включена для всех монет');
      });

      document.getElementById('disableAllCoins')?.addEventListener('click', () => {
        Object.keys(enabledCoins).forEach(symbol => {
          enabledCoins[symbol] = false;
        });
        updateTradingControls();
        saveRSIData();
        console.log('❌ Торговля отключена для всех монет');
      });
    }

    // Переключение монеты
    function toggleCoin(symbol) {
      enabledCoins[symbol] = !enabledCoins[symbol];
      updateTradingControls();
      saveRSIData();
      
      const status = enabledCoins[symbol] ? 'включена' : 'отключена';
      console.log(`🔄 Торговля ${symbol} ${status}`);
    }

    // Обновление интерфейса управления
    function updateTradingControls() {
      const container = document.getElementById('coinsToggleGrid');
      if (!container) return;

      container.querySelectorAll('.coin-toggle').forEach(toggle => {
        const symbol = toggle.dataset.symbol;
        const isEnabled = enabledCoins[symbol];
        const toggleSwitch = toggle.querySelector('.toggle-switch');
        const statusText = toggle.querySelector('.coin-status');
        
        toggle.classList.toggle('disabled', !isEnabled);
        toggleSwitch.classList.toggle('active', isEnabled);
        toggleSwitch.classList.toggle('disabled', !isEnabled);
        statusText.textContent = isEnabled ? 'Торговля включена' : 'Торговля отключена';
      });
    }
    
    // Мониторинг TP/SL для RSI позиций
    setInterval(() => {
      if (rsiOpenPositions.length > 0) {
        rsiOpenPositions.forEach((position, index) => {
          const currentPrice = rsiLastPrices[position.symbol];
          if (currentPrice) {
            position.currentPrice = currentPrice;
            
            // Проверка TP/SL
            if (position.direction === 'LONG' && currentPrice >= position.tpPrice) {
              closeRSIPosition(position.id, position.tpPrice, 'Take Profit');
            } else if (position.direction === 'LONG' && currentPrice <= position.slPrice) {
              closeRSIPosition(position.id, position.slPrice, 'Stop Loss');
            } else if (position.direction === 'SHORT' && currentPrice <= position.tpPrice) {
              closeRSIPosition(position.id, position.tpPrice, 'Take Profit');
            } else if (position.direction === 'SHORT' && currentPrice >= position.slPrice) {
              closeRSIPosition(position.id, position.slPrice, 'Stop Loss');
            }
          }
        });
      }
    }, 100);
    
  </script>
</body>
</html>
